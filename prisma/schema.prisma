generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vehicle {
  id                   String           @id @default(uuid())
  externalId           String?          @unique
  marca                String
  modelo               String
  versao               String?
  ano                  Int
  km                   Int
  preco                Float?
  cor                  String?
  carroceria           String
  combustivel          String           @default("Flex")
  cambio               String           @default("Manual")
  arCondicionado       Boolean          @default(false)
  direcaoHidraulica    Boolean          @default(false)
  airbag               Boolean          @default(false)
  abs                  Boolean          @default(false)
  vidroEletrico        Boolean          @default(false)
  travaEletrica        Boolean          @default(false)
  alarme               Boolean          @default(false)
  rodaLigaLeve         Boolean          @default(false)
  som                  Boolean          @default(false)
  portas               Int              @default(4)
  opcionais            String?
  fotoUrl              String?
  fotosUrls            String           @default("")
  url                  String?
  detailUrl            String?
  descricao            String?
  embedding            String?
  embeddingModel       String?          @default("text-embedding-3-small")
  embeddingGeneratedAt DateTime?
  disponivel           Boolean          @default(true)
  aptoUber             Boolean          @default(false)
  aptoUberBlack        Boolean          @default(false)
  aptoFamilia          Boolean          @default(true)
  aptoTrabalho         Boolean          @default(true) // Legacy: Generic "Work"
  aptoCarga            Boolean          @default(false) // Work: Heavy Duty / Cargo (Pickup, Van)
  aptoUsoDiario        Boolean          @default(false) // Work: Commute / Daily Use (Economy + AC)
  aptoEntrega          Boolean          @default(false) // Work: Delivery Apps (Mercado Livre, Lalamove)
  economiaCombustivel  String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  recommendations      Recommendation[]
}

model Conversation {
  id              String           @id @default(uuid())
  phoneNumber     String
  customerName    String?
  status          String           @default("active")
  currentStep     String           @default("greeting")
  quizAnswers     String?
  profileData     String?
  startedAt       DateTime         @default(now())
  lastMessageAt   DateTime         @default(now())
  closedAt        DateTime?
  events          Event[]
  lead            Lead?
  messages        Message[]
  recommendations Recommendation[]
}

model Event {
  id             String       @id @default(uuid())
  conversationId String
  eventType      String
  metadata       String?
  timestamp      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([eventType])
  @@index([timestamp])
}

model Recommendation {
  id             String       @id @default(uuid())
  conversationId String
  vehicleId      String
  matchScore     Int
  reasoning      String
  position       Int          @default(1)
  clicked        Boolean      @default(false)
  interested     Boolean      @default(false)
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  vehicle        Vehicle      @relation(fields: [vehicleId], references: [id])

  @@index([conversationId])
  @@index([matchScore])
}

model Lead {
  id                 String       @id @default(uuid())
  conversationId     String       @unique
  name               String
  phone              String
  email              String?
  budget             Float?
  usage              String?
  people             Int?
  hasTradeIn         Boolean      @default(false)
  tradeInInfo        String?
  interestedVehicles String?
  urgency            String?
  status             String       @default("new")
  source             String       @default("whatsapp_bot")
  soldAt             DateTime?
  soldVehicleId      String?
  saleValue          Float?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  crmSynced          Boolean      @default(false)
  crmId              String?
  conversation       Conversation @relation(fields: [conversationId], references: [id])

  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

model Message {
  id              String       @id @default(uuid())
  conversationId  String
  direction       String
  content         String
  messageType     String       @default("text")
  waMessageId     String?
  originalMediaId String?
  timestamp       DateTime     @default(now())
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
}

model LangGraphCheckpoint {
  thread_id            String
  checkpoint_ns        String   @default("")
  checkpoint_id        String
  parent_checkpoint_id String?
  type                 String?
  checkpoint           Json
  metadata             Json     @default("{}")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@id([thread_id, checkpoint_ns, checkpoint_id])
}

model LangGraphCheckpointBlob {
  thread_id     String
  checkpoint_ns String @default("")
  content       Json

  @@id([thread_id, checkpoint_ns])
}

model system_prompts {
  id          String   @id
  key         String   @unique
  content     String
  description String?
  version     Int      @default(1)
  updatedAt   DateTime
  createdAt   DateTime @default(now())
}

model UberEligibleVehicleRule {
  id        String   @id @default(uuid())
  citySlug  String
  category  String
  brand     String
  model     String
  minYear   Int
  raw       String
  fetchedAt DateTime
  sourceUrl String
  createdAt DateTime @default(now())

  @@index([citySlug])
  @@index([category])
  @@index([brand])
  @@index([model])
  @@index([fetchedAt])
  @@unique([citySlug, category, brand, model, minYear])
}

var gc=Object.create;var Bt=Object.defineProperty;var hc=Object.getOwnPropertyDescriptor;var mc=Object.getOwnPropertyNames;var yc=Object.getPrototypeOf,fc=Object.prototype.hasOwnProperty;var wc=(p,i)=>{for(var e in i)Bt(p,e,{get:i[e],enumerable:!0})},to=(p,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of mc(i))!fc.call(p,s)&&s!==e&&Bt(p,s,{get:()=>i[s],enumerable:!(t=hc(i,s))||t.enumerable});return p};var v=(p,i,e)=>(e=p!=null?gc(yc(p)):{},to(i||!p||!p.__esModule?Bt(e,"default",{value:p,enumerable:!0}):e,p)),bc=p=>to(Bt({},"__esModule",{value:!0}),p);var sp={};wc(sp,{InstanceController:()=>Pt});module.exports=bc(sp);var no=v(require("dayjs")),oo=v(require("fs"));var cn=require("class-validator"),so=v(require("dotenv"));so.default.config();var Pe=class{constructor(){this.loadEnv()}get(i){return this.env[i]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN.split(",")||["*"],METHODS:process.env.CORS_METHODS.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||""},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true"},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:(0,cn.isBooleanString)(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:(0,cn.isBooleanString)(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome",VERSION:process.env?.CONFIG_SESSION_PHONE_VERSION||null},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"}}}},M=new Pe;var Sc=JSON.parse(oo.default.readFileSync("./package.json","utf8")),io=p=>(0,no.default)(p).toDate().toString().replace(/\sGMT.+/,""),Ce=(r=>(r.LOG="\x1B[32m",r.INFO="\x1B[34m",r.WARN="\x1B[33m",r.ERROR="\x1B[31m",r.DEBUG="\x1B[36m",r.VERBOSE="\x1B[37m",r.DARK="\x1B[30m",r))(Ce||{});var ro=(r=>(r.LOG="\x1B[32m%s\x1B[0m",r.DARK="\x1B[30m%s\x1B[0m",r.INFO="\x1B[34m%s\x1B[0m",r.WARN="\x1B[33m%s\x1B[0m",r.ERROR="\x1B[31m%s\x1B[0m",r.DEBUG="\x1B[36m%s\x1B[0m",r.VERBOSE="\x1B[37m%s\x1B[0m",r))(ro||{}),ao=(r=>(r.LOG="LOG",r.WARN="WARN",r.INFO="INFO",r.DARK="DARK",r.ERROR="ERROR",r.DEBUG="DEBUG",r.VERBOSE="VERBOSE",r))(ao||{}),co=(r=>(r.LOG="\x1B[42m",r.INFO="\x1B[44m",r.WARN="\x1B[43m",r.DARK="\x1B[40m",r.ERROR="\x1B[41m",r.DEBUG="\x1B[46m",r.VERBOSE="\x1B[47m",r))(co||{}),E=class{constructor(i="Logger"){this.configService=M;this.instance=null;this.context=i}setContext(i){this.context=i}setInstance(i){this.instance=i}console(i,e){let t=[];this.configService.get("LOG").LEVEL.forEach(o=>t.push(ao[o]));let s=typeof i;t.includes(e)&&(M.get("LOG").COLOR?(console.log("\x1B[1m"+ro[e],"[Evolution API]","\x1B[1m"+Ce[e],this.instance?`[${this.instance}]`:"","\x1B[1m"+Ce[e],`v${Sc.version}`,"\x1B[1m"+Ce[e],process.pid.toString(),"\x1B[0m","\x1B[1m"+Ce[e],"-","\x1B[1m\x1B[37m",`${io(Date.now())}  `,"\x1B[0m",Ce[e]+co[e]+"\x1B[1m",`${e} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,Ce[e]+"\x1B[1m",`[${s}]\x1B[0m`,Ce[e],s!=="object"?i:"","\x1B[0m"),s==="object"&&console.log(i,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${io(Date.now())}  `,`${e} `,`[${this.context}]`,`[${s}]`,i))}log(i){this.console(i,"LOG")}info(i){this.console(i,"INFO")}warn(i){this.console(i,"WARN")}error(i){this.console(i,"ERROR")}verbose(i){this.console(i,"VERBOSE")}debug(i){this.console(i,"DEBUG")}dark(i){this.console(i,"DARK")}};var po=v(require("node-cache")),we=class we{constructor(i,e){this.configService=i;this.module=e;this.conf=this.configService.get("CACHE")?.LOCAL}async get(i){return we.localCache.get(this.buildKey(i))}async set(i,e,t){return we.localCache.set(this.buildKey(i),e,t||this.conf.TTL)}async has(i){return we.localCache.has(this.buildKey(i))}async delete(i){return we.localCache.del(this.buildKey(i))}async deleteAll(i){let e=await this.keys(i);return e?.length?we.localCache.del(e):0}async keys(i){let e=`${this.buildKey("")}${i?`${i}:`:""}`;return we.localCache.keys().filter(t=>t.substring(0,e.length)===e)}buildKey(i){return`${this.module}:${i}`}async hGet(){console.log("hGet not implemented")}async hSet(){console.log("hSet not implemented")}async hDelete(){return console.log("hDelete not implemented"),0}};we.localCache=new po.default;var Ft=we;var ln=require("baileys");var lo=require("redis"),pn=class{constructor(){this.logger=new E("Redis");this.client=null;this.connected=!1;this.conf=M.get("CACHE")?.REDIS}getConnection(){if(this.connected)return this.client;this.client=(0,lo.createClient)({url:this.conf.URI}),this.client.on("connect",()=>{this.logger.verbose("redis connecting")}),this.client.on("ready",()=>{this.logger.verbose("redis ready"),this.connected=!0}),this.client.on("error",()=>{this.logger.error("redis disconnected"),this.connected=!1}),this.client.on("end",()=>{this.logger.verbose("redis connection ended"),this.connected=!1});try{this.client.connect(),this.connected=!0}catch(i){return this.connected=!1,this.logger.error("redis connect exception caught: "+i),null}return this.client}},uo=new pn;var Lt=class{constructor(i,e){this.configService=i;this.module=e;this.logger=new E("RedisCache");this.conf=this.configService.get("CACHE")?.REDIS,this.client=uo.getConnection()}async get(i){try{return JSON.parse(await this.client.get(this.buildKey(i)))}catch(e){this.logger.error(e)}}async hGet(i,e){try{let t=await this.client.hGet(this.buildKey(i),e);return t?JSON.parse(t,ln.BufferJSON.reviver):null}catch(t){this.logger.error(t)}}async set(i,e,t){try{await this.client.setEx(this.buildKey(i),t||this.conf?.TTL,JSON.stringify(e))}catch(s){this.logger.error(s)}}async hSet(i,e,t){try{let s=JSON.stringify(t,ln.BufferJSON.replacer);await this.client.hSet(this.buildKey(i),e,s)}catch(s){this.logger.error(s)}}async has(i){try{return await this.client.exists(this.buildKey(i))>0}catch(e){this.logger.error(e)}}async delete(i){try{return await this.client.del(this.buildKey(i))}catch(e){this.logger.error(e)}}async hDelete(i,e){try{return await this.client.hDel(this.buildKey(i),e)}catch(t){this.logger.error(t)}}async deleteAll(i){try{let e=await this.keys(i);return e?.length?await this.client.del(e):0}catch(e){this.logger.error(e)}}async keys(i){try{let e=`${this.buildKey("")}${i?`${i}:`:""}*`,t=[];for await(let s of this.client.scanIterator({MATCH:e,COUNT:100}))t.push(s);return[...new Set(t)]}catch(e){this.logger.error(e)}}buildKey(i){return`${this.conf?.PREFIX_KEY}:${this.module}:${i}`}};var go=new E("CacheEngine"),ge=class{constructor(i,e){this.configService=i;let t=i.get("CACHE");t?.REDIS?.ENABLED&&t?.REDIS?.URI!==""?(go.verbose(`RedisCache initialized for ${e}`),this.engine=new Lt(i,e)):t?.LOCAL?.ENABLED&&(go.verbose(`LocalCache initialized for ${e}`),this.engine=new Ft(i,e))}getEngine(){return this.engine}};var ho=v(require("eventemitter2")),un=new ho.default({delimiter:".",newListener:!1,ignoreErrors:!1,maxListeners:50});var Ut=class{constructor(i){this.waMonitor=i}async whatsappNumber({instanceName:i},e){return await this.waMonitor.waInstances[i].whatsappNumber(e)}async readMessage({instanceName:i},e){return await this.waMonitor.waInstances[i].markMessageAsRead(e)}async archiveChat({instanceName:i},e){return await this.waMonitor.waInstances[i].archiveChat(e)}async markChatUnread({instanceName:i},e){return await this.waMonitor.waInstances[i].markChatUnread(e)}async deleteMessage({instanceName:i},e){return await this.waMonitor.waInstances[i].deleteMessage(e)}async fetchProfilePicture({instanceName:i},e){return await this.waMonitor.waInstances[i].profilePicture(e.number)}async fetchProfile({instanceName:i},e){return await this.waMonitor.waInstances[i].fetchProfile(i,e.number)}async fetchContacts({instanceName:i},e){return await this.waMonitor.waInstances[i].fetchContacts(e)}async getBase64FromMediaMessage({instanceName:i},e){return await this.waMonitor.waInstances[i].getBase64FromMediaMessage(e)}async fetchMessages({instanceName:i},e){return await this.waMonitor.waInstances[i].fetchMessages(e)}async fetchStatusMessage({instanceName:i},e){return await this.waMonitor.waInstances[i].fetchStatusMessage(e)}async fetchChats({instanceName:i},e){return await this.waMonitor.waInstances[i].fetchChats(e)}async sendPresence({instanceName:i},e){return await this.waMonitor.waInstances[i].sendPresence(e)}async fetchPrivacySettings({instanceName:i}){return await this.waMonitor.waInstances[i].fetchPrivacySettings()}async updatePrivacySettings({instanceName:i},e){return await this.waMonitor.waInstances[i].updatePrivacySettings(e)}async fetchBusinessProfile({instanceName:i},e){return await this.waMonitor.waInstances[i].fetchBusinessProfile(e.number)}async updateProfileName({instanceName:i},e){return await this.waMonitor.waInstances[i].updateProfileName(e.name)}async updateProfileStatus({instanceName:i},e){return await this.waMonitor.waInstances[i].updateProfileStatus(e.status)}async updateProfilePicture({instanceName:i},e){return await this.waMonitor.waInstances[i].updateProfilePicture(e.picture)}async removeProfilePicture({instanceName:i}){return await this.waMonitor.waInstances[i].removeProfilePicture()}async updateMessage({instanceName:i},e){return await this.waMonitor.waInstances[i].updateMessage(e)}async blockUser({instanceName:i},e){return await this.waMonitor.waInstances[i].blockUser(e)}};var Jt=class{constructor(i){this.waMonitor=i}async createGroup(i,e){return await this.waMonitor.waInstances[i.instanceName].createGroup(e)}async updateGroupPicture(i,e){return await this.waMonitor.waInstances[i.instanceName].updateGroupPicture(e)}async updateGroupSubject(i,e){return await this.waMonitor.waInstances[i.instanceName].updateGroupSubject(e)}async updateGroupDescription(i,e){return await this.waMonitor.waInstances[i.instanceName].updateGroupDescription(e)}async findGroupInfo(i,e){return await this.waMonitor.waInstances[i.instanceName].findGroup(e)}async fetchAllGroups(i,e){return await this.waMonitor.waInstances[i.instanceName].fetchAllGroups(e)}async inviteCode(i,e){return await this.waMonitor.waInstances[i.instanceName].inviteCode(e)}async inviteInfo(i,e){return await this.waMonitor.waInstances[i.instanceName].inviteInfo(e)}async sendInvite(i,e){return await this.waMonitor.waInstances[i.instanceName].sendInvite(e)}async acceptInviteCode(i,e){return await this.waMonitor.waInstances[i.instanceName].acceptInviteCode(e)}async revokeInviteCode(i,e){return await this.waMonitor.waInstances[i.instanceName].revokeInviteCode(e)}async findParticipants(i,e){return await this.waMonitor.waInstances[i.instanceName].findParticipants(e)}async updateGParticipate(i,e){return await this.waMonitor.waInstances[i.instanceName].updateGParticipant(e)}async updateGSetting(i,e){return await this.waMonitor.waInstances[i.instanceName].updateGSetting(e)}async toggleEphemeral(i,e){return await this.waMonitor.waInstances[i.instanceName].toggleEphemeral(e)}async leaveGroup(i,e){return await this.waMonitor.waInstances[i.instanceName].leaveGroup(e)}};var Wt=class{constructor(i){this.waMonitor=i}async fetchLabels({instanceName:i}){return await this.waMonitor.waInstances[i].fetchLabels()}async handleLabel({instanceName:i},e){return await this.waMonitor.waInstances[i].handleLabel(e)}};var Ec=new E("GUARD");async function Ic(p,i,e){let t=M.get("AUTHENTICATION").API_KEY,s=p.get("apikey"),o=M.get("DATABASE");if(!s)throw new _e;if(t.KEY===s)return e();if((p.originalUrl.includes("/instance/create")||p.originalUrl.includes("/instance/fetchInstances"))&&!s)throw new He("Missing global api key","The global api key must be set");let n=p.params;try{if(n?.instanceName){if((await F.instance.findUnique({where:{name:n.instanceName}})).token===s)return e()}else if(p.originalUrl.includes("/instance/fetchInstances")&&o.SAVE_DATA.INSTANCE&&await F.instance.findFirst({where:{token:s}}))return e()}catch(r){Ec.error(r)}throw new _e}var dn={apikey:Ic};var yo=require("@prisma/client"),mo=new E("Prisma"),qt=(()=>{mo.verbose("connecting");let p=new yo.PrismaClient;return process.on("beforeExit",()=>{mo.verbose("instance destroyed"),p.$disconnect()}),p})();async function fo(p){try{let i=M.get("CACHE"),e=!!x.waInstances[p];if(i.REDIS.ENABLED&&i.REDIS.SAVE_INSTANCES){let s=await $t.has(p);return e||s}return e||(await qt.instance.findMany({where:{name:p}})).length>0}catch(i){throw new N(i?.toString())}}async function wo(p,i,e){if(p.originalUrl.includes("/instance/create")||p.originalUrl.includes("/instance/fetchInstances"))return e();let t=p.params;if(!t?.instanceName)throw new m('"instanceName" not provided.');if(!await fo(t.instanceName))throw new _(`The "${t.instanceName}" instance does not exist`);e()}async function bo(p,i,e){if(p.originalUrl.includes("/instance/create")){let t=p.body;if(await fo(t.instanceName))throw new He(`This name "${t.instanceName}" is already in use.`);x.waInstances[t.instanceName]&&delete x.waInstances[t.instanceName]}e()}var So=v(require("axios")),Eo=v(require("fs")),Mc=JSON.parse(Eo.default.readFileSync("./package.json","utf8")),B=async p=>{if(!(process.env.TELEMETRY_ENABLED===void 0||process.env.TELEMETRY_ENABLED==="true")||p==="/")return;let e={route:p,apiVersion:`${Mc.version}`,timestamp:new Date},t=process.env.TELEMETRY_URL&&process.env.TELEMETRY_URL!==""?process.env.TELEMETRY_URL:"https://log.evolution-api.com/telemetry";So.default.post(t,e).then(()=>{}).catch(()=>{})};var gn=class{collectTelemetry(i,e,t){B(i.path),t()}},Io=gn;var Ao=require("express");var Vp=require("express-async-errors");var je=require("jsonschema"),ot=new E("Validate"),O=class{constructor(){}routerPath(i,e=!0){let t="/"+i;return e&&(t+="/:instanceName"),t}async dataValidate(i){let{request:e,schema:t,ClassRef:s,execute:o}=i,n=new s,r=e.body,a=e.params;e?.query&&Object.keys(e.query).length>0&&Object.assign(a,e.query),e.originalUrl.includes("/instance/create")&&Object.assign(a,r),Object.assign(n,r);let c=t?(0,je.validate)(n,t):{valid:!0,errors:[]};if(!c.valid){let u=c.errors.map(({stack:d,schema:l})=>{let g;return l.description?g=l.description:g=d.replace("instance.",""),g});throw ot.error(u),new m(u)}return await o(a,n)}async groupNoValidate(i){let{request:e,ClassRef:t,schema:s,execute:o}=i,n=e.params,r=new t;Object.assign(r,e.body);let a=(0,je.validate)(r,s);if(!a.valid){let c=a.errors.map(({property:u,stack:d,schema:l})=>{let g;return l.description?g=l.description:g=d.replace("instance.",""),{property:u.replace("instance.",""),message:g}});throw ot.error([...c]),new m(...c)}return await o(n,r)}async groupValidate(i){let{request:e,ClassRef:t,schema:s,execute:o}=i,n=e.params,r=e.body,a=r?.groupJid;if(!a)if(e.query?.groupJid)a=e.query.groupJid;else throw new m("The group id needs to be informed in the query",'ex: "groupJid=120362@g.us"');a.endsWith("@g.us")||(a=a+"@g.us"),Object.assign(r,{groupJid:a});let c=new t;Object.assign(c,r);let u=(0,je.validate)(c,s);if(!u.valid){let d=u.errors.map(({property:l,stack:g,schema:h})=>{let y;return h.description?y=h.description:y=g.replace("instance.",""),{property:l.replace("instance.",""),message:y}});throw ot.error([...d]),new m(...d)}return await o(n,c)}async inviteCodeValidate(i){let{request:e,ClassRef:t,schema:s,execute:o}=i,n=e.query;if(!n?.inviteCode)throw new m("The group invite code id needs to be informed in the query",'ex: "inviteCode=F1EX5QZxO181L3TMVP31gY" (Obtained from group join link)');let r=e.params,a=e.body,c=new t;Object.assign(a,n),Object.assign(c,a);let u=(0,je.validate)(c,s);if(!u.valid){let d=u.errors.map(({property:l,stack:g,schema:h})=>{let y;return h.description?y=h.description:y=g.replace("instance.",""),{property:l.replace("instance.",""),message:y}});throw ot.error([...d]),new m(...d)}return await o(r,c)}async getParticipantsValidate(i){let{request:e,ClassRef:t,schema:s,execute:o}=i,n=e.query;if(!n?.getParticipants)throw new m("The getParticipants needs to be informed in the query");let r=e.params,a=e.body,c=new t;Object.assign(a,n),Object.assign(c,a);let u=(0,je.validate)(c,s);if(!u.valid){let d=u.errors.map(({property:l,stack:g,schema:h})=>{let y;return h.description?y=h.description:y=g.replace("instance.",""),{property:l.replace("instance.",""),message:y}});throw ot.error([...d]),new m(...d)}return await o(r,c)}};var Mo=require("express"),Vt=class extends O{constructor(e){super();this.configService=e;this.router=(0,Mo.Router)();this.router.post(this.routerPath("webhook/evolution",!1),async(t,s)=>{let{body:o}=t,n=await To.receiveWebhook(o);return s.status(200).json(n)})}};var Co=require("express"),Gt=class extends O{constructor(e){super();this.configService=e;this.router=(0,Co.Router)();this.router.get(this.routerPath("webhook/meta",!1),async(t,s)=>{t.query["hub.verify_token"]===e.get("WA_BUSINESS").TOKEN_WEBHOOK?s.send(t.query["hub.challenge"]):s.send("Error, wrong validation token")}).post(this.routerPath("webhook/meta",!1),async(t,s)=>{let{body:o}=t,n=await vo.receiveWebhook(o);return s.status(200).json(n)})}};var Ht=class{constructor(i){this.router=(0,Ao.Router)(),this.router.use("/",new Vt(i).router),this.router.use("/",new Gt(i).router)}};var jt=class{};function Ro(p){return class extends p{}}var he=class{};function Oo(p){return class extends p{}}var Kt=class extends Oo(Ro(class{})){};var T=class extends Kt{},Yt=class{};var V=require("uuid"),H=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},Tc={type:"string",description:"Invalid format"},xo={$id:(0,V.v4)(),type:"object",properties:{numbers:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",description:'"numbers" must be an array of numeric strings'}}}},Do={$id:(0,V.v4)(),type:"object",properties:{readMessages:{type:"array",minItems:1,uniqueItems:!0,items:{properties:{id:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]},remoteJid:{type:"string"}},required:["id","fromMe","remoteJid"],...H("id","remoteJid")}}},required:["readMessages"]},No={$id:(0,V.v4)(),type:"object",properties:{chat:{type:"string"},lastMessage:{type:"object",properties:{key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id","fromMe","remoteJid"],...H("id","remoteJid")},messageTimestamp:{type:"integer",minLength:1}},required:["key"],...H("messageTimestamp")},archive:{type:"boolean",enum:[!0,!1]}},required:["archive"]},ko={$id:(0,V.v4)(),type:"object",properties:{chat:{type:"string"},lastMessage:{type:"object",properties:{key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id","fromMe","remoteJid"],...H("id","remoteJid")},messageTimestamp:{type:"integer",minLength:1}},required:["key"],...H("messageTimestamp")}},required:["lastMessage"]},Po={$id:(0,V.v4)(),type:"object",properties:{id:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]},remoteJid:{type:"string"},participant:{type:"string"}},required:["id","fromMe","remoteJid"],...H("id","remoteJid","participant")},rt={$id:(0,V.v4)(),type:"object",properties:{number:{type:"string"},picture:{type:"string"}}},_o={$id:(0,V.v4)(),type:"object",properties:{number:{type:"string"},text:{type:"string"},key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id","fromMe","remoteJid"],...H("id","remoteJid")}},...H("number","text","key")},Bo={$id:(0,V.v4)(),type:"object",properties:{number:{...Tc},delay:{type:"number"},presence:{type:"string",enum:["unavailable","available","composing","recording","paused"]}},required:["number","presence","delay"]},Fo={$id:(0,V.v4)(),type:"object",properties:{number:{type:"string"},status:{type:"string",enum:["block","unblock"]}},required:["number","status"],...H("number","status")},hn={$id:(0,V.v4)(),type:"object",properties:{where:{type:"object",properties:{_id:{type:"string",minLength:1},pushName:{type:"string",minLength:1},id:{type:"string",minLength:1}},...H("_id","id","pushName")}}},Lo={$id:(0,V.v4)(),type:"object",properties:{where:{type:"object",properties:{_id:{type:"string",minLength:1},key:{type:"object",if:{propertyNames:{enum:["fromMe","remoteJid","id"]}},then:{properties:{remoteJid:{type:"string",minLength:1,description:"The property cannot be empty"},id:{type:"string",minLength:1,description:"The property cannot be empty"},fromMe:{type:"boolean",enum:[!0,!1]}}}},message:{type:"object"}},...H("_id")},limit:{type:"integer"}}},Uo={$id:(0,V.v4)(),type:"object",properties:{where:{type:"object",properties:{_id:{type:"string"},remoteJid:{type:"string"},id:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]},participant:{type:"string"},status:{type:"string",enum:["ERROR","PENDING","SERVER_ACK","DELIVERY_ACK","READ","PLAYED"]}},...H("_id","remoteJid","id","status")},limit:{type:"integer"}}},Jo={$id:(0,V.v4)(),type:"object",properties:{readreceipts:{type:"string",enum:["all","none"]},profile:{type:"string",enum:["all","contacts","contact_blacklist","none"]},status:{type:"string",enum:["all","contacts","contact_blacklist","none"]},online:{type:"string",enum:["all","match_last_seen"]},last:{type:"string",enum:["all","contacts","contact_blacklist","none"]},groupadd:{type:"string",enum:["all","contacts","contact_blacklist","none"]}},required:["readreceipts","profile","status","online","last","groupadd"],...H("readreceipts","profile","status","online","last","groupadd")},Wo={$id:(0,V.v4)(),type:"object",properties:{name:{type:"string"}},...H("name")},qo={$id:(0,V.v4)(),type:"object",properties:{status:{type:"string"}},...H("status")},$o={type:"object",properties:{wuid:{type:"string"},name:{type:"string"},picture:{type:"string"},status:{type:"string"},isBusiness:{type:"boolean"}}};var Q=require("uuid"),se=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},Vo={$id:(0,Q.v4)(),type:"object",properties:{subject:{type:"string"},description:{type:"string"},profilePicture:{type:"string"},promoteParticipants:{type:"boolean",enum:[!0,!1]},participants:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",minLength:10,pattern:"\\d+",description:'"participants" must be an array of numeric strings'}}},required:["subject","participants"],...se("subject","description","profilePicture")},at={$id:(0,Q.v4)(),type:"object",properties:{groupJid:{type:"string",pattern:"^[\\d-]+@g.us$"}},required:["groupJid"],...se("groupJid")},Go={$id:(0,Q.v4)(),type:"object",properties:{getParticipants:{type:"string",enum:["true","false"]}},required:["getParticipants"],...se("getParticipants")},Ho={$id:(0,Q.v4)(),type:"object",properties:{groupJid:{type:"string"},description:{type:"string"},numbers:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",minLength:10,pattern:"\\d+",description:'"numbers" must be an array of numeric strings'}}},required:["groupJid","description","numbers"],...se("groupJid","description","numbers")},jo={$id:(0,Q.v4)(),type:"object",properties:{inviteCode:{type:"string",pattern:"^[a-zA-Z0-9]{22}$"}},required:["inviteCode"],...se("inviteCode")},Ko={$id:(0,Q.v4)(),type:"object",properties:{inviteCode:{type:"string",pattern:"^[a-zA-Z0-9]{22}$"}},required:["inviteCode"],...se("inviteCode")},Yo={$id:(0,Q.v4)(),type:"object",properties:{groupJid:{type:"string"},action:{type:"string",enum:["add","remove","promote","demote"]},participants:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",minLength:10,pattern:"\\d+",description:'"participants" must be an array of numeric strings'}}},required:["groupJid","action","participants"],...se("groupJid","action")},Qo={$id:(0,Q.v4)(),type:"object",properties:{groupJid:{type:"string"},action:{type:"string",enum:["announcement","not_announcement","locked","unlocked"]}},required:["groupJid","action"],...se("groupJid","action")},zo={$id:(0,Q.v4)(),type:"object",properties:{groupJid:{type:"string"},expiration:{type:"number",enum:[0,86400,604800,7776e3]}},required:["groupJid","expiration"],...se("groupJid","expiration")},Xo={$id:(0,Q.v4)(),type:"object",properties:{groupJid:{type:"string"},image:{type:"string"}},required:["groupJid","image"],...se("groupJid","image")},Zo={$id:(0,Q.v4)(),type:"object",properties:{groupJid:{type:"string"},subject:{type:"string"}},required:["groupJid","subject"],...se("groupJid","subject")},er={$id:(0,Q.v4)(),type:"object",properties:{groupJid:{type:"string"},description:{type:"string"}},required:["groupJid","description"],...se("groupJid","description")};var tr=["imageMessage","documentMessage","audioMessage","videoMessage","stickerMessage"],sr=["ephemeralMessage","documentWithCaptionMessage","viewOnceMessage","viewOnceMessageV2"],D={WHATSAPP_BUSINESS:"WHATSAPP-BUSINESS",WHATSAPP_BAILEYS:"WHATSAPP-BAILEYS",EVOLUTION:"EVOLUTION"};var mn=require("uuid"),Cc=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},R={$id:(0,mn.v4)(),type:"object",properties:{instanceName:{type:"string"},token:{type:"string"},number:{type:"string",pattern:"^\\d+[\\.@\\w-]+"},businessId:{type:"string"},qrcode:{type:"boolean"},Integration:{type:"string",enum:Object.values(D)},rejectCall:{type:"boolean"},msgCall:{type:"string"},groupsIgnore:{type:"boolean"},alwaysOnline:{type:"boolean"},readMessages:{type:"boolean"},readStatus:{type:"boolean"},syncFullHistory:{type:"boolean"},proxyHost:{type:"string"},proxyPort:{type:"string"},proxyProtocol:{type:"string"},proxyUsername:{type:"string"},proxyPassword:{type:"string"},webhookUrl:{type:"string"},webhookByEvents:{type:"boolean"},webhookBase64:{type:"boolean"},webhookEvents:{type:"array",minItems:0,items:{type:"string",enum:["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS"]}},rabbitmqEnabled:{type:"boolean"},rabbitmqEvents:{type:"array",minItems:0,items:{type:"string",enum:["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS"]}},sqsEnabled:{type:"boolean"},sqsEvents:{type:"array",minItems:0,items:{type:"string",enum:["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS"]}},chatwootAccountId:{type:"string"},chatwootToken:{type:"string"},chatwootUrl:{type:"string"},chatwootSignMsg:{type:"boolean"},chatwootReopenConversation:{type:"boolean"},chatwootConversationPending:{type:"boolean"},chatwootImportContacts:{type:"boolean"},chatwootNameInbox:{type:"string"},chatwootMergeBrazilContacts:{type:"boolean"},chatwootImportMessages:{type:"boolean"},chatwootDaysLimitImportMessages:{type:"number"}},...Cc("instanceName")},ir={$id:(0,mn.v4)(),type:"object",properties:{presence:{type:"string",enum:["unavailable","available","composing","recording","paused"]}},required:["presence"]};var nr=require("uuid"),vc=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},Ac={type:"string",description:"Invalid format"},or={$id:(0,nr.v4)(),type:"object",properties:{number:{...Ac},labelId:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["number","labelId","action"],...vc("number","labelId","action")};var z=require("uuid"),Ke=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},me={type:"string",description:"Invalid format"},rr={$id:(0,z.v4)(),type:"object",properties:{number:{...me},name:{type:"string"},language:{type:"string"},components:{type:"array"},webhookUrl:{type:"string"}},required:["name","language"]},ve={properties:{key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id"],...Ke("id")},message:{type:"object"}}},ar={$id:(0,z.v4)(),type:"object",properties:{number:{...me},text:{type:"string"},linkPreview:{type:"boolean"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...ve},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","text"]},cr={$id:(0,z.v4)(),type:"object",properties:{number:{...me},mediatype:{type:"string",enum:["image","document","video","audio"]},mimetype:{type:"string"},media:{type:"string"},fileName:{type:"string"},caption:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...ve},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","mediatype","media"]},pr={$id:(0,z.v4)(),type:"object",properties:{number:{...me},audio:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...ve},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","audio"]},lr={$id:(0,z.v4)(),type:"object",properties:{type:{type:"string",enum:["text","image","audio","video"]},content:{type:"string"},caption:{type:"string"},backgroundColor:{type:"string"},font:{type:"integer",minimum:0,maximum:5},statusJidList:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"statusJidList" must be an array of numeric strings'}},allContacts:{type:"boolean",enum:[!0,!1]}},required:["type","content"]},ur={$id:(0,z.v4)(),type:"object",properties:{number:{...me},sticker:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...ve},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","sticker"]},dr={$id:(0,z.v4)(),type:"object",properties:{number:{...me},latitude:{type:"number"},longitude:{type:"number"},name:{type:"string"},address:{type:"string"},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...ve},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","latitude","longitude","name","address"]},gr={$id:(0,z.v4)(),type:"object",properties:{number:{...me},contact:{type:"array",items:{type:"object",properties:{fullName:{type:"string"},wuid:{type:"string",minLength:10,pattern:"\\d+",description:'"wuid" must be a numeric string'},phoneNumber:{type:"string",minLength:10},organization:{type:"string"},email:{type:"string"},url:{type:"string"}},required:["fullName","phoneNumber"],...Ke("fullName")},minItems:1,uniqueItems:!0}},required:["number","contact"]},hr={$id:(0,z.v4)(),type:"object",properties:{key:{type:"object",properties:{id:{type:"string"},remoteJid:{type:"string"},fromMe:{type:"boolean",enum:[!0,!1]}},required:["id","remoteJid","fromMe"],...Ke("id","remoteJid")},reaction:{type:"string"}},required:["key","reaction"]},mr={$id:(0,z.v4)(),type:"object",properties:{number:{...me},name:{type:"string"},selectableCount:{type:"integer",minimum:0,maximum:10},values:{type:"array",minItems:2,maxItems:10,uniqueItems:!0,items:{type:"string"}},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...ve},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","name","selectableCount","values"]},yr={$id:(0,z.v4)(),type:"object",properties:{number:{...me},title:{type:"string"},description:{type:"string"},footerText:{type:"string"},buttonText:{type:"string"},sections:{type:"array",minItems:1,uniqueItems:!0,items:{type:"object",properties:{title:{type:"string"},rows:{type:"array",minItems:1,uniqueItems:!0,items:{type:"object",properties:{title:{type:"string"},description:{type:"string"},rowId:{type:"string"}},required:["title","rowId"],...Ke("title","description","rowId")}}},required:["title","rows"],...Ke("title")}},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...ve},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","title","footerText","buttonText","sections"]},fr={$id:(0,z.v4)(),type:"object",properties:{number:{...me},title:{type:"string"},description:{type:"string"},footerText:{type:"string"},buttons:{type:"array",minItems:1,uniqueItems:!0,items:{type:"object",properties:{text:{type:"string"},id:{type:"string"}},required:["text","id"],...Ke("text","id")}},media:{type:"string"},fileName:{type:"string"},mediatype:{type:"string",enum:["image","document","video"]},delay:{type:"integer",description:"Enter a value in milliseconds"},quoted:{...ve},everyOne:{type:"boolean",enum:[!0,!1]},mentioned:{type:"array",minItems:1,uniqueItems:!0,items:{type:"string",pattern:"^\\d+",description:'"mentioned" must be an array of numeric strings'}}},required:["number","title","buttons"]};var wr=require("uuid"),Rc=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},br={$id:(0,wr.v4)(),type:"object",properties:{enabled:{type:"boolean",enum:[!0,!1]},host:{type:"string"},port:{type:"string"},protocol:{type:"string"},username:{type:"string"},password:{type:"string"}},required:["enabled","host","port","protocol"],...Rc("enabled","host","port","protocol")};var Sr=require("uuid"),Oc=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},Er={$id:(0,Sr.v4)(),type:"object",properties:{rejectCall:{type:"boolean"},msgCall:{type:"string"},groupsIgnore:{type:"boolean"},alwaysOnline:{type:"boolean"},readMessages:{type:"boolean"},readStatus:{type:"boolean"},syncFullHistory:{type:"boolean"}},required:["rejectCall","groupsIgnore","alwaysOnline","readMessages","readStatus","syncFullHistory"],...Oc("rejectCall","groupsIgnore","alwaysOnline","readMessages","readStatus","syncFullHistory")};var Ir=require("uuid"),xc=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},Mr={$id:(0,Ir.v4)(),type:"object",properties:{name:{type:"string"},category:{type:"string",enum:["AUTHENTICATION","MARKETING","UTILITY"]},allowCategoryChange:{type:"boolean"},language:{type:"string"},components:{type:"array"},webhookUrl:{type:"string"}},required:["name","category","language","components"],...xc("name","category","language","components")};var Tr=require("uuid"),Dc=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},Cr={$id:(0,Tr.v4)(),type:"object",properties:{enabled:{type:"boolean",enum:[!0,!1]},accountId:{type:"string"},token:{type:"string"},url:{type:"string"},signMsg:{type:"boolean",enum:[!0,!1]},signDelimiter:{type:["string","null"]},nameInbox:{type:["string","null"]},reopenConversation:{type:"boolean",enum:[!0,!1]},conversationPending:{type:"boolean",enum:[!0,!1]},autoCreate:{type:"boolean",enum:[!0,!1]},importContacts:{type:"boolean",enum:[!0,!1]},mergeBrazilContacts:{type:"boolean",enum:[!0,!1]},importMessages:{type:"boolean",enum:[!0,!1]},daysLimitImportMessages:{type:"number"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","accountId","token","url","signMsg","reopenConversation","conversationPending"],...Dc("enabled","accountId","token","url","signMsg","reopenConversation","conversationPending")};var ct=require("uuid"),Qt=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},yn={$id:(0,ct.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},botType:{type:"string",enum:["chatBot","textGenerator","agent","workflow"]},apiUrl:{type:"string"},apiKey:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","botType","triggerType"],...Qt("enabled","botType","triggerType")},vr={$id:(0,ct.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...Qt("remoteJid","status")},Ar={$id:(0,ct.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},difyIdFallback:{type:"string"}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids"],...Qt("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids")},Rr={$id:(0,ct.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...Qt("remoteJid","action")};var pt=require("uuid"),zt=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},fn={$id:(0,pt.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},apiUrl:{type:"string"},apiKey:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","apiUrl","triggerType"],...zt("enabled","apiUrl","triggerType")},Or={$id:(0,pt.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...zt("remoteJid","status")},xr={$id:(0,pt.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},botIdFallback:{type:"string"}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids"],...zt("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids")},Dr={$id:(0,pt.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...zt("remoteJid","action")};var lt=require("uuid"),Xt=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},wn={$id:(0,lt.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},apiUrl:{type:"string"},apiKey:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","apiUrl","triggerType"],...Xt("enabled","apiUrl","triggerType")},Nr={$id:(0,lt.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...Xt("remoteJid","status")},kr={$id:(0,lt.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}},botIdFallback:{type:"string"}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids"],...Xt("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids")},Pr={$id:(0,lt.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...Xt("remoteJid","action")};var Ye=require("uuid"),ut=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},bn={$id:(0,Ye.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},openaiCredsId:{type:"string"},botType:{type:"string",enum:["assistant","chatCompletion"]},assistantId:{type:"string"},functionUrl:{type:"string"},model:{type:"string"},systemMessages:{type:"array",items:{type:"string"}},assistantMessages:{type:"array",items:{type:"string"}},userMessages:{type:"array",items:{type:"string"}},maxTokens:{type:"integer"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","openaiCredsId","botType","triggerType"],...ut("enabled","openaiCredsId","botType","triggerType")},_r={$id:(0,Ye.v4)(),type:"object",properties:{name:{type:"string"},apiKey:{type:"string"}},required:["name","apiKey"],...ut("name","apiKey")},Br={$id:(0,Ye.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...ut("remoteJid","status")},Fr={$id:(0,Ye.v4)(),type:"object",properties:{openaiCredsId:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},speechToText:{type:"boolean"},ignoreJids:{type:"array",items:{type:"string"}},openaiIdFallback:{type:"string"}},required:["openaiCredsId","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids"],...ut("openaiCredsId","expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe","keepOpen","debounceTime","ignoreJids")},Lr={$id:(0,Ye.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...ut("remoteJid","action")};var Qe=require("uuid"),dt=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},Sn={$id:(0,Qe.v4)(),type:"object",properties:{enabled:{type:"boolean"},description:{type:"string"},url:{type:"string"},typebot:{type:"string"},triggerType:{type:"string",enum:["all","keyword","none","advanced"]},triggerOperator:{type:"string",enum:["equals","contains","startsWith","endsWith","regex"]},triggerValue:{type:"string"},expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},ignoreJids:{type:"array",items:{type:"string"}}},required:["enabled","url","typebot","triggerType"],...dt("enabled","url","typebot","triggerType")},Ur={$id:(0,Qe.v4)(),type:"object",properties:{remoteJid:{type:"string"},status:{type:"string",enum:["opened","closed","paused","delete"]}},required:["remoteJid","status"],...dt("remoteJid","status")},Jr={$id:(0,Qe.v4)(),type:"object",properties:{remoteJid:{type:"string"},url:{type:"string"},typebot:{type:"string"}},required:["remoteJid","url","typebot"],...dt("remoteJid","url","typebot")},Wr={$id:(0,Qe.v4)(),type:"object",properties:{expire:{type:"integer"},keywordFinish:{type:"string"},delayMessage:{type:"integer"},unknownMessage:{type:"string"},listeningFromMe:{type:"boolean"},stopBotFromMe:{type:"boolean"},keepOpen:{type:"boolean"},debounceTime:{type:"integer"},typebotIdFallback:{type:"string"},ignoreJids:{type:"array",items:{type:"string"}}},required:["expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe"],...dt("expire","keywordFinish","delayMessage","unknownMessage","listeningFromMe","stopBotFromMe")},qr={$id:(0,Qe.v4)(),type:"object",properties:{remoteJid:{type:"string"},action:{type:"string",enum:["add","remove"]}},required:["remoteJid","action"],...dt("remoteJid","action")};var Gr=require("uuid");var Zt=class Zt{constructor(i,e,t,s){this.prisma=i,this.monitor=e,this.status=t,this.name=s}set prisma(i){this.prismaRepository=i}get prisma(){return this.prismaRepository}set monitor(i){this.waMonitor=i}get monitor(){return this.waMonitor}set name(i){this.integrationName=i}get name(){return this.integrationName}set status(i){this.integrationStatus=i}get status(){return this.integrationStatus}async set(i,e){if(this.status)return e[this.name]?.enabled?e[this.name].events.length===0&&(e[this.name].events=Zt.events):e[this.name].events=[],this.prisma[this.name].upsert({where:{instanceId:this.monitor.waInstances[i].instanceId},update:{enabled:e[this.name]?.enabled,events:e[this.name].events},create:{enabled:e[this.name]?.enabled,events:e[this.name].events,instanceId:this.monitor.waInstances[i].instanceId}})}async get(i){if(!this.status)return;if(this.monitor.waInstances[i]===void 0)return null;let e=await this.prisma[this.name].findUnique({where:{instanceId:this.monitor.waInstances[i].instanceId}});return e||null}};Zt.events=["APPLICATION_STARTUP","QRCODE_UPDATED","MESSAGES_SET","MESSAGES_UPSERT","MESSAGES_EDITED","MESSAGES_UPDATE","MESSAGES_DELETE","SEND_MESSAGE","CONTACTS_SET","CONTACTS_UPSERT","CONTACTS_UPDATE","PRESENCE_UPDATE","CHATS_SET","CHATS_UPSERT","CHATS_UPDATE","CHATS_DELETE","GROUPS_UPSERT","GROUP_UPDATE","GROUP_PARTICIPANTS_UPDATE","CONNECTION_UPDATE","LABELS_EDIT","LABELS_ASSOCIATION","CALL","TYPEBOT_START","TYPEBOT_CHANGE_STATUS","REMOVE_INSTANCE","LOGOUT_INSTANCE"];var j=Zt;var $r=require("uuid");var Nc=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},Vr={$id:(0,$r.v4)(),type:"object",properties:{webhook:{type:"object",properties:{enabled:{type:"boolean"},url:{type:"string"},headers:{type:"object"},byEvents:{type:"boolean"},base64:{type:"boolean"},events:{type:"array",minItems:0,items:{type:"string",enum:j.events}}},required:["enabled","url"],...Nc("enabled","url")}},required:["webhook"]};var ze={$id:(0,Gr.v4)(),type:"object",properties:{websocket:{$ref:"#/$defs/event"},rabbitmq:{$ref:"#/$defs/event"},sqs:{$ref:"#/$defs/event"}},$defs:{event:{type:"object",properties:{enabled:{type:"boolean",enum:[!0,!1]},events:{type:"array",minItems:0,items:{type:"string",enum:j.events}}},required:["enabled"]}}};var Hr=require("express"),ts=class extends O{constructor(...e){super();this.router=(0,Hr.Router)();this.router.post(this.routerPath("set"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Cr,ClassRef:jt,execute:(n,r)=>es.createChatwoot(n,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>es.findChatwoot(n)});s.status(200).json(o)}).post(this.routerPath("webhook"),async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:(n,r)=>es.receiveWebhook(n,r)});s.status(200).json(o)})}};var ie=class{};var gt=class{},ss=class{};var jr=require("express"),is=class extends O{constructor(...e){super();this.router=(0,jr.Router)();this.router.post(this.routerPath("create"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:yn,ClassRef:gt,execute:(n,r)=>X.createBot(n,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>X.findBot(n)});s.status(200).json(o)}).get(this.routerPath("fetch/:difyId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>X.fetchBot(n,t.params.difyId)});s.status(200).json(o)}).put(this.routerPath("update/:difyId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:yn,ClassRef:gt,execute:(n,r)=>X.updateBot(n,t.params.difyId,r)});s.status(200).json(o)}).delete(this.routerPath("delete/:difyId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>X.deleteBot(n,t.params.difyId)});s.status(200).json(o)}).post(this.routerPath("settings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Ar,ClassRef:ss,execute:(n,r)=>X.settings(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>X.fetchSettings(n)});s.status(200).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:vr,ClassRef:T,execute:(n,r)=>X.changeStatus(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSessions/:difyId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>X.fetchSessions(n,t.params.difyId)});s.status(200).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Rr,ClassRef:ie,execute:(n,r)=>X.ignoreJid(n,r)});s.status(200).json(o)})}};var ns=class{},ht=class{},os=class{};var Kr=require("express"),rs=class extends O{constructor(...e){super();this.router=(0,Kr.Router)();this.router.post(this.routerPath("creds"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:_r,ClassRef:ns,execute:(n,r)=>q.createOpenaiCreds(n,r)});s.status(201).json(o)}).get(this.routerPath("creds"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>q.findOpenaiCreds(n)});s.status(200).json(o)}).delete(this.routerPath("creds/:openaiCredsId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>q.deleteCreds(n,t.params.openaiCredsId)});s.status(200).json(o)}).post(this.routerPath("create"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:bn,ClassRef:ht,execute:(n,r)=>q.createBot(n,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>q.findBot(n)});s.status(200).json(o)}).get(this.routerPath("fetch/:openaiBotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>q.fetchBot(n,t.params.openaiBotId)});s.status(200).json(o)}).put(this.routerPath("update/:openaiBotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:bn,ClassRef:ht,execute:(n,r)=>q.updateBot(n,t.params.openaiBotId,r)});s.status(200).json(o)}).delete(this.routerPath("delete/:openaiBotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>q.deleteBot(n,t.params.openaiBotId)});s.status(200).json(o)}).post(this.routerPath("settings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Fr,ClassRef:os,execute:(n,r)=>q.settings(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>q.fetchSettings(n)});s.status(200).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Br,ClassRef:T,execute:(n,r)=>q.changeStatus(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSessions/:openaiBotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>q.fetchSessions(n,t.params.openaiBotId)});s.status(200).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Lr,ClassRef:ie,execute:(n,r)=>q.ignoreJid(n,r)});s.status(200).json(o)}).get(this.routerPath("getModels"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>q.getModels(n)});s.status(200).json(o)})}};var mt=class{},as=class{};var Yr=require("express"),cs=class extends O{constructor(...e){super();this.router=(0,Yr.Router)();this.router.post(this.routerPath("create"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Sn,ClassRef:mt,execute:(n,r)=>K.createBot(n,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>K.findBot(n)});s.status(200).json(o)}).get(this.routerPath("fetch/:typebotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>K.fetchBot(n,t.params.typebotId)});s.status(200).json(o)}).put(this.routerPath("update/:typebotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Sn,ClassRef:mt,execute:(n,r)=>K.updateBot(n,t.params.typebotId,r)});s.status(200).json(o)}).delete(this.routerPath("delete/:typebotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>K.deleteBot(n,t.params.typebotId)});s.status(200).json(o)}).post(this.routerPath("settings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Wr,ClassRef:as,execute:(n,r)=>K.settings(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>K.fetchSettings(n)});s.status(200).json(o)}).post(this.routerPath("start"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Jr,ClassRef:T,execute:(n,r)=>K.startBot(n,r)});s.status(200).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Ur,ClassRef:T,execute:(n,r)=>K.changeStatus(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSessions/:typebotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>K.fetchSessions(n,t.params.typebotId)});s.status(200).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:qr,ClassRef:ie,execute:(n,r)=>K.ignoreJid(n,r)});s.status(200).json(o)})}};var Xr=require("express");var Qr=require("express");var yt=class{},ps=class{};var ls=class extends O{constructor(...e){super();this.router=(0,Qr.Router)();this.router.post(this.routerPath("create"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:fn,ClassRef:yt,execute:(n,r)=>Z.createBot(n,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>Z.findBot(n)});s.status(200).json(o)}).get(this.routerPath("fetch/:evolutionBotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>Z.fetchBot(n,t.params.evolutionBotId)});s.status(200).json(o)}).put(this.routerPath("update/:evolutionBotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:fn,ClassRef:yt,execute:(n,r)=>Z.updateBot(n,t.params.evolutionBotId,r)});s.status(200).json(o)}).delete(this.routerPath("delete/:evolutionBotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>Z.deleteBot(n,t.params.evolutionBotId)});s.status(200).json(o)}).post(this.routerPath("settings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:xr,ClassRef:ps,execute:(n,r)=>Z.settings(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>Z.fetchSettings(n)});s.status(200).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Or,ClassRef:T,execute:(n,r)=>Z.changeStatus(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSessions/:evolutionBotId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>Z.fetchSessions(n,t.params.evolutionBotId)});s.status(200).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Dr,ClassRef:ie,execute:(n,r)=>Z.ignoreJid(n,r)});s.status(200).json(o)})}};var zr=require("express");var ft=class{},us=class{};var ds=class extends O{constructor(...e){super();this.router=(0,zr.Router)();this.router.post(this.routerPath("create"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:wn,ClassRef:ft,execute:(n,r)=>ee.createBot(n,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>ee.findBot(n)});s.status(200).json(o)}).get(this.routerPath("fetch/:flowiseId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>ee.fetchBot(n,t.params.flowiseId)});s.status(200).json(o)}).put(this.routerPath("update/:flowiseId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:wn,ClassRef:ft,execute:(n,r)=>ee.updateBot(n,t.params.flowiseId,r)});s.status(200).json(o)}).delete(this.routerPath("delete/:flowiseId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>ee.deleteBot(n,t.params.flowiseId)});s.status(200).json(o)}).post(this.routerPath("settings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:kr,ClassRef:us,execute:(n,r)=>ee.settings(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSettings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>ee.fetchSettings(n)});s.status(200).json(o)}).post(this.routerPath("changeStatus"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Nr,ClassRef:T,execute:(n,r)=>ee.changeStatus(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchSessions/:flowiseId"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>ee.fetchSessions(n,t.params.flowiseId)});s.status(200).json(o)}).post(this.routerPath("ignoreJid"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Pr,ClassRef:ie,execute:(n,r)=>ee.ignoreJid(n,r)});s.status(200).json(o)})}};var gs=class{constructor(...i){this.router=(0,Xr.Router)(),this.router.use("/evolutionBot",new ls(...i).router),this.router.use("/chatwoot",new ts(...i).router),this.router.use("/typebot",new cs(...i).router),this.router.use("/openai",new rs(...i).router),this.router.use("/dify",new is(...i).router),this.router.use("/flowise",new ds(...i).router)}};var Zr=require("express"),hs=class extends O{constructor(...e){super();this.router=(0,Zr.Router)();this.router.post(this.routerPath("set"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:ze,ClassRef:he,execute:(n,r)=>G.rabbitmq.set(n.instanceName,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>G.rabbitmq.get(n.instanceName)});s.status(200).json(o)})}};var ea=require("express"),ms=class extends O{constructor(...e){super();this.router=(0,ea.Router)();this.router.post(this.routerPath("set"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:ze,ClassRef:he,execute:(n,r)=>G.sqs.set(n.instanceName,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>G.sqs.get(n.instanceName)});s.status(200).json(o)})}};var ta=require("express"),ys=class extends O{constructor(e,...t){super();this.configService=e;this.router=(0,ta.Router)();this.router.post(this.routerPath("set"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:Vr,ClassRef:he,execute:(r,a)=>G.webhook.set(r.instanceName,a)});o.status(201).json(n)}).get(this.routerPath("find"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:R,ClassRef:T,execute:r=>G.webhook.get(r.instanceName)});o.status(200).json(n)})}};var sa=require("express"),fs=class extends O{constructor(...e){super();this.router=(0,sa.Router)();this.router.post(this.routerPath("set"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:ze,ClassRef:he,execute:(n,r)=>G.websocket.set(n.instanceName,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>G.websocket.get(n.instanceName)});s.status(200).json(o)})}};var ia=require("express"),ws=class{constructor(i,...e){this.router=(0,ia.Router)(),this.router.use("/webhook",new ys(i,...e).router),this.router.use("/websocket",new fs(...e).router),this.router.use("/rabbitmq",new hs(...e).router),this.router.use("/sqs",new ms(...e).router)}};var wt=class{};var En=require("uuid"),na=(...p)=>{let i={};return p.forEach(e=>i[e]={minLength:1,description:`The "${e}" cannot be empty`}),{if:{propertyNames:{enum:[...p]}},then:{properties:i}}},oa={$id:(0,En.v4)(),type:"object",properties:{id:{type:"string"},type:{type:"string"},messageId:{type:"integer"}},...na("id","type","messageId")},ra={$id:(0,En.v4)(),type:"object",properties:{id:{type:"string",pattern:"\\d+",minLength:1},expiry:{type:"string",pattern:"\\d+",minLength:1}},...na("id"),required:["id"]};var aa=require("express"),bs=class extends O{constructor(...e){super();this.router=(0,aa.Router)();this.router.post(this.routerPath("getMedia"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:oa,ClassRef:wt,execute:(n,r)=>In.getMedia(n,r)});s.status(201).json(o)}).post(this.routerPath("getMediaUrl"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:ra,ClassRef:wt,execute:(n,r)=>In.getMediaUrl(n,r)});s.status(200).json(o)})}};var ca=require("express"),Ss=class{constructor(...i){this.router=(0,ca.Router)(),this.router.use("/s3",new bs(...i).router)}};var wa=require("express"),wi=v(require("fs")),ba=v(require("mime")),Rn=v(require("path"));var Xe=class{constructor(i,e,t,s){this.jid=i;this.exists=e;this.number=t;this.name=s}},Es=class{},Is=class{},bt=class{};var Ms=class{},Ts=class{},Ze=class{};var Cs=class{};var vs=class{},As=class{},Rs=class{},Os=class{};var Mn=class{},xs=class extends Mn{},Ds=class extends xs{},Ns=class extends xs{},ks=class{};var pa=require("@prisma/client"),Be=class{},Ps=class extends pa.PrismaClient{constructor(e){super();this.configService=e;this.logger=new E("PrismaRepository")}async onModuleInit(){await this.$connect(),this.logger.info("Repository:Prisma - ON")}async onModuleDestroy(){await this.$disconnect(),this.logger.warn("Repository:Prisma - OFF")}};var la=require("express");var _s=class extends O{constructor(...e){super();this.router=(0,la.Router)();this.router.post(this.routerPath("whatsappNumbers"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:xo,ClassRef:Is,execute:(n,r)=>J.whatsappNumber(n,r)});return s.status(200).json(o)}).post(this.routerPath("markMessageAsRead"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Do,ClassRef:Cs,execute:(n,r)=>J.readMessage(n,r)});return s.status(201).json(o)}).post(this.routerPath("archiveChat"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:No,ClassRef:vs,execute:(n,r)=>J.archiveChat(n,r)});return s.status(201).json(o)}).post(this.routerPath("markChatUnread"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:ko,ClassRef:As,execute:(n,r)=>J.markChatUnread(n,r)});return s.status(201).json(o)}).delete(this.routerPath("deleteMessageForEveryone"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Po,ClassRef:Os,execute:(n,r)=>J.deleteMessage(n,r)});return s.status(201).json(o)}).post(this.routerPath("fetchProfilePictureUrl"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:rt,ClassRef:bt,execute:(n,r)=>J.fetchProfilePicture(n,r)});return s.status(200).json(o)}).post(this.routerPath("getBase64FromMediaMessage"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:null,ClassRef:Es,execute:(n,r)=>J.getBase64FromMediaMessage(n,r)});return s.status(201).json(o)}).post(this.routerPath("updateMessage"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:_o,ClassRef:Ns,execute:(n,r)=>J.updateMessage(n,r)});return s.status(200).json(o)}).post(this.routerPath("sendPresence"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Bo,ClassRef:Ds,execute:(n,r)=>J.sendPresence(n,r)});return s.status(201).json(o)}).post(this.routerPath("updateBlockStatus"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Fo,ClassRef:ks,execute:(n,r)=>J.blockUser(n,r)});return s.status(201).json(o)}).post(this.routerPath("findContacts"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:hn,ClassRef:Be,execute:(n,r)=>J.fetchContacts(n,r)});return s.status(200).json(o)}).post(this.routerPath("findMessages"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Lo,ClassRef:Be,execute:(n,r)=>J.fetchMessages(n,r)});return s.status(200).json(o)}).post(this.routerPath("findStatusMessage"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Uo,ClassRef:Be,execute:(n,r)=>J.fetchStatusMessage(n,r)});return s.status(200).json(o)}).post(this.routerPath("findChats"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:hn,ClassRef:Be,execute:(n,r)=>J.fetchChats(n,r)});return s.status(200).json(o)}).post(this.routerPath("fetchBusinessProfile"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:rt,ClassRef:Ze,execute:(n,r)=>J.fetchBusinessProfile(n,r)});return s.status(200).json(o)}).post(this.routerPath("fetchProfile"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:$o,ClassRef:bt,execute:(n,r)=>J.fetchProfile(n,r)});return s.status(200).json(o)}).post(this.routerPath("updateProfileName"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Wo,ClassRef:Ms,execute:(n,r)=>J.updateProfileName(n,r)});return s.status(200).json(o)}).post(this.routerPath("updateProfileStatus"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:qo,ClassRef:Ts,execute:(n,r)=>J.updateProfileStatus(n,r)});return s.status(200).json(o)}).post(this.routerPath("updateProfilePicture"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:rt,ClassRef:Ze,execute:(n,r)=>J.updateProfilePicture(n,r)});return s.status(200).json(o)}).delete(this.routerPath("removeProfilePicture"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:rt,ClassRef:Ze,execute:n=>J.removeProfilePicture(n)});return s.status(200).json(o)}).get(this.routerPath("fetchPrivacySettings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:null,ClassRef:T,execute:n=>J.fetchPrivacySettings(n)});return s.status(200).json(o)}).post(this.routerPath("updatePrivacySettings"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Jo,ClassRef:Rs,execute:(n,r)=>J.updatePrivacySettings(n,r)});return s.status(201).json(o)})}};var Bs=class{},Fs=class{},Ls=class{},Us=class{},ce=class{},Js=class{},Ws=class{},qs=class{},$s=class{},Vs=class extends ce{},Gs=class extends ce{},Hs=class extends ce{};var ua=require("express");var js=class extends O{constructor(...e){super();this.router=(0,ua.Router)();this.router.post(this.routerPath("create"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Vo,ClassRef:Bs,execute:(n,r)=>$.createGroup(n,r)});s.status(201).json(o)}).post(this.routerPath("updateGroupSubject"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:Zo,ClassRef:Ls,execute:(n,r)=>$.updateGroupSubject(n,r)});s.status(201).json(o)}).post(this.routerPath("updateGroupPicture"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:Xo,ClassRef:Fs,execute:(n,r)=>$.updateGroupPicture(n,r)});s.status(201).json(o)}).post(this.routerPath("updateGroupDescription"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:er,ClassRef:Us,execute:(n,r)=>$.updateGroupDescription(n,r)});s.status(201).json(o)}).get(this.routerPath("findGroupInfos"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:at,ClassRef:ce,execute:(n,r)=>$.findGroupInfo(n,r)});s.status(200).json(o)}).get(this.routerPath("fetchAllGroups"),...e,async(t,s)=>{let o=await this.getParticipantsValidate({request:t,schema:Go,ClassRef:Js,execute:(n,r)=>$.fetchAllGroups(n,r)});s.status(200).json(o)}).get(this.routerPath("participants"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:at,ClassRef:ce,execute:(n,r)=>$.findParticipants(n,r)});s.status(200).json(o)}).get(this.routerPath("inviteCode"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:at,ClassRef:ce,execute:(n,r)=>$.inviteCode(n,r)});s.status(200).json(o)}).get(this.routerPath("inviteInfo"),...e,async(t,s)=>{let o=await this.inviteCodeValidate({request:t,schema:jo,ClassRef:Ws,execute:(n,r)=>$.inviteInfo(n,r)});s.status(200).json(o)}).get(this.routerPath("acceptInviteCode"),...e,async(t,s)=>{let o=await this.inviteCodeValidate({request:t,schema:Ko,ClassRef:qs,execute:(n,r)=>$.acceptInviteCode(n,r)});s.status(200).json(o)}).post(this.routerPath("sendInvite"),...e,async(t,s)=>{let o=await this.groupNoValidate({request:t,schema:Ho,ClassRef:$s,execute:(n,r)=>$.sendInvite(n,r)});s.status(200).json(o)}).post(this.routerPath("revokeInviteCode"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:at,ClassRef:ce,execute:(n,r)=>$.revokeInviteCode(n,r)});s.status(201).json(o)}).post(this.routerPath("updateParticipant"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:Yo,ClassRef:Vs,execute:(n,r)=>$.updateGParticipate(n,r)});s.status(201).json(o)}).post(this.routerPath("updateSetting"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:Qo,ClassRef:Gs,execute:(n,r)=>$.updateGSetting(n,r)});s.status(201).json(o)}).post(this.routerPath("toggleEphemeral"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:zo,ClassRef:Hs,execute:(n,r)=>$.toggleEphemeral(n,r)});s.status(201).json(o)}).delete(this.routerPath("leaveGroup"),...e,async(t,s)=>{let o=await this.groupValidate({request:t,schema:{},ClassRef:ce,execute:(n,r)=>$.leaveGroup(n,r)});s.status(200).json(o)})}};var da=require("express");var Ks=class extends O{constructor(e,...t){super();this.configService=e;this.router=(0,da.Router)();this.router.post("/create",...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:R,ClassRef:T,execute:r=>be.createInstance(r)});return o.status(201).json(n)}).post(this.routerPath("restart"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:null,ClassRef:T,execute:r=>be.restartInstance(r)});return o.status(200).json(n)}).get(this.routerPath("connect"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:null,ClassRef:T,execute:r=>be.connectToWhatsapp(r)});return o.status(200).json(n)}).get(this.routerPath("connectionState"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:null,ClassRef:T,execute:r=>be.connectionState(r)});return o.status(200).json(n)}).get(this.routerPath("fetchInstances",!1),...t,async(s,o)=>{let n=s.get("apikey"),r=await this.dataValidate({request:s,schema:null,ClassRef:T,execute:a=>be.fetchInstances(a,n)});return o.status(200).json(r)}).post(this.routerPath("setPresence"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:ir,ClassRef:Yt,execute:(r,a)=>be.setPresence(r,a)});return o.status(201).json(n)}).delete(this.routerPath("logout"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:null,ClassRef:T,execute:r=>be.logout(r)});return o.status(200).json(n)}).delete(this.routerPath("delete"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:null,ClassRef:T,execute:r=>be.deleteInstance(r)});return o.status(200).json(n)})}};var Ys=class{},Qs=class{};var ga=require("express");var zs=class extends O{constructor(...e){super();this.router=(0,ga.Router)();this.router.get(this.routerPath("findLabels"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:null,ClassRef:Ys,execute:n=>Tn.fetchLabels(n)});return s.status(200).json(o)}).post(this.routerPath("handleLabel"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:or,ClassRef:Qs,execute:(n,r)=>Tn.handleLabel(n,r)});return s.status(200).json(o)})}};var Xs=class{};var ha=require("express");var Zs=class extends O{constructor(...e){super();this.router=(0,ha.Router)();this.router.post(this.routerPath("set"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:br,ClassRef:Xs,execute:(n,r)=>ei.createProxy(n,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:R,ClassRef:T,execute:n=>ei.findProxy(n)});s.status(200).json(o)})}};var ne=class{},ti=class extends ne{};var si=class extends ne{},ii=class extends ne{},St=class extends ne{},ni=class extends ne{};var oi=class extends ne{},ri=class extends ne{};var ai=class extends ne{};var ci=class extends ne{},pi=class extends ne{},li=class{};var ma=require("express");var ui=class extends O{constructor(...e){super();this.router=(0,ma.Router)();this.router.post(this.routerPath("sendTemplate"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:rr,ClassRef:ci,execute:(n,r)=>te.sendTemplate(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendText"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:ar,ClassRef:ti,execute:(n,r)=>te.sendText(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendMedia"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:cr,ClassRef:St,execute:(n,r)=>te.sendMedia(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendWhatsAppAudio"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:pr,ClassRef:St,execute:(n,r)=>te.sendWhatsAppAudio(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendStatus"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:lr,ClassRef:si,execute:(n,r)=>te.sendStatus(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendSticker"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:ur,ClassRef:ni,execute:(n,r)=>te.sendSticker(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendLocation"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:dr,ClassRef:ri,execute:(n,r)=>te.sendLocation(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendContact"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:gr,ClassRef:pi,execute:(n,r)=>te.sendContact(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendReaction"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:hr,ClassRef:li,execute:(n,r)=>te.sendReaction(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendPoll"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:mr,ClassRef:ii,execute:(n,r)=>te.sendPoll(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendList"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:yr,ClassRef:ai,execute:(n,r)=>te.sendList(n,r)});return s.status(201).json(o)}).post(this.routerPath("sendButtons"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:fr,ClassRef:oi,execute:(n,r)=>te.sendButtons(n,r)});return s.status(201).json(o)})}};var di=class{};var ya=require("express");var gi=class extends O{constructor(...e){super();this.router=(0,ya.Router)();this.router.post(this.routerPath("set"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:Er,ClassRef:di,execute:(n,r)=>Cn.createSettings(n,r)});s.status(201).json(o)}).get(this.routerPath("find"),...e,async(t,s)=>{let o=await this.dataValidate({request:t,schema:null,ClassRef:T,execute:n=>Cn.findSettings(n)});s.status(200).json(o)})}};var hi=class{};var fa=require("express");var mi=class extends O{constructor(e,...t){super();this.configService=e;this.router=(0,fa.Router)();this.router.post(this.routerPath("create"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:Mr,ClassRef:hi,execute:(r,a)=>vn.createTemplate(r,a)});o.status(201).json(n)}).get(this.routerPath("find"),...t,async(s,o)=>{let n=await this.dataValidate({request:s,schema:R,ClassRef:T,execute:r=>vn.findTemplate(r)});o.status(200).json(n)})}};var fi=v(require("express")),An=v(require("path")),yi=class extends O{constructor(){super(),this.router=(0,fi.Router)();let i=An.default.join(process.cwd(),"manager","dist"),e=An.default.join(i,"index.html");this.router.use(fi.default.static(i)),this.router.get("*",(t,s)=>{s.sendFile(e)})}};var On=(0,wa.Router)(),Sa=M.get("SERVER"),pe=[wo,bo,dn.apikey],kc=new Io,Pc=JSON.parse(wi.default.readFileSync("./package.json","utf8"));Sa.DISABLE_MANAGER||On.use("/manager",new yi().router);On.get("/assets/*",(p,i)=>{let e=p.params[0],t=Rn.default.join(process.cwd(),"manager","dist"),s=Rn.default.join(t,"assets/",e);wi.default.existsSync(s)?(i.set("Content-Type",ba.default.getType(s)||"text/css"),i.send(wi.default.readFileSync(s))):i.status(404).send("File not found")});On.use((p,i,e)=>kc.collectTelemetry(p,i,e)).get("/",(p,i)=>{i.status(200).json({status:200,message:"Welcome to the Evolution API, it is working!",version:Pc.version,clientName:process.env.DATABASE_CONNECTION_CLIENT_NAME,manager:Sa.DISABLE_MANAGER?void 0:`${p.protocol}://${p.get("host")}/manager`,documentation:"https://doc.evolution-api.com"})}).post("/verify-creds",dn.apikey,async(p,i)=>i.status(200).json({status:200,message:"Credentials are valid",facebookAppId:process.env.FACEBOOK_APP_ID,facebookConfigId:process.env.FACEBOOK_CONFIG_ID,facebookUserToken:process.env.FACEBOOK_USER_TOKEN})).use("/instance",new Ks(M,...pe).router).use("/message",new ui(...pe).router).use("/chat",new _s(...pe).router).use("/group",new js(...pe).router).use("/template",new mi(M,...pe).router).use("/settings",new gi(...pe).router).use("/proxy",new Zs(...pe).router).use("/label",new zs(...pe).router).use("",new Ht(M).router).use("",new ws(M,...pe).router).use("",new gs(...pe).router).use("",new Ss(...pe).router);var m=class{constructor(...i){throw{status:400,error:"Bad Request",message:i.length>0?i:void 0}}};var _e=class{constructor(...i){throw{status:401,error:"Unauthorized",message:i.length>0?i:"Unauthorized"}}};var He=class{constructor(...i){throw{status:403,error:"Forbidden",message:i.length>0?i:void 0}}};var _=class{constructor(...i){throw{status:404,error:"Not Found",message:i.length>0?i:void 0}}};var N=class{constructor(...i){throw{status:500,error:"Internal Server Error",message:i.length>0?i:void 0}}};var xn=require("https-proxy-agent");function le(p){if(typeof p=="string")return new xn.HttpsProxyAgent(p);let{host:i,password:e,port:t,protocol:s,username:o}=p,n=`${s}://${i}:${t}`;return o&&e&&(n=`${s}://${o}:${e}@${i}:${t}`),new xn.HttpsProxyAgent(n)}var Et=v(require("axios")),Dn=new E("ProxyController"),bi=class{constructor(i,e){this.proxyService=i;this.waMonitor=e}async createProxy(i,e){if(!this.waMonitor.waInstances[i.instanceName])throw new _(`The "${i.instanceName}" instance does not exist`);if(e?.enabled||(e.host="",e.port="",e.protocol="",e.username="",e.password=""),e.host&&!await this.testProxy(e))throw new m("Invalid proxy");return this.proxyService.create(i,e)}async findProxy(i){if(!this.waMonitor.waInstances[i.instanceName])throw new _(`The "${i.instanceName}" instance does not exist`);return this.proxyService.find(i)}async testProxy(i){try{let e=await Et.default.get("https://icanhazip.com/");return(await Et.default.get("https://icanhazip.com/",{httpsAgent:le(i)}))?.data!==e?.data}catch(e){return Et.default.isAxiosError(e)&&e.response?.data?Dn.error("testProxy error: "+e.response.data):(Et.default.isAxiosError(e),Dn.error("testProxy error: ")),!1}}};var Se=require("class-validator"),Si=class{constructor(i){this.waMonitor=i}async sendTemplate({instanceName:i},e){return await this.waMonitor.waInstances[i].templateMessage(e)}async sendText({instanceName:i},e){return await this.waMonitor.waInstances[i].textMessage(e)}async sendMedia({instanceName:i},e){if((0,Se.isBase64)(e?.media)&&!e?.fileName&&e?.mediatype==="document")throw new m("For base64 the file name must be informed.");if((0,Se.isURL)(e?.media)||(0,Se.isBase64)(e?.media))return await this.waMonitor.waInstances[i].mediaMessage(e);throw new m("Owned media must be a url or base64")}async sendSticker({instanceName:i},e){if((0,Se.isURL)(e.sticker)||(0,Se.isBase64)(e.sticker))return await this.waMonitor.waInstances[i].mediaSticker(e);throw new m("Owned media must be a url or base64")}async sendWhatsAppAudio({instanceName:i},e){if((0,Se.isURL)(e.audio)||(0,Se.isBase64)(e.audio))return await this.waMonitor.waInstances[i].audioWhatsapp(e);throw new m("Owned media must be a url or base64")}async sendButtons({instanceName:i},e){return await this.waMonitor.waInstances[i].buttonMessage(e)}async sendLocation({instanceName:i},e){return await this.waMonitor.waInstances[i].locationMessage(e)}async sendList({instanceName:i},e){return await this.waMonitor.waInstances[i].listMessage(e)}async sendContact({instanceName:i},e){return await this.waMonitor.waInstances[i].contactMessage(e)}async sendReaction({instanceName:i},e){if(!e.reaction.match(/[^()\w\s-"-+]+/))throw new m('"reaction" must be an emoji');return await this.waMonitor.waInstances[i].reactionMessage(e)}async sendPoll({instanceName:i},e){return await this.waMonitor.waInstances[i].pollMessage(e)}async sendStatus({instanceName:i},e){return await this.waMonitor.waInstances[i].statusMessage(e)}};var Ei=class{constructor(i){this.settingsService=i}async createSettings(i,e){return this.settingsService.create(i,e)}async findSettings(i){return this.settingsService.find(i)}};var Ii=class{constructor(i){this.templateService=i}async createTemplate(i,e){return this.templateService.create(i,e)}async findTemplate(i){return this.templateService.find(i)}};var Ea=v(require("pg")),{Pool:_c}=Ea.default,Nn=class{constructor(){this.logger=new E("Postgres");this.connected=!1}getConnection(i){if(this.connected)return this.pool;this.pool=new _c({connectionString:i,ssl:{rejectUnauthorized:!1}}),this.pool.on("error",()=>{this.logger.error("postgres disconnected"),this.connected=!1});try{this.connected=!0}catch(e){return this.connected=!1,this.logger.error("postgres connect exception caught: "+e),null}return this.pool}getChatwootConnection(){let i=M.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI;return this.getConnection(i)}},Ae=new Nn;var kn=class{constructor(){this.logger=new E("ChatwootImport");this.repositoryMessagesCache=new Map;this.historyMessages=new Map;this.historyContacts=new Map}getRepositoryMessagesCache(i){return this.repositoryMessagesCache.has(i.instanceName)?this.repositoryMessagesCache.get(i.instanceName):null}setRepositoryMessagesCache(i,e){this.repositoryMessagesCache.set(i.instanceName,e)}deleteRepositoryMessagesCache(i){this.repositoryMessagesCache.delete(i.instanceName)}addHistoryMessages(i,e){let t=this.historyMessages.has(i.instanceName)?this.historyMessages.get(i.instanceName):[];this.historyMessages.set(i.instanceName,t.concat(e))}addHistoryContacts(i,e){let t=this.historyContacts.has(i.instanceName)?this.historyContacts.get(i.instanceName):[];this.historyContacts.set(i.instanceName,t.concat(e))}deleteHistoryMessages(i){this.historyMessages.delete(i.instanceName)}deleteHistoryContacts(i){this.historyContacts.delete(i.instanceName)}clearAll(i){this.deleteRepositoryMessagesCache(i),this.deleteHistoryMessages(i),this.deleteHistoryContacts(i)}getHistoryMessagesLenght(i){return this.historyMessages.get(i.instanceName)?.length??0}async importHistoryContacts(i,e){try{if(this.getHistoryMessagesLenght(i)>0)return;let t=Ae.getChatwootConnection(),s=0,o=this.historyContacts.get(i.instanceName)||[];if(o.length===0)return 0;let n=this.sliceIntoChunks(o,3e3);for(;n.length>0;){let r=`SELECT id FROM labels WHERE title = '${e.nameInbox}' AND account_id = ${e.accountId} LIMIT 1`,a=(await t.query(r))?.rows[0]?.id;if(!a){let f=`INSERT INTO labels (title, color, show_on_sidebar, account_id, created_at, updated_at) VALUES ('${e.nameInbox}', '#34039B', true, ${e.accountId}, NOW(), NOW()) RETURNING id`;a=(await t.query(f))?.rows[0]?.id}let c=`INSERT INTO contacts
          (name, phone_number, account_id, identifier, created_at, updated_at) VALUES `,u=[e.accountId];for(let f of n){u.push(f.pushName);let w=`$${u.length}`;u.push(`+${f.remoteJid.split("@")[0]}`);let I=`$${u.length}`;u.push(f.remoteJid);let b=`$${u.length}`;c+=`(${w}, ${I}, $1, ${b}, NOW(), NOW()),`}c.slice(-1)===","&&(c=c.slice(0,-1)),c+=` ON CONFLICT (identifier, account_id)
                       DO UPDATE SET
                        name = EXCLUDED.name,
                        phone_number = EXCLUDED.phone_number,
                        identifier = EXCLUDED.identifier`,s+=(await t.query(c,u))?.rowCount??0;let d=`SELECT id FROM tags WHERE name = '${e.nameInbox}' LIMIT 1`,g=(await t.query(d))?.rows[0]?.id,h=`INSERT INTO tags (name, taggings_count) VALUES ('${e.nameInbox}', ${s}) ON CONFLICT (name) DO UPDATE SET taggings_count = tags.taggings_count + ${s} RETURNING id`;g=(await t.query(h))?.rows[0]?.id,await t.query(h);let y="INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) VALUES ";n.forEach(f=>{let w=`(SELECT id FROM contacts WHERE identifier = '${f.remoteJid}' AND account_id = ${e.accountId})`;y+=`($1, $2, ${w}, $3, NOW()),`}),y.slice(-1)===","&&(y=y.slice(0,-1)),await t.query(y,[g,"Contact","labels"]),n=this.sliceIntoChunks(o,3e3)}return this.deleteHistoryContacts(i),s}catch(t){this.logger.error(`Error on import history contacts: ${t.toString()}`)}}async importHistoryMessages(i,e,t,s){try{let o=Ae.getChatwootConnection(),n=await this.getChatwootUser(s);if(!n)throw new Error("User not found to import messages.");let r=0,a=this.historyMessages.get(i.instanceName)||[];if(a.length===0)return 0;a.sort((h,y)=>{let f=h.key,w=y.key,I=h.messageTimestamp,b=y.messageTimestamp;return parseInt(f.remoteJid)-parseInt(w.remoteJid)||I-b});let c=this.createMessagesMapByPhoneNumber(a),u=new Map;c.forEach((h,y)=>{u.set(y,{first:h[0]?.messageTimestamp,last:h[h.length-1]?.messageTimestamp})});let d=4e3,l=this.sliceIntoChunks(a,d);for(;l.length>0;){let h=this.createMessagesMapByPhoneNumber(l);if(h.size>0){let y=await this.selectOrCreateFksFromChatwoot(s,t,u,h),f=`INSERT INTO messages
            (content, account_id, inbox_id, conversation_id, message_type, private, content_type,
            sender_type, sender_id, created_at, updated_at) VALUES `,w=[s.accountId,t.id];h.forEach((I,b)=>{let S=y.get(b);I.forEach(C=>{if(!C.message||!S?.conversation_id||!S?.contact_id)return;let P=this.getContentMessage(e,C);if(!P)return;w.push(P);let L=`$${w.length}`;w.push(S.conversation_id);let W=`$${w.length}`;w.push(C.key.fromMe?"1":"0");let Me=`$${w.length}`;w.push(C.key.fromMe?n.user_type:"Contact");let ke=`$${w.length}`;w.push(C.key.fromMe?n.user_id:S.contact_id);let Te=`$${w.length}`;w.push(C.messageTimestamp);let de=`$${w.length}`;f+=`(${L}, $1, $2, ${W}, ${Me}, FALSE, 0,
                  ${ke},${Te}, to_timestamp(${de}), to_timestamp(${de})),`})}),w.length>2&&(f.slice(-1)===","&&(f=f.slice(0,-1)),r+=(await o.query(f,w))?.rowCount??0)}l=this.sliceIntoChunks(a,d)}this.deleteHistoryMessages(i),this.deleteRepositoryMessagesCache(i);let g={...s,ignoreJids:Array.isArray(s.ignoreJids)?s.ignoreJids.map(h=>String(h)):[]};return this.importHistoryContacts(i,g),r}catch(o){this.logger.error(`Error on import history messages: ${o.toString()}`),this.deleteHistoryMessages(i),this.deleteRepositoryMessagesCache(i)}}async selectOrCreateFksFromChatwoot(i,e,t,s){let o=Ae.getChatwootConnection(),n=[i.accountId,e.id],a=`WITH
              phone_number AS (
                SELECT phone_number, created_at::INTEGER, last_activity_at::INTEGER FROM (
                  VALUES 
                   ${Array.from(s.keys()).map(u=>{let d=t.get(u);if(d){n.push(u);let l=`($${n.length},`;return n.push(d.first),l+=`$${n.length},`,n.push(d.last),`${l}$${n.length})`}}).join(",")}
                 ) as t (phone_number, created_at, last_activity_at)
              ),

              only_new_phone_number AS (
                SELECT * FROM phone_number
                WHERE phone_number NOT IN (
                  SELECT phone_number
                  FROM contacts
                    JOIN contact_inboxes ci ON ci.contact_id = contacts.id AND ci.inbox_id = $2
                    JOIN conversations con ON con.contact_inbox_id = ci.id 
                      AND con.account_id = $1
                      AND con.inbox_id = $2
                      AND con.contact_id = contacts.id
                  WHERE contacts.account_id = $1
                )
              ),

              new_contact AS (
                INSERT INTO contacts (name, phone_number, account_id, identifier, created_at, updated_at)
                SELECT REPLACE(p.phone_number, '+', ''), p.phone_number, $1, CONCAT(REPLACE(p.phone_number, '+', ''),
                  '@s.whatsapp.net'), to_timestamp(p.created_at), to_timestamp(p.last_activity_at)
                FROM only_new_phone_number AS p
                ON CONFLICT(identifier, account_id) DO UPDATE SET updated_at = EXCLUDED.updated_at
                RETURNING id, phone_number, created_at, updated_at
              ),

              new_contact_inbox AS (
                INSERT INTO contact_inboxes (contact_id, inbox_id, source_id, created_at, updated_at)
                SELECT new_contact.id, $2, gen_random_uuid(), new_contact.created_at, new_contact.updated_at
                FROM new_contact 
                RETURNING id, contact_id, created_at, updated_at
              ),

              new_conversation AS (
                INSERT INTO conversations (account_id, inbox_id, status, contact_id,
                  contact_inbox_id, uuid, last_activity_at, created_at, updated_at)
                SELECT $1, $2, 0, new_contact_inbox.contact_id, new_contact_inbox.id, gen_random_uuid(),
                  new_contact_inbox.updated_at, new_contact_inbox.created_at, new_contact_inbox.updated_at
                FROM new_contact_inbox
                RETURNING id, contact_id
              )

              SELECT new_contact.phone_number, new_conversation.contact_id, new_conversation.id AS conversation_id
              FROM new_conversation 
              JOIN new_contact ON new_conversation.contact_id = new_contact.id

              UNION

              SELECT p.phone_number, c.id contact_id, con.id conversation_id
                FROM phone_number p
              JOIN contacts c ON c.phone_number = p.phone_number
              JOIN contact_inboxes ci ON ci.contact_id = c.id AND ci.inbox_id = $2
              JOIN conversations con ON con.contact_inbox_id = ci.id AND con.account_id = $1
                AND con.inbox_id = $2 AND con.contact_id = c.id`,c=await o.query(a,n);return new Map(c.rows.map(u=>[u.phone_number,u]))}async getChatwootUser(i){try{return(await Ae.getChatwootConnection().query(`SELECT owner_type AS user_type, owner_id AS user_id
                         FROM access_tokens
                       WHERE token = $1`,[i.token]))?.rows[0]||!1}catch(e){this.logger.error(`Error on getChatwootUser: ${e.toString()}`)}}createMessagesMapByPhoneNumber(i){return i.reduce((e,t)=>{let s=t?.key;if(!this.isIgnorePhoneNumber(s?.remoteJid)){let o=s?.remoteJid?.split("@")[0];if(o){let n=`+${o}`,r=e.has(n)?e.get(n):[];r.push(t),e.set(n,r)}}return e},new Map)}async getContactsOrderByRecentConversations(i,e,t=50){try{return(await Ae.getChatwootConnection().query(`SELECT contacts.id, contacts.identifier, contacts.phone_number
                     FROM conversations
                   JOIN contacts ON contacts.id = conversations.contact_id
                   WHERE conversations.account_id = $1
                     AND inbox_id = $2
                   ORDER BY conversations.last_activity_at DESC
                   LIMIT $3`,[e.accountId,i.id,t]))?.rows}catch(s){this.logger.error(`Error on get recent conversations: ${s.toString()}`)}}getContentMessage(i,e){let t=i.getConversationMessage(e.message);if(t)return t;if(!M.get("CHATWOOT").IMPORT.PLACEHOLDER_MEDIA_MESSAGE)return"";let s={documentMessage:e.message.documentMessage,documentWithCaptionMessage:e.message.documentWithCaptionMessage?.message?.documentMessage,imageMessage:e.message.imageMessage,videoMessage:e.message.videoMessage,audioMessage:e.message.audioMessage,stickerMessage:e.message.stickerMessage,templateMessage:e.message.templateMessage?.hydratedTemplate?.hydratedContentText};switch(Object.keys(s).find(n=>s[n]!==void 0)){case"documentMessage":return`_<File: ${e.message.documentMessage.fileName}${e.message.documentMessage.caption?` ${e.message.documentMessage.caption}`:""}>_`;case"documentWithCaptionMessage":return`_<File: ${e.message.documentWithCaptionMessage.message.documentMessage.fileName}${e.message.documentWithCaptionMessage.message.documentMessage.caption?` ${e.message.documentWithCaptionMessage.message.documentMessage.caption}`:""}>_`;case"templateMessage":return e.message.templateMessage.hydratedTemplate.hydratedTitleText?`*${e.message.templateMessage.hydratedTemplate.hydratedTitleText}*\\n`:""+e.message.templateMessage.hydratedTemplate.hydratedContentText;case"imageMessage":return"_<Image Message>_";case"videoMessage":return"_<Video Message>_";case"audioMessage":return"_<Audio Message>_";case"stickerMessage":return"_<Sticker Message>_";default:return""}}sliceIntoChunks(i,e){return i.splice(0,e)}isGroup(i){return i.includes("@g.us")}isIgnorePhoneNumber(i){return this.isGroup(i)||i==="status@broadcast"||i==="0@s.whatsapp.net"}},oe=new kn;var Ta=v(require("@figuro/chatwoot-sdk")),Mi=require("@figuro/chatwoot-sdk/dist/core/request");var Ia=v(require("fs")),Pn=v(require("i18next")),_n=v(require("path")),Bc=["en","pt-BR","es"],Fc=_n.default.join(__dirname,"translations"),Lc=new Pe,Ma={};Bc.forEach(p=>{let i=_n.default.join(Fc,`${p}.json`);Ia.default.existsSync(i)&&(Ma[p]={translation:require(i)})});Pn.default.init({resources:Ma,fallbackLng:"en",lng:Lc.get("LANGUAGE"),debug:!1,interpolation:{escapeValue:!1}});var k=Pn.default;var It=v(require("axios")),Bn=v(require("form-data")),Fn=v(require("jimp")),Ca=v(require("long")),et=v(require("mime")),Ln=v(require("path")),Ti=require("stream"),ye=class{constructor(i,e,t,s){this.waMonitor=i;this.configService=e;this.prismaRepository=t;this.cache=s;this.logger=new E("ChatwootService");this.pgClient=Ae.getChatwootConnection()}async getProvider(i){let e=`${i.instanceName}:getProvider`;if(await this.cache.has(e))return await this.cache.get(e);let t=await this.waMonitor.waInstances[i.instanceName]?.findChatwoot();return t?(this.cache.set(e,t),t):(this.logger.warn("provider not found"),null)}async clientCw(i){let e=await this.getProvider(i);return e?(this.provider=e,new Ta.default({config:this.getClientCwConfig()})):(this.logger.error("provider not found"),null)}getClientCwConfig(){return{basePath:this.provider.url,with_credentials:!0,credentials:"include",token:this.provider.token,nameInbox:this.provider.nameInbox,mergeBrazilContacts:this.provider.mergeBrazilContacts}}getCache(){return this.cache}async create(i,e){if(await this.waMonitor.waInstances[i.instanceName].setChatwoot(e),e.autoCreate){this.logger.log("Auto create chatwoot instance");let t=this.configService.get("SERVER").URL;await this.initInstanceChatwoot(i,e.nameInbox??i.instanceName.split("-cwId-")[0],`${t}/chatwoot/webhook/${encodeURIComponent(i.instanceName)}`,!0,e.number,e.organization,e.logo)}return e}async find(i){try{return await this.waMonitor.waInstances[i.instanceName].findChatwoot()}catch{return this.logger.error("chatwoot not found"),{enabled:null,url:""}}}async getContact(i,e){let t=await this.clientCw(i);if(!t)return this.logger.warn("client not found"),null;if(!e)return this.logger.warn("id is required"),null;let s=await t.contact.getContactable({accountId:this.provider.accountId,id:e});return s||(this.logger.warn("contact not found"),null)}async initInstanceChatwoot(i,e,t,s,o,n,r){let a=await this.clientCw(i);if(!a)return this.logger.warn("client not found"),null;let c=await a.inboxes.list({accountId:this.provider.accountId}),u=c.payload.map(h=>h.name).includes(e),d;if(this.logger.log("Creating chatwoot inbox"),u){let h=c.payload.find(y=>y.name===e);if(!h)return this.logger.warn("inbox not found"),null;d=h.id}else{let h={type:"api",webhook_url:t},y=await a.inboxes.create({accountId:this.provider.accountId,data:{name:e,channel:h}});if(!y)return this.logger.warn("inbox not found"),null;d=y.id}if(this.logger.log(`Inbox created - inboxId: ${d}`),!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;this.logger.log("Creating chatwoot bot contact");let l=await this.findContact(i,"123456")||await this.createContact(i,"123456",d,!1,n||"EvolutionAPI",r||"https://evolution-api.com/files/evolution-api-favicon.png");if(!l)return this.logger.warn("contact not found"),null;let g=l.id||l.payload.contact.id;if(this.logger.log(`Contact created - contactId: ${g}`),s){this.logger.log("QR code enabled");let h={contact_id:g.toString(),inbox_id:d.toString()},y=await a.conversations.create({accountId:this.provider.accountId,data:h});if(!y)return this.logger.warn("conversation not found"),null;let f="init";if(o&&(f=`init:${o}`),!await a.messages.create({accountId:this.provider.accountId,conversationId:y.id,data:{content:f,message_type:"outgoing"}}))return this.logger.warn("conversation not found"),null;this.logger.log("Init message sent")}return!0}async createContact(i,e,t,s,o,n,r){let a=await this.clientCw(i);if(!a)return this.logger.warn("client not found"),null;let c={};s?c={inbox_id:t,name:o||e,identifier:e,avatar_url:n}:(c={inbox_id:t,name:o||e,identifier:r,avatar_url:n},(r&&r.includes("@")||!r)&&(c.phone_number=`+${e}`));let u=await a.contacts.create({accountId:this.provider.accountId,data:c});if(!u)return this.logger.warn("contact not found"),null;let l=(await this.findContact(i,e))?.id;return await this.addLabelToContact(this.provider.nameInbox,l),u}async updateContact(i,e,t){let s=await this.clientCw(i);if(!s)return this.logger.warn("client not found"),null;if(!e)return this.logger.warn("id is required"),null;try{return await s.contacts.update({accountId:this.provider.accountId,id:e,data:t})}catch{return null}}async addLabelToContact(i,e){try{if(!this.configService.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI)return!1;let s=`SELECT id FROM tags WHERE name = '${i}' LIMIT 1`,o=(await this.pgClient.query(s))?.rows[0],n=o?.id,r=o?.taggings_count||0,a=`INSERT INTO tags (name, taggings_count) VALUES ('${i}', ${r+1}) ON CONFLICT (name) DO UPDATE SET taggings_count = ${r+1} RETURNING id`;n=(await this.pgClient.query(a))?.rows[0]?.id,await this.pgClient.query(a);let c=`INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) VALUES (${n}, 'Contact', ${e}, 'labels', NOW())`;return await this.pgClient.query(c),!0}catch(t){return this.logger.error(t),!1}}async findContact(i,e){let t=await this.clientCw(i);if(!t)return this.logger.warn("client not found"),null;let s,o=e.includes("@g.us");o?s=e:s=`+${e}`;let n;return o?n=await t.contacts.search({accountId:this.provider.accountId,q:s}):n=await(0,Mi.request)(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/contacts/filter`,body:{payload:this.getFilterPayload(s)}}),!n&&n?.payload?.length===0?(this.logger.warn("contact not found"),null):o?n.payload.find(r=>r.identifier===s):n.payload.length>1?this.findContactInContactList(n.payload,s):n.payload[0]}async mergeBrazilianContacts(i){try{return await(0,Mi.request)(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,body:{base_contact_id:i.find(t=>t.phone_number.length===14)?.id,mergee_contact_id:i.find(t=>t.phone_number.length===13)?.id}})}catch{return this.logger.error("Error merging contacts"),null}}findContactInContactList(i,e){let t=this.getNumbers(e),s=this.getSearchableFields();if(i.length===2&&this.getClientCwConfig().mergeBrazilContacts&&e.startsWith("+55")){let r=this.mergeBrazilianContacts(i);if(r)return r}let o=t.reduce((r,a)=>a.length>r.length?a:r,""),n=i.find(r=>r.phone_number===o);if(n)return n;for(let r of i)for(let a of s)if(r[a]&&t.includes(r[a]))return r;return null}getNumbers(i){let e=[];if(e.push(i),i.startsWith("+55")&&i.length===14){let t=i.slice(0,5)+i.slice(6);e.push(t)}else if(i.startsWith("+55")&&i.length===13){let t=i.slice(0,5)+"9"+i.slice(5);e.push(t)}return e}getSearchableFields(){return["phone_number"]}getFilterPayload(i){let e=[],t=this.getNumbers(i),s=this.getSearchableFields();return s.forEach((o,n)=>{t.forEach((r,a)=>{let c=s.length-1===n&&t.length-1===a?null:"OR";e.push({attribute_key:o,filter_operator:"equal_to",values:[r.replace("+","")],query_operator:c})})}),e}async createConversation(i,e){try{let t=await this.clientCw(i);if(!t)return this.logger.warn("client not found"),null;let s=`${i.instanceName}:createConversation-${e.key.remoteJid}`;if(await this.cache.has(s)){let y=await this.cache.get(s),f;try{f=await t.conversations.get({accountId:this.provider.accountId,conversationId:y})}catch{f=!1}return f?y:(this.cache.delete(s),await this.createConversation(i,e))}let o=e.key.remoteJid.includes("@g.us"),n=o?e.key.remoteJid:e.key.remoteJid.split("@")[0],r;r=e.key.fromMe?n:e.pushName;let a=await this.getInbox(i);if(!a)return this.logger.warn("inbox not found"),null;if(o){r=`${(await this.waMonitor.waInstances[i.instanceName].client.groupMetadata(n)).subject} (GROUP)`;let f=await this.waMonitor.waInstances[i.instanceName].profilePicture(e.key.participant.split("@")[0]),w=await this.findContact(i,e.key.participant.split("@")[0]);w?(!w.name||w.name===n)&&await this.updateContact(i,w.id,{name:e.pushName,avatar_url:f.profilePictureUrl||null}):await this.createContact(i,e.key.participant.split("@")[0],a.id,!1,e.pushName,f.profilePictureUrl||null,e.key.participant)}let c=await this.waMonitor.waInstances[i.instanceName].profilePicture(n),u=await this.findContact(i,n);if(u){if(!e.key.fromMe){let y=c?.profilePictureUrl?.split("#")[0].split("?")[0].split("/").pop()||"",f=u?.thumbnail?.split("#")[0].split("?")[0].split("/").pop()||"",w=y!==f,I=!u.name||u.name===n||(`+${n}`.startsWith("+55")?this.getNumbers(`+${n}`).some(S=>u.name===S||u.name===S.substring(3)||u.name===S.substring(1)):!1);(w||I)&&(u=await this.updateContact(i,u.id,{...I&&{name:r},...y===""&&{avatar:null},...w&&{avatar_url:c?.profilePictureUrl}}))}}else{let y=e.key.remoteJid;u=await this.createContact(i,n,a.id,o,r,c.profilePictureUrl||null,y)}if(!u)return this.logger.warn("contact not found"),null;let d=u?.payload?.id||u?.payload?.contact?.id||u?.id,l=await t.contacts.listConversations({accountId:this.provider.accountId,id:d});if(l?.payload?.length){let y;if(this.provider.reopenConversation?(y=l.payload.find(f=>f.inbox_id==a.id),this.provider.conversationPending&&await t.conversations.toggleStatus({accountId:this.provider.accountId,conversationId:y.id,data:{status:"pending"}})):y=l.payload.find(f=>f.status!=="resolved"&&f.inbox_id==a.id),y)return this.cache.set(s,y.id),y.id}let g={contact_id:d.toString(),inbox_id:a.id.toString()};this.provider.conversationPending&&(g.status="pending");let h=await t.conversations.create({accountId:this.provider.accountId,data:g});return h?(this.cache.set(s,h.id),h.id):(this.logger.warn("conversation not found"),null)}catch(t){this.logger.error(t)}}async getInbox(i){let e=`${i.instanceName}:getInbox`;if(await this.cache.has(e))return await this.cache.get(e);let t=await this.clientCw(i);if(!t)return this.logger.warn("client not found"),null;let s=await t.inboxes.list({accountId:this.provider.accountId});if(!s)return this.logger.warn("inbox not found"),null;let o=s.payload.find(n=>n.name===this.getClientCwConfig().nameInbox);return o?(this.cache.set(e,o),o):(this.logger.warn("inbox not found"),null)}async createMessage(i,e,t,s,o,n,r,a,c){let u=await this.clientCw(i);if(!u)return this.logger.warn("client not found"),null;let d=await this.getReplyToIds(r,i),l=c?.chatwootMessageId||null,g=await u.messages.create({accountId:this.provider.accountId,conversationId:e,data:{content:t,message_type:s,attachments:n,private:o||!1,source_id:a,content_attributes:{...d},source_reply_id:l?l.toString():null}});return g||(this.logger.warn("message not found"),null)}async getOpenConversationByContact(i,e,t){let s=await this.clientCw(i);return s?(await s.contacts.listConversations({accountId:this.provider.accountId,id:t.id})).payload.find(n=>n.inbox_id===e.id&&n.status==="open")||void 0:(this.logger.warn("client not found"),null)}async createBotMessage(i,e,t,s){let o=await this.clientCw(i);if(!o)return this.logger.warn("client not found"),null;if(!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;let n=await this.findContact(i,"123456");if(!n)return this.logger.warn("contact not found"),null;let r=await this.getInbox(i);if(!r)return this.logger.warn("inbox not found"),null;let a=await this.getOpenConversationByContact(i,r,n);if(!a){this.logger.warn("conversation not found");return}let c=await o.messages.create({accountId:this.provider.accountId,conversationId:a.id,data:{content:e,message_type:t,attachments:s}});return c||(this.logger.warn("message not found"),null)}async sendData(i,e,t,s,o,n,r,a,c){let u=new Bn.default;o&&u.append("content",o),u.append("message_type",s),u.append("attachments[]",e,{filename:t});let d=c?.chatwootMessageId||null;if(r&&n){let g=await this.getReplyToIds(r,n);(g.in_reply_to||g.in_reply_to_external_id)&&u.append("content_attributes",{...g})}d&&u.append("source_reply_id",d.toString()),a&&u.append("source_id",a);let l={method:"post",maxBodyLength:1/0,url:`${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${i}/messages`,headers:{api_access_token:this.provider.token,...u.getHeaders()},data:u};try{let{data:g}=await It.default.request(l);return g}catch(g){this.logger.error(g)}}async createBotQr(i,e,t,s,o){if(!await this.clientCw(i))return this.logger.warn("client not found"),null;if(!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;let r=await this.findContact(i,"123456");if(!r)return this.logger.warn("contact not found"),null;let a=await this.getInbox(i);if(!a)return this.logger.warn("inbox not found"),null;let c=await this.getOpenConversationByContact(i,a,r);if(!c){this.logger.warn("conversation not found");return}let u=new Bn.default;e&&u.append("content",e),u.append("message_type",t),s&&o&&u.append("attachments[]",s,{filename:o});let d={method:"post",maxBodyLength:1/0,url:`${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${c.id}/messages`,headers:{api_access_token:this.provider.token,...u.getHeaders()},data:u};try{let{data:l}=await It.default.request(d);return l}catch(l){this.logger.error(l)}}async sendAttachment(i,e,t,s,o){try{let n=Ln.default.parse(decodeURIComponent(t)),r=et.default.getType(n?.ext)||"",a=n?.name+n?.ext;if(!r){let l=t.split("/");a=decodeURIComponent(l[l.length-1]),r=(await It.default.get(t,{responseType:"arraybuffer"})).headers["content-type"]}let c="document";switch(r.split("/")[0]){case"image":c="image";break;case"video":c="video";break;case"audio":c="audio";break;default:c="document";break}if(c==="audio"){let l={number:e,audio:t,delay:1200,quoted:o?.quoted};return B("/message/sendWhatsAppAudio"),await i?.audioWhatsapp(l,!0)}c==="image"&&n&&n?.ext===".gif"&&(c="document");let u={number:e,mediatype:c,fileName:a,media:t,delay:1200,quoted:o?.quoted};return B("/message/sendMedia"),s&&(u.caption=s),await i?.mediaMessage(u,!0)}catch(n){this.logger.error(n)}}async onSendMessageError(i,e,t){let s=await this.clientCw(i);s&&s.messages.create({accountId:this.provider.accountId,conversationId:e,data:{content:k.t("cw.message.notsent",{error:t?.length>0?`_${t}_`:""}),message_type:"outgoing",private:!0}})}async receiveWebhook(i,e){try{if(await new Promise(c=>setTimeout(c,500)),!await this.clientCw(i))return this.logger.warn("client not found"),null;if(this.provider.reopenConversation===!1&&e.event==="conversation_status_changed"&&e.status==="resolved"&&e.meta?.sender?.identifier){let c=`${i.instanceName}:createConversation-${e.meta.sender.identifier}`;this.cache.delete(c)}if(!e?.conversation||e.private||e.event==="message_updated"&&!e.content_attributes?.deleted)return{message:"bot"};let s=e.conversation.meta.sender?.identifier||e.conversation.meta.sender?.phone_number.replace("+",""),o=e.content?e.content.replaceAll(/(?<!\*)\*((?!\s)([^\n*]+?)(?<!\s))\*(?!\*)/g,"_$1_").replaceAll(/\*{2}((?!\s)([^\n*]+?)(?<!\s))\*{2}/g,"*$1*").replaceAll(/~{2}((?!\s)([^\n*]+?)(?<!\s))~{2}/g,"~$1~").replaceAll(/(?<!`)`((?!\s)([^`*]+?)(?<!\s))`(?!`)/g,"```$1```"):e.content,n=e?.conversation?.messages[0]?.sender?.available_name||e?.sender?.name,r=this.waMonitor.waInstances[i.instanceName];if(e.event==="message_updated"&&e.content_attributes?.deleted){let c=await this.prismaRepository.message.findFirst({where:{chatwootMessageId:e.id,instanceId:i.instanceId}});if(c){let u=c.key;await r?.client.sendMessage(u.remoteJid,{delete:u}),await this.prismaRepository.message.deleteMany({where:{instanceId:i.instanceId,chatwootMessageId:e.id}})}return{message:"bot"}}if(this.configService.get("CHATWOOT").BOT_CONTACT&&s==="123456"&&e.message_type==="outgoing"){let c=o.replace("/","");if(c.includes("init")||c.includes("iniciar"))if(r?.connectionStatus?.state!=="open"){let d=c.split(":")[1];await r.connectToWhatsapp(d)}else await this.createBotMessage(i,k.t("cw.inbox.alreadyConnected",{inboxName:e.inbox.name}),"incoming");if(c==="clearcache"&&(r.clearCacheChatwoot(),await this.createBotMessage(i,k.t("cw.inbox.clearCache",{inboxName:e.inbox.name}),"incoming")),c==="status"){let u=r?.connectionStatus?.state;u||await this.createBotMessage(i,k.t("cw.inbox.notFound",{inboxName:e.inbox.name}),"incoming"),u&&await this.createBotMessage(i,k.t("cw.inbox.status",{inboxName:e.inbox.name,state:u}),"incoming")}if(c==="disconnect"||c==="desconectar"){let u=k.t("cw.inbox.disconnect",{inboxName:e.inbox.name});await this.createBotMessage(i,u,"incoming"),await r?.client?.logout("Log out instance: "+i.instanceName),await r?.client?.ws?.close()}}if(e.message_type==="outgoing"&&e?.conversation?.messages?.length&&s!=="123456"){if(e?.conversation?.messages[0]?.source_id?.substring(0,5)==="WAID:")return{message:"bot"};if(!r&&e.conversation?.id)return this.onSendMessageError(i,e.conversation?.id,"Instance not found"),{message:"bot"};let c;if(n==null)c=o;else{let d=this.provider.signDelimiter?this.provider.signDelimiter.replaceAll("\\n",`
`):`
`,l=this.provider.signMsg?[`*${n}:*`]:[];l.push(o),c=l.join(d)}for(let d of e.conversation.messages)if(d.attachments&&d.attachments.length>0)for(let l of d.attachments){o||(c=null);let g={quoted:await this.getQuotedMessage(e,i)},h=await this.sendAttachment(r,s,l.data_url,c,g);!h&&e.conversation?.id&&this.onSendMessageError(i,e.conversation?.id),await this.updateChatwootMessageId({...h,owner:i.instanceName},{messageId:e.id,inboxId:e.inbox?.id,conversationId:e.conversation?.id,contactInboxSourceId:e.conversation?.contact_inbox?.source_id},i)}else{let l={number:s,text:c,delay:1200,quoted:await this.getQuotedMessage(e,i)};B("/message/sendText");let g;try{if(g=await r?.textMessage(l,!0),!g)throw new Error("Message not sent");Ca.default.isLong(g?.messageTimestamp)&&(g.messageTimestamp=g.messageTimestamp?.toNumber()),await this.updateChatwootMessageId({...g,instanceId:i.instanceId},{messageId:e.id,inboxId:e.inbox?.id,conversationId:e.conversation?.id,contactInboxSourceId:e.conversation?.contact_inbox?.source_id},i)}catch(h){throw!g&&e.conversation?.id&&this.onSendMessageError(i,e.conversation?.id,h.toString()),h}}if(this.configService.get("CHATWOOT").MESSAGE_READ){let d=await this.prismaRepository.message.findFirst({where:{key:{path:["fromMe"],equals:!1},instanceId:i.instanceId}});if(d&&!d.chatwootIsRead){let l=d.key;r?.markMessageAsRead({readMessages:[{id:l.id,fromMe:l.fromMe,remoteJid:l.remoteJid}]});let g={chatwootMessageId:d.chatwootMessageId,chatwootConversationId:d.chatwootConversationId,chatwootInboxId:d.chatwootInboxId,chatwootContactInboxSourceId:d.chatwootContactInboxSourceId,chatwootIsRead:!0};await this.prismaRepository.message.updateMany({where:{instanceId:i.instanceId,key:{path:["id"],equals:l.id}},data:g})}}}if(e.message_type==="template"&&e.event==="message_created"){let c={number:s,text:e.content.replace(/\\\r\n|\\\n|\n/g,`
`),delay:1200};B("/message/sendText"),await r?.textMessage(c)}return{message:"bot"}}catch(t){return this.logger.error(t),{message:"bot"}}}async updateChatwootMessageId(i,e,t){let s=i.key;!e.messageId||!s?.id||await this.prismaRepository.message.updateMany({where:{key:{path:["id"],equals:s.id},instanceId:t.instanceId},data:{chatwootMessageId:e.messageId,chatwootConversationId:e.conversationId,chatwootInboxId:e.inboxId,chatwootContactInboxSourceId:e.contactInboxSourceId,chatwootIsRead:e.isRead}})}async getMessageByKeyId(i,e){return await this.prismaRepository.message.findFirst({where:{key:{path:["id"],equals:e},instanceId:i.instanceId}})||null}async getReplyToIds(i,e){let t=null,s=null;if(i&&(s=i.message?.extendedTextMessage?.contextInfo?.stanzaId??i.contextInfo?.stanzaId,s)){let o=await this.getMessageByKeyId(e,s);o?.chatwootMessageId&&(t=o.chatwootMessageId)}return{in_reply_to:t,in_reply_to_external_id:s}}async getQuotedMessage(i,e){if(i?.content_attributes?.in_reply_to){let t=await this.prismaRepository.message.findFirst({where:{chatwootMessageId:i?.content_attributes?.in_reply_to,instanceId:e.instanceId}}),s=t?.key;if(t&&s?.id)return{key:t.key,message:t.message}}return null}isMediaMessage(i){let e=["imageMessage","documentMessage","documentWithCaptionMessage","audioMessage","videoMessage","stickerMessage","viewOnceMessageV2"];return Object.keys(i).some(o=>e.includes(o))}getAdsMessage(i){return i.extendedTextMessage?.contextInfo?.externalAdReply}getReactionMessage(i){return i?.reactionMessage}getTypeMessage(i){return{conversation:i.conversation,imageMessage:i.imageMessage?.caption,videoMessage:i.videoMessage?.caption,extendedTextMessage:i.extendedTextMessage?.text,messageContextInfo:i.messageContextInfo?.stanzaId,stickerMessage:void 0,documentMessage:i.documentMessage?.caption,documentWithCaptionMessage:i.documentWithCaptionMessage?.message?.documentMessage?.caption,audioMessage:i.audioMessage?.caption,contactMessage:i.contactMessage?.vcard,contactsArrayMessage:i.contactsArrayMessage,locationMessage:i.locationMessage,liveLocationMessage:i.liveLocationMessage,listMessage:i.listMessage,listResponseMessage:i.listResponseMessage,viewOnceMessageV2:i?.message?.viewOnceMessageV2?.message?.imageMessage?.url||i?.message?.viewOnceMessageV2?.message?.videoMessage?.url||i?.message?.viewOnceMessageV2?.message?.audioMessage?.url}}getMessageContent(i){let e=Object.keys(i).find(s=>i[s]!==void 0),t=e?i[e]:void 0;if(t&&typeof t=="string"&&t.includes("externalAdReplyBody|")&&(t=t.split("externalAdReplyBody|").filter(Boolean).join("")),e==="locationMessage"||e==="liveLocationMessage"){let s=t.degreesLatitude,o=t.degreesLongitude,n=t?.name,r=t?.address;return`*${k.t("cw.locationMessage.location")}:*

_${k.t("cw.locationMessage.latitude")}:_ ${s} 
_${k.t("cw.locationMessage.longitude")}:_ ${o} 
`+(n?`_${k.t("cw.locationMessage.locationName")}:_ ${n}
`:"")+(r?`_${k.t("cw.locationMessage.locationAddress")}:_ ${r} 
`:"")+`_${k.t("cw.locationMessage.locationUrl")}:_ https://www.google.com/maps/search/?api=1&query=${s},${o}`}if(e==="contactMessage"){let s=t.split(`
`),o={};s.forEach(a=>{let[c,u]=a.split(":");c&&u&&(o[c]=u)});let n=`*${k.t("cw.contactMessage.contact")}:*

_${k.t("cw.contactMessage.name")}:_ ${o.FN}`,r=1;return Object.keys(o).forEach(a=>{if(a.startsWith("item")&&a.includes("TEL")){let c=o[a];n+=`
_${k.t("cw.contactMessage.number")} (${r}):_ ${c}`,r++}else if(a.includes("TEL")){let c=o[a];n+=`
_${k.t("cw.contactMessage.number")} (${r}):_ ${c}`,r++}}),n}if(e==="contactsArrayMessage")return t.contacts.map(n=>{let r=n.vcard.split(`
`),a={};r.forEach(d=>{let[l,g]=d.split(":");l&&g&&(a[l]=g)});let c=`*${k.t("cw.contactMessage.contact")}:*

_${k.t("cw.contactMessage.name")}:_ ${n.displayName}`,u=1;return Object.keys(a).forEach(d=>{if(d.startsWith("item")&&d.includes("TEL")){let l=a[d];c+=`
_${k.t("cw.contactMessage.number")} (${u}):_ ${l}`,u++}else if(d.includes("TEL")){let l=a[d];c+=`
_${k.t("cw.contactMessage.number")} (${u}):_ ${l}`,u++}}),c}).join(`

`);if(e==="listMessage"){let s=t?.title||"Unknown",o=t?.description||"Unknown",n=t?.footerText||"Unknown",r=`*List Menu:*

_Title_: `+s+`
_Description_: `+o+`
_Footer_: `+n;return t.sections&&t.sections.length>0?t.sections.forEach((a,c)=>{r+=`

*Section `+(c+1)+":* "+a.title||`Unknown
`,a.rows&&a.rows.length>0?a.rows.forEach((u,d)=>{r+=`
*Line `+(d+1)+`:*
`,r+="_\u25AA\uFE0F Title:_ "+(u.title||"Unknown")+`
`,r+="_\u25AA\uFE0F Description:_ "+(u.description||"Unknown")+`
`,r+="_\u25AA\uFE0F ID:_ "+(u.rowId||"Unknown")+`
`}):r+=`
No lines found in this section.
`}):r+=`
No sections found.
`,r}if(e==="listResponseMessage"){let s=t?.title||"Unknown",o=t?.description||"Unknown",n=t?.singleSelectReply?.selectedRowId||"Unknown";return`*List Response:*

_Title_: `+s+`
_Description_: `+o+`
_ID_: `+n}return t}getConversationMessage(i){let e=this.getTypeMessage(i);return this.getMessageContent(e)}async eventWhatsapp(i,e,t){try{let s=this.waMonitor.waInstances[e.instanceName];if(!s)return this.logger.warn("wa instance not found"),null;let o=await this.clientCw(e);if(!o)return this.logger.warn("client not found"),null;if(this.provider?.ignoreJids&&this.provider?.ignoreJids.length>0){let n=this.provider?.ignoreJids,r=!1,a=!1;if(n.includes("@g.us")&&(r=!0),n.includes("@s.whatsapp.net")&&(a=!0),r&&t?.key?.remoteJid.endsWith("@g.us")){this.logger.warn("Ignoring message from group: "+t?.key?.remoteJid);return}if(a&&t?.key?.remoteJid.endsWith("@s.whatsapp.net")){this.logger.warn("Ignoring message from contact: "+t?.key?.remoteJid);return}if(n.includes(t?.key?.remoteJid)){this.logger.warn("Ignoring message from jid: "+t?.key?.remoteJid);return}}if(i==="contact.is_not_in_wpp"){let n=await this.createConversation(e,t);if(!n){this.logger.warn("conversation not found");return}o.messages.create({accountId:this.provider.accountId,conversationId:n,data:{content:`\u{1F6A8} ${k.t("numbernotinwhatsapp")}`,message_type:"outgoing",private:!0}});return}if(i==="messages.upsert"||i==="send.message"){if(t.key.remoteJid==="status@broadcast")return;t.message?.ephemeralMessage?.message&&(t.message={...t.message?.ephemeralMessage?.message});let n=await this.getConversationMessage(t.message),r=n&&n.replaceAll(/\*((?!\s)([^\n*]+?)(?<!\s))\*/g,"**$1**").replaceAll(/_((?!\s)([^\n_]+?)(?<!\s))_/g,"*$1*").replaceAll(/~((?!\s)([^\n~]+?)(?<!\s))~/g,"~~$1~~");if(r&&r.includes("Por favor, classifique esta conversa, http"))return;let a=t.contextInfo?.stanzaId||t.message?.contextInfo?.stanzaId,c=null;a&&(c=await this.prismaRepository.message.findFirst({where:{key:{path:["id"],equals:a}}}));let u=this.isMediaMessage(t.message),d=this.getAdsMessage(t.message),l=this.getReactionMessage(t.message);if(!r&&!u&&!l){this.logger.warn("no body message found");return}let g=await this.createConversation(e,t);if(!g){this.logger.warn("conversation not found");return}let h=t.key.fromMe?"outgoing":"incoming";if(u){let y=await s?.getBase64FromMediaMessage({message:{...t}}),f,w=t?.message[t?.messageType],I=w?.fileName||w?.filename||w?.message?.documentMessage?.fileName;if(I){let C=Ln.default.parse(I);C.name&&C.ext&&(f=`${C.name}-${Math.floor(Math.random()*90+10)}${C.ext}`)}f||(f=`${Math.random().toString(36).substring(7)}.${et.default.getExtension(y.mimetype)||""}`);let b=Buffer.from(y.base64,"base64"),S=new Ti.Readable;if(S._read=()=>{},S.push(b),S.push(null),t.key.remoteJid.includes("@g.us")){let C=t.pushName,P;t.key.fromMe?P=`${r}`:P=`**${C}:**

${r}`;let L=await this.sendData(g,S,f,h,P,e,t,"WAID:"+t.key.id,c);if(!L){this.logger.warn("message not sent");return}return L}else{let C=await this.sendData(g,S,f,h,r,e,t,"WAID:"+t.key.id,c);if(!C){this.logger.warn("message not sent");return}return C}}if(l){if(l.text&&!await this.createMessage(e,g,l.text,h,!1,[],{message:{extendedTextMessage:{contextInfo:{stanzaId:l.key.id}}}},"WAID:"+t.key.id,c)){this.logger.warn("message not sent");return}return}if(d){let y=await It.default.get(d.thumbnailUrl,{responseType:"arraybuffer"}),f=et.default.getExtension(y.headers["content-type"]),w=f&&et.default.getType(f);if(!w){this.logger.warn("mimetype of Ads message not found");return}let b=`${Math.random().toString(36).substring(7)}.${et.default.getExtension(w)}`,S=Buffer.from(y.data,"binary"),C=await Fn.default.read(S);await C.cover(320,180);let P=await C.getBufferAsync(Fn.default.MIME_PNG),L=new Ti.Readable;L._read=()=>{},L.push(P),L.push(null);let W=(de,Ge)=>de.length>Ge?de.substring(0,Ge)+"...":de,Me=W(d.title,40),ke=W(d.body,75),Te=await this.sendData(g,L,b,h,`${r}


**${Me}**
${ke}
${d.sourceUrl}`,e,t,"WAID:"+t.key.id);if(!Te){this.logger.warn("message not sent");return}return Te}if(t.key.remoteJid.includes("@g.us")){let y=t.pushName,f;t.key.fromMe?f=`${r}`:f=`**${y}**

${r}`;let w=await this.createMessage(e,g,f,h,!1,[],t,"WAID:"+t.key.id,c);if(!w){this.logger.warn("message not sent");return}return w}else{let y=await this.createMessage(e,g,r,h,!1,[],t,"WAID:"+t.key.id,c);if(!y){this.logger.warn("message not sent");return}return y}}if(i==="messages.delete"&&this.configService.get("CHATWOOT").MESSAGE_DELETE===!0){if(!t?.key?.id){this.logger.warn("message id not found");return}let r=await this.getMessageByKeyId(e,t.key.id);if(r?.chatwootMessageId&&r?.chatwootConversationId)return await this.prismaRepository.message.deleteMany({where:{key:{path:["id"],equals:t.key.id},instanceId:e.instanceId}}),await o.messages.delete({accountId:this.provider.accountId,conversationId:r.chatwootConversationId,messageId:r.chatwootMessageId})}if(i==="messages.edit"){let n=`${t?.editedMessage?.conversation||t?.editedMessage?.extendedTextMessage?.text}

_\`${k.t("cw.message.edited")}.\`_`,r=await this.getMessageByKeyId(e,t?.key?.id),a=r.key,c=a?.fromMe?"outgoing":"incoming";if(r&&r.chatwootConversationId&&!await this.createMessage(e,r.chatwootConversationId,n,c,!1,[],{message:{extendedTextMessage:{contextInfo:{stanzaId:a.id}}}},"WAID:"+t.key.id,null)){this.logger.warn("edited message not sent");return}return}if(i==="messages.read"){if(!t?.key?.id||!t?.key?.remoteJid){this.logger.warn("message id not found");return}let n=await this.getMessageByKeyId(e,t.key.id),r=n?.chatwootConversationId,a=n?.chatwootContactInboxSourceId;if(r){let c=a,u=await this.getInbox(e);if(!c&&u&&(c=(await o.conversations.get({accountId:this.provider.accountId,conversationId:r})).last_non_activity_message?.conversation?.contact_inbox?.source_id),c&&u?.inbox_identifier){let d=`/public/api/v1/inboxes/${u.inbox_identifier}/contacts/${c}/conversations/${r}/update_last_seen`;(0,Mi.request)(this.getClientCwConfig(),{method:"POST",url:d})}}return}if(i==="status.instance"){let n=t,r=await this.getInbox(e);if(!r){this.logger.warn("inbox not found");return}let a=k.t("cw.inbox.status",{inboxName:r.name,state:n.status});await this.createBotMessage(e,a,"incoming")}if(i==="connection.update"&&t.status==="open"&&this.waMonitor.waInstances[e.instanceName].qrCode.count>0){let n=k.t("cw.inbox.connected");await this.createBotMessage(e,n,"incoming"),this.waMonitor.waInstances[e.instanceName].qrCode.count=0,oe.clearAll(e)}if(i==="qrcode.updated")if(t.statusCode===500){let n=`\u{1F6A8} ${k.t("qrlimitreached")}`;return await this.createBotMessage(e,n,"incoming")}else{let n=Buffer.from(t?.qrcode.base64.replace("data:image/png;base64,",""),"base64"),r=new Ti.Readable;r._read=()=>{},r.push(n),r.push(null),await this.createBotQr(e,k.t("qrgeneratedsuccesfully"),"incoming",r,`${e.instanceName}.png`);let a=`\u26A1\uFE0F${k.t("qrgeneratedsuccesfully")}

${k.t("scanqr")}`;t?.qrcode?.pairingCode&&(a=a+`

*Pairing Code:* ${t.qrcode.pairingCode.substring(0,4)}-${t.qrcode.pairingCode.substring(4,8)}`),await this.createBotMessage(e,a,"incoming")}}catch(s){this.logger.error(s)}}getNumberFromRemoteJid(i){return i.replace(/:\d+/,"").split("@")[0]}startImportHistoryMessages(i){this.isImportHistoryAvailable()&&this.createBotMessage(i,k.t("cw.import.startImport"),"incoming")}isImportHistoryAvailable(){let i=this.configService.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI;return i&&i!=="postgres://user:password@hostname:port/dbname"}addHistoryMessages(i,e){this.isImportHistoryAvailable()&&oe.addHistoryMessages(i,e)}addHistoryContacts(i,e){if(this.isImportHistoryAvailable())return oe.addHistoryContacts(i,e)}async importHistoryMessages(i){if(!this.isImportHistoryAvailable())return;this.createBotMessage(i,k.t("cw.import.importingMessages"),"incoming");let e=await oe.importHistoryMessages(i,this,await this.getInbox(i),this.provider);this.updateContactAvatarInRecentConversations(i);let t=Number.isInteger(e)?k.t("cw.import.messagesImported",{totalMessagesImported:e}):k.t("cw.import.messagesException");return this.createBotMessage(i,t,"incoming"),e}async updateContactAvatarInRecentConversations(i,e=100){try{if(!this.isImportHistoryAvailable())return;let t=await this.clientCw(i);if(!t)return this.logger.warn("client not found"),null;let s=await this.getInbox(i);if(!s)return this.logger.warn("inbox not found"),null;let o=await oe.getContactsOrderByRecentConversations(s,this.provider,e),n=o.map(a=>a.identifier).filter(a=>a!==null),r=(await this.prismaRepository.contact.findMany({where:{instanceId:i.instanceId,id:{in:n},profilePicUrl:{not:null}}})).reduce((a,c)=>a.set(c.id,c),new Map);o.forEach(async a=>{r.has(a.identifier)&&t.contacts.update({accountId:this.provider.accountId,id:a.id,data:{avatar_url:r.get(a.identifier).profilePictureUrl||null}})})}catch(t){this.logger.error(`Error on update avatar in recent conversations: ${t.toString()}`)}}};var Mt=v(require("axios")),va=require("stream"),tt=class{constructor(i,e,t){this.waMonitor=i;this.configService=e;this.prismaRepository=t;this.logger=new E("DifyService")}async createNewSession(i,e){try{return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:e.remoteJid,pushName:e.pushName,sessionId:e.remoteJid,status:"opened",awaitUser:!1,botId:e.botId,instanceId:i.instanceId,type:"dify"}})}}catch(t){this.logger.error(t);return}}isImageMessage(i){return i.includes("imageMessage")}isJSON(i){try{return JSON.parse(i),!0}catch{return!1}}async sendMessageToBot(i,e,t,s,o,n,r){try{let a=s.apiUrl;if(s.botType==="chatBot"){a+="/chat-messages";let c={inputs:{remoteJid:o,pushName:n,instanceName:i.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY},query:r,response_mode:"blocking",conversation_id:e.sessionId===o?void 0:e.sessionId,user:o};if(this.isImageMessage(r)){let g=r.split("|");c.files=[{type:"image",transfer_method:"remote_url",url:g[1].split("?")[0]}],c.query=g[2]||r}i.integration===D.WHATSAPP_BAILEYS&&(await i.client.presenceSubscribe(o),await i.client.sendPresenceUpdate("composing",o));let u=await Mt.default.post(a,c,{headers:{Authorization:`Bearer ${s.apiKey}`}});i.integration===D.WHATSAPP_BAILEYS&&await i.client.sendPresenceUpdate("paused",o);let d=u?.data?.answer,l=u?.data?.conversation_id;await this.sendMessageWhatsApp(i,o,d,t),await this.prismaRepository.integrationSession.update({where:{id:e.id},data:{status:"opened",awaitUser:!0,sessionId:e.sessionId===o?l:e.sessionId}})}if(s.botType==="textGenerator"){a+="/completion-messages";let c={inputs:{query:r,pushName:n,remoteJid:o,instanceName:i.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY},response_mode:"blocking",conversation_id:e.sessionId===o?void 0:e.sessionId,user:o};if(this.isImageMessage(r)){let g=r.split("|");c.files=[{type:"image",transfer_method:"remote_url",url:g[1].split("?")[0]}],c.inputs.query=g[2]||r}i.integration===D.WHATSAPP_BAILEYS&&(await i.client.presenceSubscribe(o),await i.client.sendPresenceUpdate("composing",o));let u=await Mt.default.post(a,c,{headers:{Authorization:`Bearer ${s.apiKey}`}});i.integration===D.WHATSAPP_BAILEYS&&await i.client.sendPresenceUpdate("paused",o);let d=u?.data?.answer,l=u?.data?.conversation_id;await this.sendMessageWhatsApp(i,o,d,t),await this.prismaRepository.integrationSession.update({where:{id:e.id},data:{status:"opened",awaitUser:!0,sessionId:e.sessionId===o?l:e.sessionId}})}if(s.botType==="agent"){a+="/chat-messages";let c={inputs:{remoteJid:o,pushName:n,instanceName:i.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY},query:r,response_mode:"streaming",conversation_id:e.sessionId===o?void 0:e.sessionId,user:o};if(this.isImageMessage(r)){let y=r.split("|");c.files=[{type:"image",transfer_method:"remote_url",url:y[1].split("?")[0]}],c.query=y[2]||r}i.integration===D.WHATSAPP_BAILEYS&&(await i.client.presenceSubscribe(o),await i.client.sendPresenceUpdate("composing",o));let u=await Mt.default.post(a,c,{headers:{Authorization:`Bearer ${s.apiKey}`},responseType:"stream"}),d,l="",g=u.data,h=new va.Readable().wrap(g);h.on("data",y=>{let f=y.toString().replace(/data:\s*/g,"");if(!(f.trim()===""||!f.startsWith("{")))try{let w=f.split(`
`).filter(I=>I.trim()!=="");for(let I of w)if(I.trim().startsWith("{")){let b=JSON.parse(I);b?.event==="agent_message"&&(console.log("event:",b),d=d??b?.conversation_id,l+=b?.answer)}}catch(w){console.error("Error parsing stream data:",w)}}),h.on("end",async()=>{i.integration===D.WHATSAPP_BAILEYS&&await i.client.sendPresenceUpdate("paused",o);let y=l;await this.sendMessageWhatsApp(i,o,y,t),await this.prismaRepository.integrationSession.update({where:{id:e.id},data:{status:"opened",awaitUser:!0,sessionId:d}})}),h.on("error",y=>{console.error("Error reading stream:",y)});return}if(s.botType==="workflow"){a+="/workflows/run";let c={inputs:{query:r,remoteJid:o,pushName:n,instanceName:i.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY},response_mode:"blocking",user:o};if(this.isImageMessage(r)){let l=r.split("|");c.files=[{type:"image",transfer_method:"remote_url",url:l[1].split("?")[0]}],c.inputs.query=l[2]||r}i.integration===D.WHATSAPP_BAILEYS&&(await i.client.presenceSubscribe(o),await i.client.sendPresenceUpdate("composing",o));let u=await Mt.default.post(a,c,{headers:{Authorization:`Bearer ${s.apiKey}`}});i.integration===D.WHATSAPP_BAILEYS&&await i.client.sendPresenceUpdate("paused",o);let d=u?.data?.data.outputs.text;await this.sendMessageWhatsApp(i,o,d,t),await this.prismaRepository.integrationSession.update({where:{id:e.id},data:{status:"opened",awaitUser:!0}});return}}catch(a){this.logger.error(a.response?.data||a);return}}async sendMessageWhatsApp(i,e,t,s){let o=/(!?)\[(.*?)\]\((.*?)\)/g,n="",r=0,a,c=u=>{let d=u.split(".").pop()?.toLowerCase(),l=["jpg","jpeg","png","gif","bmp","webp"],g=["mp3","wav","aac","ogg"],h=["mp4","avi","mkv","mov"],y=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return l.includes(d||"")?"image":g.includes(d||"")?"audio":h.includes(d||"")?"video":y.includes(d||"")?"document":null};for(;(a=o.exec(t))!==null;){let[u,d,l,g]=a,h=c(g),y=t.slice(r,a.index);y&&(n+=y),h?(n.trim()&&(await i.textMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,text:n.trim()},!1),n=""),h==="audio"?await i.audioWhatsapp({number:e.split("@")[0],delay:s?.delayMessage||1e3,audio:g,caption:l}):await i.mediaMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,mediatype:h,media:g,caption:l},!1)):n+=`[${l}](${g})`,r=o.lastIndex}if(r<t.length){let u=t.slice(r);u.trim()&&(n+=u)}n.trim()&&await i.textMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,text:n.trim()},!1),B("/message/sendText")}async initNewSession(i,e,t,s,o,n,r){let a=await this.createNewSession(i,{remoteJid:e,pushName:r,botId:t.id});a.session&&(o=a.session),await this.sendMessageToBot(i,o,s,t,e,r,n)}async processDify(i,e,t,s,o,n,r){if(!(s&&s.status!=="opened")){if(s&&o.expire&&o.expire>0){let a=Date.now(),c=new Date(s.updatedAt).getTime(),u=a-c;if(Math.floor(u/1e3/60)>o.expire){o.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:t.id,remoteJid:e}}),await this.initNewSession(i,e,t,o,s,n,r);return}}if(!s){await this.initNewSession(i,e,t,o,s,n,r);return}if(await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"opened",awaitUser:!1}}),!n){o.unknownMessage&&(this.waMonitor.waInstances[i.instanceName].textMessage({number:e.split("@")[0],delay:o.delayMessage||1e3,text:o.unknownMessage},!1),B("/message/sendText"));return}if(o.keywordFinish&&n.toLowerCase()===o.keywordFinish.toLowerCase()){o.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:t.id,remoteJid:e}});return}await this.sendMessageToBot(i,s,o,t,e,r,n)}}};var Ci=v(require("axios")),Aa=require("baileys"),Ra=v(require("form-data")),Tt=v(require("openai")),Oa=v(require("pino")),st=class{constructor(i,e,t){this.waMonitor=i;this.configService=e;this.prismaRepository=t;this.logger=new E("OpenaiService")}async sendMessageToBot(i,e,t,s){let n=e.systemMessages.map(y=>({role:"system",content:y})),a=e.assistantMessages.map(y=>({role:"assistant",content:y})),u=e.userMessages.map(y=>({role:"user",content:y})),d={role:"user",content:[{type:"text",text:s}]};if(this.isImageMessage(s)){let y=s.split("|"),f=y[1].split("?")[0];d.content=[{type:"text",text:y[2]||s},{type:"image_url",image_url:{url:f}}]}let l=[...n,...a,...u,d];i.integration===D.WHATSAPP_BAILEYS&&(await i.client.presenceSubscribe(t),await i.client.sendPresenceUpdate("composing",t));let g=await this.client.chat.completions.create({model:e.model,messages:l,max_tokens:e.maxTokens});return i.integration===D.WHATSAPP_BAILEYS&&await i.client.sendPresenceUpdate("paused",t),g.choices[0].message.content}async sendMessageToAssistant(i,e,t,s,o,n,r){let a={role:o?"assistant":"user",content:[{type:"text",text:n}]};if(this.isImageMessage(n)){let l=n.split("|"),g=l[1].split("?")[0];a.content=[{type:"text",text:l[2]||n},{type:"image_url",image_url:{url:g}}]}if(await this.client.beta.threads.messages.create(r,a),o){B("/message/sendText");return}let c=await this.client.beta.threads.runs.create(r,{assistant_id:e.assistantId});i.integration===D.WHATSAPP_BAILEYS&&(await i.client.presenceSubscribe(t),await i.client.sendPresenceUpdate("composing",t));let u=await this.getAIResponse(r,c.id,e.functionUrl,t,s);return i.integration===D.WHATSAPP_BAILEYS&&await i.client.sendPresenceUpdate("paused",t),u?.data[0].content[0].text.value}async sendMessageWhatsapp(i,e,t,s,o){let n=/(!?)\[(.*?)\]\((.*?)\)/g,r="",a=0,c,u=d=>{let l=d.split(".").pop()?.toLowerCase(),g=["jpg","jpeg","png","gif","bmp","webp"],h=["mp3","wav","aac","ogg"],y=["mp4","avi","mkv","mov"],f=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return g.includes(l||"")?"image":h.includes(l||"")?"audio":y.includes(l||"")?"video":f.includes(l||"")?"document":null};for(;(c=n.exec(o))!==null;){let[d,l,g,h]=c,y=u(h),f=o.slice(a,c.index);f&&(r+=f),y?(r.trim()&&(await i.textMessage({number:t.split("@")[0],delay:s?.delayMessage||1e3,text:r.trim()},!1),r=""),y==="audio"?await i.audioWhatsapp({number:t.split("@")[0],delay:s?.delayMessage||1e3,audio:h,caption:g}):await i.mediaMessage({number:t.split("@")[0],delay:s?.delayMessage||1e3,mediatype:y,media:h,caption:g},!1)):r+=`[${g}](${h})`,a=n.lastIndex}if(a<o.length){let d=o.slice(a);d.trim()&&(r+=d)}r.trim()&&await i.textMessage({number:t.split("@")[0],delay:s?.delayMessage||1e3,text:r.trim()},!1),B("/message/sendText"),await this.prismaRepository.integrationSession.update({where:{id:e.id},data:{status:"opened",awaitUser:!0}})}async createAssistantNewSession(i,e){if(e.remoteJid==="status@broadcast")return;let t=await this.prismaRepository.openaiCreds.findFirst({where:{id:e.openaiCredsId}});if(!t)throw new Error("Openai Creds not found");try{this.client=new Tt.default({apiKey:t.apiKey});let s=(await this.client.beta.threads.create({})).id,o=null;return s&&(o=await this.prismaRepository.integrationSession.create({data:{remoteJid:e.remoteJid,pushName:e.pushName,sessionId:s,status:"opened",awaitUser:!1,botId:e.botId,instanceId:i.instanceId,type:"openai"}})),{session:o}}catch(s){this.logger.error(s);return}}async initAssistantNewSession(i,e,t,s,o,n,r,a){let c=await this.createAssistantNewSession(i,{remoteJid:e,pushName:t,openaiCredsId:o.openaiCredsId,botId:o.id});c.session&&(r=c.session);let u=await this.sendMessageToAssistant(i,o,e,t,s,a,r.sessionId);await this.sendMessageWhatsapp(i,r,e,n,u)}isJSON(i){try{return JSON.parse(i),!0}catch{return!1}}async getAIResponse(i,e,t,s,o){let n=await this.client.beta.threads.runs.retrieve(i,e),r;switch(n.status){case"requires_action":if(r=n?.required_action?.submit_tool_outputs?.tool_calls,r)for(let a of r){let c=a.id,u=a?.function?.name,d=this.isJSON(a?.function?.arguments)?JSON.parse(a?.function?.arguments):a?.function?.arguments,l=null;try{let{data:g}=await Ci.default.post(t,{name:u,arguments:{...d,remoteJid:s,pushName:o}});l=JSON.stringify(g).replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")}catch(g){l=JSON.stringify(g).replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")}await this.client.beta.threads.runs.submitToolOutputs(i,e,{tool_outputs:[{tool_call_id:c,output:l}]})}return this.getAIResponse(i,e,t,s,o);case"queued":return await new Promise(a=>setTimeout(a,1e3)),this.getAIResponse(i,e,t,s,o);case"in_progress":return await new Promise(a=>setTimeout(a,1e3)),this.getAIResponse(i,e,t,s,o);case"completed":return await this.client.beta.threads.messages.list(i,{run_id:e,limit:1})}}isImageMessage(i){return i.includes("imageMessage")}async processOpenaiAssistant(i,e,t,s,o,n,r,a){if(n&&n.status==="closed")return;if(n&&r.expire&&r.expire>0){let l=Date.now(),g=new Date(n.updatedAt).getTime(),h=l-g;if(Math.floor(h/1e3/60)>r.expire){r.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:o.id,remoteJid:e}}),await this.initAssistantNewSession(i,e,t,s,o,r,n,a);return}}if(!n){await this.initAssistantNewSession(i,e,t,s,o,r,n,a);return}if(n.status!=="paused"&&await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"opened",awaitUser:!1}}),!a){r.unknownMessage&&(this.waMonitor.waInstances[i.instanceName].textMessage({number:e.split("@")[0],delay:r.delayMessage||1e3,text:r.unknownMessage},!1),B("/message/sendText"));return}if(r.keywordFinish&&a.toLowerCase()===r.keywordFinish.toLowerCase()){r.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:o.id,remoteJid:e}});return}let c=await this.prismaRepository.openaiCreds.findFirst({where:{id:o.openaiCredsId}});if(!c)throw new Error("Openai Creds not found");this.client=new Tt.default({apiKey:c.apiKey});let u=n.sessionId,d=await this.sendMessageToAssistant(i,o,e,t,s,a,u);await this.sendMessageWhatsapp(i,n,e,r,d)}async createChatCompletionNewSession(i,e){if(e.remoteJid==="status@broadcast")return;let t=Math.floor(Math.random()*1e10).toString(),s=await this.prismaRepository.openaiCreds.findFirst({where:{id:e.openaiCredsId}});if(!s)throw new Error("Openai Creds not found");try{return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:e.remoteJid,pushName:e.pushName,sessionId:t,status:"opened",awaitUser:!1,botId:e.botId,instanceId:i.instanceId,type:"openai"}}),creds:s}}catch(o){this.logger.error(o);return}}async initChatCompletionNewSession(i,e,t,s,o,n,r){let a=await this.createChatCompletionNewSession(i,{remoteJid:e,pushName:t,openaiCredsId:s.openaiCredsId,botId:s.id});n=a.session;let c=a.creds;this.client=new Tt.default({apiKey:c.apiKey});let u=await this.sendMessageToBot(i,s,e,r);await this.sendMessageWhatsapp(i,n,e,o,u)}async processOpenaiChatCompletion(i,e,t,s,o,n,r){if(o&&o.status!=="opened")return;if(o&&n.expire&&n.expire>0){let u=Date.now(),d=new Date(o.updatedAt).getTime(),l=u-d;if(Math.floor(l/1e3/60)>n.expire){n.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:s.id,remoteJid:e}}),await this.initChatCompletionNewSession(i,e,t,s,n,o,r);return}}if(!o){await this.initChatCompletionNewSession(i,e,t,s,n,o,r);return}if(await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"opened",awaitUser:!1}}),!r){n.unknownMessage&&(this.waMonitor.waInstances[i.instanceName].textMessage({number:e.split("@")[0],delay:n.delayMessage||1e3,text:n.unknownMessage},!1),B("/message/sendText"));return}if(n.keywordFinish&&r.toLowerCase()===n.keywordFinish.toLowerCase()){n.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:o.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:s.id,remoteJid:e}});return}let a=await this.prismaRepository.openaiCreds.findFirst({where:{id:s.openaiCredsId}});if(!a)throw new Error("Openai Creds not found");this.client=new Tt.default({apiKey:a.apiKey});let c=await this.sendMessageToBot(i,s,e,r);await this.sendMessageWhatsapp(i,o,e,n,c)}async speechToText(i,e,t){let s;e?.message?.mediaUrl?s=await Ci.default.get(e.message.mediaUrl,{responseType:"arraybuffer"}).then(a=>Buffer.from(a.data,"binary")):s=await(0,Aa.downloadMediaMessage)({key:e.key,message:e?.message},"buffer",{},{logger:(0,Oa.default)({level:"error"}),reuploadRequest:t});let o=this.configService.get("LANGUAGE").includes("pt")?"pt":this.configService.get("LANGUAGE"),n=new Ra.default;return n.append("file",s,"audio.ogg"),n.append("model","whisper-1"),n.append("language",o),(await Ci.default.post("https://api.openai.com/v1/audio/transcriptions",n,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${i.apiKey}`}}))?.data?.text}};var Uc=p=>{let i;M.get("S3").ENABLE?i=p.message.mediaUrl:i=p.key.id;let e={conversation:p?.message?.conversation,extendedTextMessage:p?.message?.extendedTextMessage?.text,contactMessage:p?.message?.contactMessage?.displayName,locationMessage:p?.message?.locationMessage?.degreesLatitude,viewOnceMessageV2:p?.message?.viewOnceMessageV2?.message?.imageMessage?.url||p?.message?.viewOnceMessageV2?.message?.videoMessage?.url||p?.message?.viewOnceMessageV2?.message?.audioMessage?.url,listResponseMessage:p?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,responseRowId:p?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,audioMessage:p?.message?.speechToText?p?.message?.speechToText:p?.message?.audioMessage?`audioMessage|${i}`:void 0,imageMessage:p?.message?.imageMessage?`imageMessage|${i}${p?.message?.imageMessage?.caption?`|${p?.message?.imageMessage?.caption}`:""}`:void 0,videoMessage:p?.message?.videoMessage?`videoMessage|${i}${p?.message?.videoMessage?.caption?`|${p?.message?.videoMessage?.caption}`:""}`:void 0,documentMessage:p?.message?.documentMessage?`documentMessage|${i}${p?.message?.documentMessage?.caption?`|${p?.message?.documentMessage?.caption}`:""}`:void 0,documentWithCaptionMessage:p?.message?.documentWithCaptionMessage?.message?.documentMessage?`documentWithCaptionMessage|${i}${p?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption?`|${p?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption}`:""}`:void 0,externalAdReplyBody:p?.contextInfo?.externalAdReply?.body?`externalAdReplyBody|${p.contextInfo.externalAdReply.body}`:void 0},t=Object.keys(e).find(s=>e[s]!==void 0)||"unknown";return{...e,messageType:t}},Jc=p=>{let i=Object.keys(p).find(t=>t!=="externalAdReplyBody"&&p[t]!==void 0),e=i?p[i]:void 0;return p.externalAdReplyBody&&(e=e?`${e}
${p.externalAdReplyBody}`:p.externalAdReplyBody),e},re=p=>{let i=Uc(p);return Jc(i)};var Ct=v(require("axios")),it=class{constructor(i,e,t){this.waMonitor=i;this.configService=e;this.prismaRepository=t;this.logger=new E("TypebotService")}async createNewSession(i,e){if(e.remoteJid==="status@broadcast")return;let t=Math.floor(Math.random()*1e10).toString();try{let s=this.configService.get("TYPEBOT").API_VERSION,o,n;s==="latest"?(o=`${e.url}/api/v1/typebots/${e.typebot}/startChat`,n={prefilledVariables:{...e.prefilledVariables,remoteJid:e.remoteJid,pushName:e.pushName||e.prefilledVariables?.pushName||"",instanceName:i.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:i.number}}):(o=`${e.url}/api/v1/sendMessage`,n={startParams:{publicId:e.typebot,prefilledVariables:{...e.prefilledVariables,remoteJid:e.remoteJid,pushName:e.pushName||e.prefilledVariables?.pushName||"",instanceName:i.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:i.number}}});let r=await Ct.default.post(o,n),a=null;return r?.data?.sessionId&&(a=await this.prismaRepository.integrationSession.create({data:{remoteJid:e.remoteJid,pushName:e.pushName||"",sessionId:`${t}-${r.data.sessionId}`,status:"opened",parameters:{...e.prefilledVariables,remoteJid:e.remoteJid,pushName:e.pushName||"",instanceName:i.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:i.number},awaitUser:!1,botId:e.botId,instanceId:i.id,type:"typebot"}})),{...r.data,session:a}}catch(s){this.logger.error(s);return}}async sendWAMessage(i,e,t,s,o,n,r){u(this.waMonitor.waInstances[i.name],e,t,o,n,r,c,this.prismaRepository).catch(d=>{console.error("Erro ao processar mensagens:",d)});function a(d,l){if(!d)return null;for(let g of d)if(g.lastBubbleBlockId===l)return g.wait?.secondsToWaitFor;return null}function c(d){let l="";if(d.text&&(l+=d.text),d.children&&d.type!=="a")for(let y of d.children)l+=c(y);d.type==="p"&&d.type!=="inline-variable"&&(l=l.trim()+`
`),d.type==="inline-variable"&&(l=l.trim()),d.type==="ol"&&(l=`
`+l.split(`
`).map((y,f)=>y?`${f+1}. ${y}`:"").join(`
`)),d.type==="li"&&(l=l.split(`
`).map(y=>y?`  ${y}`:"").join(`
`));let g="";d.bold&&(g+="*"),d.italic&&(g+="_"),d.underline&&(g+="~");let h=`${g}${l}${g.split("").reverse().join("")}`;return d.url&&(h=d.children[0]?.text?`[${h}]
(${d.url})`:`${d.url}`),h}async function u(d,l,g,h,y,f,w,I){for(let b of h){if(b.type==="text"){let C="";for(let P of b.content.richText){for(let L of P.children)C+=w(L);C+=`
`}C=C.replace(/\*\*/g,"").replace(/__/,"").replace(/~~/,"").replace(/\n$/,""),C=C.replace(/\n$/,""),await d.textMessage({number:s.split("@")[0],delay:g?.delayMessage||1e3,text:C},!1),B("/message/sendText")}b.type==="image"&&(await d.mediaMessage({number:s.split("@")[0],delay:g?.delayMessage||1e3,mediatype:"image",media:b.content.url},!1),B("/message/sendMedia")),b.type==="video"&&(await d.mediaMessage({number:s.split("@")[0],delay:g?.delayMessage||1e3,mediatype:"video",media:b.content.url},!1),B("/message/sendMedia")),b.type==="audio"&&(await d.audioWhatsapp({number:s.split("@")[0],delay:g?.delayMessage||1e3,encoding:!0,audio:b.content.url},!1),B("/message/sendWhatsAppAudio"));let S=a(f,b.id);S&&await new Promise(C=>setTimeout(C,S*1e3))}if(y){if(y.type==="choice input"){let b="",S=y.items;for(let C of S)b+=`\u25B6\uFE0F ${C.content}
`;b=b.replace(/\n$/,""),await d.textMessage({number:s.split("@")[0],delay:g?.delayMessage||1e3,text:b},!1),B("/message/sendText")}await I.integrationSession.update({where:{id:l.id},data:{awaitUser:!0}})}else g?.keepOpen?await I.integrationSession.update({where:{id:l.id},data:{status:"closed"}}):await I.integrationSession.deleteMany({where:{id:l.id}})}}async processTypebot(i,e,t,s,o,n,r,a,c,u,d,l,g,h,y){if(s&&r&&r>0){let S=Date.now(),C=new Date(s.updatedAt).getTime(),P=S-C;if(Math.floor(P/1e3/60)>r){h?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:o.id,remoteJid:e}});let W=await this.createNewSession(i,{enabled:o?.enabled,url:n,typebot:a,expire:r,keywordFinish:c,delayMessage:u,unknownMessage:d,listeningFromMe:l,remoteJid:e,pushName:t.pushName,botId:o.id});if(W.session&&(s=W.session),await this.sendWAMessage(i,s,{expire:r,keywordFinish:c,delayMessage:u,unknownMessage:d,listeningFromMe:l,stopBotFromMe:g,keepOpen:h},e,W.messages,W.input,W.clientSideActions),W.messages.length===0){let Me=re(t.message);if(!Me){d&&(this.waMonitor.waInstances[i.name].textMessage({number:e.split("@")[0],delay:u||1e3,text:d},!1),B("/message/sendText"));return}if(c&&Me.toLowerCase()===c.toLowerCase()){h?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:o.id,remoteJid:e}});return}try{let ke=this.configService.get("TYPEBOT").API_VERSION,Te,de;ke==="latest"?(Te=`${n}/api/v1/sessions/${W.sessionId}/continueChat`,de={message:Me}):(Te=`${n}/api/v1/sendMessage`,de={message:Me,sessionId:W.sessionId});let Ge=await Ct.default.post(Te,de);await this.sendWAMessage(i,s,{expire:r,keywordFinish:c,delayMessage:u,unknownMessage:d,listeningFromMe:l,stopBotFromMe:g,keepOpen:h},e,Ge.data.messages,Ge.data.input,Ge.data.clientSideActions)}catch(ke){this.logger.error(ke);return}}return}}if(s&&s.status!=="opened")return;if(!s){let S=await this.createNewSession(i,{enabled:o?.enabled,url:n,typebot:a,expire:r,keywordFinish:c,delayMessage:u,unknownMessage:d,listeningFromMe:l,remoteJid:e,pushName:t.pushName,botId:o.id});if(S?.session&&(s=S.session),await this.sendWAMessage(i,s,{expire:r,keywordFinish:c,delayMessage:u,unknownMessage:d,listeningFromMe:l,stopBotFromMe:g,keepOpen:h},e,S?.messages,S?.input,S?.clientSideActions),S.messages.length===0){if(!y){d&&(this.waMonitor.waInstances[i.name].textMessage({number:e.split("@")[0],delay:u||1e3,text:d},!1),B("/message/sendText"));return}if(c&&y.toLowerCase()===c.toLowerCase()){h?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:o.id,remoteJid:e}});return}let C;try{let P=this.configService.get("TYPEBOT").API_VERSION,L,W;P==="latest"?(L=`${n}/api/v1/sessions/${S.sessionId}/continueChat`,W={message:y}):(L=`${n}/api/v1/sendMessage`,W={message:y,sessionId:S.sessionId}),C=await Ct.default.post(L,W),await this.sendWAMessage(i,s,{expire:r,keywordFinish:c,delayMessage:u,unknownMessage:d,listeningFromMe:l,stopBotFromMe:g,keepOpen:h},e,C.data.messages,C.data.input,C.data.clientSideActions)}catch(P){this.logger.error(P);return}}return}if(await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"opened",awaitUser:!1}}),!y){d&&(this.waMonitor.waInstances[i.name].textMessage({number:e.split("@")[0],delay:u||1e3,text:d},!1),B("/message/sendText"));return}if(c&&y.toLowerCase()===c.toLowerCase()){h?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:o.id,remoteJid:e}});return}let f=this.configService.get("TYPEBOT").API_VERSION,w,I;f==="latest"?(w=`${n}/api/v1/sessions/${s.sessionId.split("-")[1]}/continueChat`,I={message:y}):(w=`${n}/api/v1/sendMessage`,I={message:y,sessionId:s.sessionId.split("-")[1]});let b=await Ct.default.post(w,I);await this.sendWAMessage(i,s,{expire:r,keywordFinish:c,delayMessage:u,unknownMessage:d,listeningFromMe:l,stopBotFromMe:g,keepOpen:h},e,b?.data?.messages,b?.data?.input,b?.data?.clientSideActions)}};var Un=require("uuid"),Re=class p{constructor(i,e,t,s){this.configService=i;this.eventEmitter=e;this.prismaRepository=t;this.chatwootCache=s;this.logger=new E("ChannelStartupService");this.instance={};this.localChatwoot={};this.localProxy={};this.localSettings={};this.chatwootService=new ye(x,this.configService,this.prismaRepository,this.chatwootCache);this.typebotService=new it(x,this.configService,this.prismaRepository);this.openaiService=new st(x,this.configService,this.prismaRepository);this.difyService=new tt(x,this.configService,this.prismaRepository)}setInstance(i){this.logger.setInstance(i.instanceName),this.instance.name=i.instanceName,this.instance.id=i.instanceId,this.instance.integration=i.integration,this.instance.number=i.number,this.instance.token=i.token,this.instance.businessId=i.businessId,this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("status.instance",{instanceName:this.instance.name},{instance:this.instance.name,status:"created"})}set instanceName(i){if(this.logger.setInstance(i),!i){this.instance.name=(0,Un.v4)();return}this.instance.name=i}get instanceName(){return this.instance.name}set instanceId(i){if(!i){this.instance.id=(0,Un.v4)();return}this.instance.id=i}get instanceId(){return this.instance.id}set integration(i){this.instance.integration=i}get integration(){return this.instance.integration}set number(i){this.instance.number=i}get number(){return this.instance.number}set token(i){this.instance.token=i}get token(){return this.instance.token}get wuid(){return this.instance.wuid}async loadSettings(){let i=await this.prismaRepository.setting.findUnique({where:{instanceId:this.instanceId}});this.localSettings.rejectCall=i?.rejectCall,this.localSettings.msgCall=i?.msgCall,this.localSettings.groupsIgnore=i?.groupsIgnore,this.localSettings.alwaysOnline=i?.alwaysOnline,this.localSettings.readMessages=i?.readMessages,this.localSettings.readStatus=i?.readStatus,this.localSettings.syncFullHistory=i?.syncFullHistory}async setSettings(i){await this.prismaRepository.setting.upsert({where:{instanceId:this.instanceId},update:{rejectCall:i.rejectCall,msgCall:i.msgCall,groupsIgnore:i.groupsIgnore,alwaysOnline:i.alwaysOnline,readMessages:i.readMessages,readStatus:i.readStatus,syncFullHistory:i.syncFullHistory},create:{rejectCall:i.rejectCall,msgCall:i.msgCall,groupsIgnore:i.groupsIgnore,alwaysOnline:i.alwaysOnline,readMessages:i.readMessages,readStatus:i.readStatus,syncFullHistory:i.syncFullHistory,instanceId:this.instanceId}}),this.localSettings.rejectCall=i?.rejectCall,this.localSettings.msgCall=i?.msgCall,this.localSettings.groupsIgnore=i?.groupsIgnore,this.localSettings.alwaysOnline=i?.alwaysOnline,this.localSettings.readMessages=i?.readMessages,this.localSettings.readStatus=i?.readStatus,this.localSettings.syncFullHistory=i?.syncFullHistory}async findSettings(){let i=await this.prismaRepository.setting.findUnique({where:{instanceId:this.instanceId}});return i?{rejectCall:i.rejectCall,msgCall:i.msgCall,groupsIgnore:i.groupsIgnore,alwaysOnline:i.alwaysOnline,readMessages:i.readMessages,readStatus:i.readStatus,syncFullHistory:i.syncFullHistory}:null}async loadChatwoot(){if(!this.configService.get("CHATWOOT").ENABLED)return;let i=await this.prismaRepository.chatwoot.findUnique({where:{instanceId:this.instanceId}});this.localChatwoot.enabled=i?.enabled,this.localChatwoot.accountId=i?.accountId,this.localChatwoot.token=i?.token,this.localChatwoot.url=i?.url,this.localChatwoot.nameInbox=i?.nameInbox,this.localChatwoot.signMsg=i?.signMsg,this.localChatwoot.signDelimiter=i?.signDelimiter,this.localChatwoot.number=i?.number,this.localChatwoot.reopenConversation=i?.reopenConversation,this.localChatwoot.conversationPending=i?.conversationPending,this.localChatwoot.mergeBrazilContacts=i?.mergeBrazilContacts,this.localChatwoot.importContacts=i?.importContacts,this.localChatwoot.importMessages=i?.importMessages,this.localChatwoot.daysLimitImportMessages=i?.daysLimitImportMessages}async setChatwoot(i){if(!this.configService.get("CHATWOOT").ENABLED)return;if(await this.prismaRepository.chatwoot.findUnique({where:{instanceId:this.instanceId}})){await this.prismaRepository.chatwoot.update({where:{instanceId:this.instanceId},data:{enabled:i?.enabled,accountId:i.accountId,token:i.token,url:i.url,nameInbox:i.nameInbox,signMsg:i.signMsg,signDelimiter:i.signMsg?i.signDelimiter:null,number:i.number,reopenConversation:i.reopenConversation,conversationPending:i.conversationPending,mergeBrazilContacts:i.mergeBrazilContacts,importContacts:i.importContacts,importMessages:i.importMessages,daysLimitImportMessages:i.daysLimitImportMessages,organization:i.organization,logo:i.logo,ignoreJids:i.ignoreJids}}),Object.assign(this.localChatwoot,{...i,signDelimiter:i.signMsg?i.signDelimiter:null}),this.clearCacheChatwoot();return}await this.prismaRepository.chatwoot.create({data:{enabled:i?.enabled,accountId:i.accountId,token:i.token,url:i.url,nameInbox:i.nameInbox,signMsg:i.signMsg,number:i.number,reopenConversation:i.reopenConversation,conversationPending:i.conversationPending,mergeBrazilContacts:i.mergeBrazilContacts,importContacts:i.importContacts,importMessages:i.importMessages,daysLimitImportMessages:i.daysLimitImportMessages,organization:i.organization,logo:i.logo,ignoreJids:i.ignoreJids,instanceId:this.instanceId}}),Object.assign(this.localChatwoot,{...i,signDelimiter:i.signMsg?i.signDelimiter:null}),this.clearCacheChatwoot()}async findChatwoot(){if(!this.configService.get("CHATWOOT").ENABLED)return null;let i=await this.prismaRepository.chatwoot.findUnique({where:{instanceId:this.instanceId}});if(!i)return null;let e=Array.isArray(i.ignoreJids)?i.ignoreJids.map(t=>String(t)):[];return{enabled:i?.enabled,accountId:i.accountId,token:i.token,url:i.url,nameInbox:i.nameInbox,signMsg:i.signMsg,signDelimiter:i.signDelimiter||null,reopenConversation:i.reopenConversation,conversationPending:i.conversationPending,mergeBrazilContacts:i.mergeBrazilContacts,importContacts:i.importContacts,importMessages:i.importMessages,daysLimitImportMessages:i.daysLimitImportMessages,organization:i.organization,logo:i.logo,ignoreJids:e}}clearCacheChatwoot(){this.localChatwoot?.enabled&&this.chatwootService.getCache()?.deleteAll(this.instanceName)}async loadProxy(){this.localProxy.enabled=!1,process.env.PROXY_HOST&&(this.localProxy.enabled=!0,this.localProxy.host=process.env.PROXY_HOST,this.localProxy.port=process.env.PROXY_PORT||"80",this.localProxy.protocol=process.env.PROXY_PROTOCOL||"http",this.localProxy.username=process.env.PROXY_USERNAME,this.localProxy.password=process.env.PROXY_PASSWORD);let i=await this.prismaRepository.proxy.findUnique({where:{instanceId:this.instanceId}});i?.enabled&&(this.localProxy.enabled=!0,this.localProxy.host=i?.host,this.localProxy.port=i?.port,this.localProxy.protocol=i?.protocol,this.localProxy.username=i?.username,this.localProxy.password=i?.password)}async setProxy(i){await this.prismaRepository.proxy.upsert({where:{instanceId:this.instanceId},update:{enabled:i?.enabled,host:i.host,port:i.port,protocol:i.protocol,username:i.username,password:i.password},create:{enabled:i?.enabled,host:i.host,port:i.port,protocol:i.protocol,username:i.username,password:i.password,instanceId:this.instanceId}}),Object.assign(this.localProxy,i)}async findProxy(){let i=await this.prismaRepository.proxy.findUnique({where:{instanceId:this.instanceId}});if(!i)throw new _("Proxy not found");return i}async sendDataWebhook(i,e,t=!0){let s=this.configService.get("SERVER").URL,o=new Date().getTimezoneOffset()*6e4,r=new Date(Date.now()-o).toISOString(),a=this.configService.get("AUTHENTICATION").EXPOSE_IN_FETCH_INSTANCES,c=this.token||"Apikey not found";await G.emit({instanceName:this.instance.name,origin:p.name,event:i,data:e,serverUrl:s,dateTime:r,sender:this.wuid,apiKey:a&&c?c:null,local:t})}formatMXOrARNumber(i){let e=i.substring(0,2);return(Number(e)===52||Number(e)===54)&&i.length===13?e+i.substring(3):i}formatBRNumber(i){let e=new RegExp(/^(\d{2})(\d{2})\d{1}(\d{8})$/);if(e.test(i)){let t=e.exec(i);if(t&&t[1]==="55"){let s=Number.parseInt(t[3][0]),o=Number.parseInt(t[2]);return s<7||o<31?t[0]:t[1]+t[2]+t[3]}return i}else return i}createJid(i){return i.includes("@g.us")||i.includes("@s.whatsapp.net")||i.includes("@lid")||i.includes("@broadcast")?i:(i=i?.replace(/\s/g,"").replace(/\+/g,"").replace(/\(/g,"").replace(/\)/g,"").split(":")[0].split("@")[0],i.includes("-")&&i.length>=24?(i=i.replace(/[^\d-]/g,""),`${i}@g.us`):(i=i.replace(/\D/g,""),i.length>=18?(i=i.replace(/[^\d-]/g,""),`${i}@g.us`):(i=this.formatMXOrARNumber(i),i=this.formatBRNumber(i),`${i}@s.whatsapp.net`)))}async fetchContacts(i){let e=i?.where?.remoteJid?i?.where?.remoteJid.includes("@")?i.where?.remoteJid:this.createJid(i.where?.remoteJid):null,t={instanceId:this.instanceId};return e&&(t.remoteJid=e),await this.prismaRepository.contact.findMany({where:t})}async fetchMessages(i){let e=i?.where?.key,t=await this.prismaRepository.message.count({where:{instanceId:this.instanceId,id:i?.where?.id,source:i?.where?.source,messageType:i?.where?.messageType,AND:[e?.id?{key:{path:["id"],equals:e?.id}}:{},e?.fromMe?{key:{path:["fromMe"],equals:e?.fromMe}}:{},e?.remoteJid?{key:{path:["remoteJid"],equals:e?.remoteJid}}:{},e?.participants?{key:{path:["participants"],equals:e?.participants}}:{}]}});i?.offset||(i.offset=50),i?.page||(i.page=1);let s=await this.prismaRepository.message.findMany({where:{instanceId:this.instanceId,id:i?.where?.id,source:i?.where?.source,messageType:i?.where?.messageType,AND:[e?.id?{key:{path:["id"],equals:e?.id}}:{},e?.fromMe?{key:{path:["fromMe"],equals:e?.fromMe}}:{},e?.remoteJid?{key:{path:["remoteJid"],equals:e?.remoteJid}}:{},e?.participants?{key:{path:["participants"],equals:e?.participants}}:{}]},orderBy:{messageTimestamp:"desc"},skip:i.offset*(i?.page===1?0:i?.page-1),take:i.offset,select:{id:!0,key:!0,pushName:!0,messageType:!0,message:!0,messageTimestamp:!0,instanceId:!0,source:!0,MessageUpdate:{select:{status:!0}}}});return{messages:{total:t,pages:Math.ceil(t/i.offset),currentPage:i.page,records:s}}}async fetchStatusMessage(i){return await this.prismaRepository.messageUpdate.findMany({where:{instanceId:this.instanceId,remoteJid:i.where?.remoteJid,messageId:i.where?.id},skip:i.offset*(i?.page===1?0:i?.page-1),take:i.offset})}async fetchChats(i){let e=i?.where?.remoteJid?i?.where?.remoteJid.includes("@")?i.where?.remoteJid:this.createJid(i.where?.remoteJid):null,t;return e?t=await this.prismaRepository.$queryRaw`
            SELECT
                "Chat"."id",
                "Chat"."remoteJid",
                "Chat"."name",
                "Chat"."labels",
                "Chat"."createdAt",
                "Chat"."updatedAt",
                "Contact"."pushName",
                "Contact"."profilePicUrl"
            FROM "Chat"
            INNER JOIN "Message" ON "Chat"."remoteJid" = "Message"."key"->>'remoteJid'
            LEFT JOIN "Contact" ON "Chat"."remoteJid" = "Contact"."remoteJid"
            WHERE "Chat"."instanceId" = ${this.instanceId}
            AND "Chat"."remoteJid" = ${e}
            GROUP BY
                "Chat"."id",
                "Chat"."remoteJid",
                "Chat"."name",
                "Chat"."labels",
                "Chat"."createdAt",
                "Chat"."updatedAt",
                "Contact"."pushName",
                "Contact"."profilePicUrl"
            ORDER BY "Chat"."updatedAt" DESC;
        `:t=await this.prismaRepository.$queryRaw`
            SELECT
                "Chat"."id",
                "Chat"."remoteJid",
                "Chat"."name",
                "Chat"."labels",
                "Chat"."createdAt",
                "Chat"."updatedAt",
                "Contact"."pushName",
                "Contact"."profilePicUrl"
            FROM "Chat"
            INNER JOIN "Message" ON "Chat"."remoteJid" = "Message"."key"->>'remoteJid'
            LEFT JOIN "Contact" ON "Chat"."remoteJid" = "Contact"."remoteJid"
            WHERE "Chat"."instanceId" = ${this.instanceId}
            GROUP BY
                "Chat"."id",
                "Chat"."remoteJid",
                "Chat"."name",
                "Chat"."labels",
                "Chat"."createdAt",
                "Chat"."updatedAt",
                "Contact"."pushName",
                "Contact"."profilePicUrl"
            ORDER BY "Chat"."updatedAt" DESC;
        `,t}};var Jn=require("class-validator"),vt=v(require("mime")),Wn=require("uuid"),vi=class extends Re{constructor(e,t,s,o,n,r,a){super(e,t,s,n);this.configService=e;this.eventEmitter=t;this.prismaRepository=s;this.cache=o;this.chatwootCache=n;this.baileysCache=r;this.providerFiles=a;this.stateConnection={state:"open"};this.client=null}get connectionStatus(){return this.stateConnection}async closeClient(){this.stateConnection={state:"close"}}get qrCode(){return{pairingCode:this.instance.qrcode?.pairingCode,code:this.instance.qrcode?.code,base64:this.instance.qrcode?.base64,count:this.instance.qrcode?.count}}async logoutInstance(){await this.closeClient()}async profilePicture(e){return{wuid:this.createJid(e),profilePictureUrl:null}}async getProfileName(){return null}async profilePictureUrl(){return null}async getProfileStatus(){return null}async connectToWhatsapp(e){if(e)try{this.loadChatwoot(),this.eventHandler(e)}catch(t){throw this.logger.error(t),new N(t?.toString())}}async eventHandler(e){try{let t;if(e.message){if(t={key:{id:e.key.id||(0,Wn.v4)(),remoteJid:e.key.remoteJid,fromMe:e.key.fromMe},pushName:e.pushName,message:e.message,messageType:e.messageType,messageTimestamp:Math.round(new Date().getTime()/1e3),source:"unknown",instanceId:this.instanceId},this.configService.get("OPENAI").ENABLED){let o=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});o&&o.openaiCredsId&&o.speechToText&&e?.message?.audioMessage&&(t.message.speechToText=await this.openaiService.speechToText(o.OpenaiCreds,e,this.client.updateMediaMessage))}if(this.logger.log(t),this.sendDataWebhook("messages.upsert",t),await Ee.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:t.key.remoteJid,msg:t,pushName:t.pushName}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled){let o=await this.chatwootService.eventWhatsapp("messages.upsert",{instanceName:this.instance.name,instanceId:this.instanceId},t);o?.id&&(t.chatwootMessageId=o.id,t.chatwootInboxId=o.id,t.chatwootConversationId=o.id)}await this.prismaRepository.message.create({data:t}),await this.updateContact({remoteJid:t.key.remoteJid,pushName:t.pushName,profilePicUrl:e.profilePicUrl})}}catch(t){this.logger.error(t)}}async updateContact(e){let t=await this.prismaRepository.contact.findFirst({where:{instanceId:this.instanceId,remoteJid:e.remoteJid}});if(t){let r={remoteJid:e.remoteJid,pushName:e?.pushName,instanceId:this.instanceId,profilePicUrl:e?.profilePicUrl};this.sendDataWebhook("contacts.update",r),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&await this.chatwootService.eventWhatsapp("contacts.update",{instanceName:this.instance.name,instanceId:this.instanceId},r),await this.prismaRepository.contact.updateMany({where:{remoteJid:t.remoteJid,instanceId:this.instanceId},data:r});return}let s={remoteJid:e.remoteJid,pushName:e?.pushName,instanceId:this.instanceId,profilePicUrl:e?.profilePicUrl};this.sendDataWebhook("contacts.upsert",s),await this.prismaRepository.contact.create({data:s});let o=await this.prismaRepository.chat.findFirst({where:{instanceId:this.instanceId,remoteJid:e.remoteJid}});if(o){let r={remoteJid:e.remoteJid,instanceId:this.instanceId};this.sendDataWebhook("chats.update",r),await this.prismaRepository.chat.updateMany({where:{remoteJid:o.remoteJid},data:r})}let n={remoteJid:e.remoteJid,instanceId:this.instanceId};this.sendDataWebhook("chats.upsert",n),await this.prismaRepository.chat.create({data:n})}async sendMessageWithTyping(e,t,s,o=!1){try{let n,r;if(s?.quoted){let d=s?.quoted?.key;if(!d)throw"Message not found";n=d}s.delay&&await new Promise(u=>setTimeout(u,s.delay)),s?.webhookUrl&&(r=s.webhookUrl);let a=(0,Wn.v4)(),c;return t?.mediaType==="image"?c={key:{fromMe:!0,id:a,remoteJid:e},message:{mediaUrl:t.media,quoted:n},messageType:"imageMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:r,source:"unknown",instanceId:this.instanceId}:t?.mediaType==="video"?c={key:{fromMe:!0,id:a,remoteJid:e},message:{mediaUrl:t.media,quoted:n},messageType:"videoMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:r,source:"unknown",instanceId:this.instanceId}:t?.mediaType==="audio"?c={key:{fromMe:!0,id:a,remoteJid:e},message:{mediaUrl:t.media,quoted:n},messageType:"audioMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:r,source:"unknown",instanceId:this.instanceId}:t?.mediaType==="document"?c={key:{fromMe:!0,id:a,remoteJid:e},message:{mediaUrl:t.media,quoted:n},messageType:"documentMessage",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:r,source:"unknown",instanceId:this.instanceId}:c={key:{fromMe:!0,id:a,remoteJid:e},message:{...t,quoted:n},messageType:"conversation",messageTimestamp:Math.round(new Date().getTime()/1e3),webhookUrl:r,source:"unknown",instanceId:this.instanceId},this.logger.log(c),this.sendDataWebhook("send.message",c),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&!o&&this.chatwootService.eventWhatsapp("send.message",{instanceName:this.instance.name,instanceId:this.instanceId},c),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&o&&await Ee.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:c.key.remoteJid,msg:c,pushName:c.pushName}),await this.prismaRepository.message.create({data:c}),c}catch(n){throw this.logger.error(n),new m(n.toString())}}async textMessage(e,t=!1){return await this.sendMessageWithTyping(e.number,{conversation:e.text},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async prepareMediaMessage(e){try{if(e.mediatype==="document"&&!e.fileName){let n=new RegExp(/.*\/(.+?)\./).exec(e.media);e.fileName=n[1]}e.mediatype==="image"&&!e.fileName&&(e.fileName="image.png"),e.mediatype==="video"&&!e.fileName&&(e.fileName="video.mp4");let t,s={caption:e?.caption,fileName:e.fileName,mediaType:e.mediatype,media:e.media,gifPlayback:!1};return(0,Jn.isURL)(e.media)?t=vt.default.getType(e.media):t=vt.default.getType(e.fileName),s.mimetype=t,s}catch(t){throw this.logger.error(t),new N(t?.toString()||t)}}async mediaMessage(e,t=!1){let s=await this.prepareMediaMessage(e);return console.log("message",s),await this.sendMessageWithTyping(e.number,{...s},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async processAudio(e,t){t=t.replace(/\D/g,"");let s=`${t}-${new Date().getTime()}`,o,n={fileName:`${s}.mp4`,mediaType:"audio",media:e};return(0,Jn.isURL)(e)?o=vt.default.getType(e):o=vt.default.getType(n.fileName),n.mimetype=o,n}async audioWhatsapp(e,t=!1){let s=await this.processAudio(e.audio,e.number);return await this.sendMessageWithTyping(e.number,{...s},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async buttonMessage(){throw new m("Method not available on Evolution Channel")}async locationMessage(){throw new m("Method not available on Evolution Channel")}async listMessage(){throw new m("Method not available on Evolution Channel")}async templateMessage(){throw new m("Method not available on Evolution Channel")}async contactMessage(){throw new m("Method not available on Evolution Channel")}async reactionMessage(){throw new m("Method not available on Evolution Channel")}async getBase64FromMediaMessage(){throw new m("Method not available on Evolution Channel")}async deleteMessage(){throw new m("Method not available on Evolution Channel")}async mediaSticker(){throw new m("Method not available on Evolution Channel")}async pollMessage(){throw new m("Method not available on Evolution Channel")}async statusMessage(){throw new m("Method not available on Evolution Channel")}async reloadConnection(){throw new m("Method not available on Evolution Channel")}async whatsappNumber(){throw new m("Method not available on Evolution Channel")}async markMessageAsRead(){throw new m("Method not available on Evolution Channel")}async archiveChat(){throw new m("Method not available on Evolution Channel")}async markChatUnread(){throw new m("Method not available on Evolution Channel")}async fetchProfile(){throw new m("Method not available on Evolution Channel")}async sendPresence(){throw new m("Method not available on Evolution Channel")}async setPresence(){throw new m("Method not available on Evolution Channel")}async fetchPrivacySettings(){throw new m("Method not available on Evolution Channel")}async updatePrivacySettings(){throw new m("Method not available on Evolution Channel")}async fetchBusinessProfile(){throw new m("Method not available on Evolution Channel")}async updateProfileName(){throw new m("Method not available on Evolution Channel")}async updateProfileStatus(){throw new m("Method not available on Evolution Channel")}async updateProfilePicture(){throw new m("Method not available on Evolution Channel")}async removeProfilePicture(){throw new m("Method not available on Evolution Channel")}async blockUser(){throw new m("Method not available on Evolution Channel")}async updateMessage(){throw new m("Method not available on Evolution Channel")}async createGroup(){throw new m("Method not available on Evolution Channel")}async updateGroupPicture(){throw new m("Method not available on Evolution Channel")}async updateGroupSubject(){throw new m("Method not available on Evolution Channel")}async updateGroupDescription(){throw new m("Method not available on Evolution Channel")}async findGroup(){throw new m("Method not available on Evolution Channel")}async fetchAllGroups(){throw new m("Method not available on Evolution Channel")}async inviteCode(){throw new m("Method not available on Evolution Channel")}async inviteInfo(){throw new m("Method not available on Evolution Channel")}async sendInvite(){throw new m("Method not available on Evolution Channel")}async acceptInviteCode(){throw new m("Method not available on Evolution Channel")}async revokeInviteCode(){throw new m("Method not available on Evolution Channel")}async findParticipants(){throw new m("Method not available on Evolution Channel")}async updateGParticipant(){throw new m("Method not available on Evolution Channel")}async updateGSetting(){throw new m("Method not available on Evolution Channel")}async toggleEphemeral(){throw new m("Method not available on Evolution Channel")}async leaveGroup(){throw new m("Method not available on Evolution Channel")}async fetchLabels(){throw new m("Method not available on Evolution Channel")}async handleLabel(){throw new m("Method not available on Evolution Channel")}async receiveMobileCode(){throw new m("Method not available on Evolution Channel")}async fakeCall(){throw new m("Method not available on Evolution Channel")}};var xa=v(require("minio")),qn=require("path"),Ai=new E("S3 Service"),Le=new Pe().get("S3"),ue=(()=>{if(Le?.ENABLE)return new xa.Client({endPoint:Le.ENDPOINT,port:Le.PORT,useSSL:Le.USE_SSL,accessKey:Le.ACCESS_KEY,secretKey:Le.SECRET_KEY,region:Le.REGION})})(),Oe=process.env.S3_BUCKET,Wc=async()=>{if(ue)try{return(await ue.listBuckets()).find(i=>i.name===Oe)}catch{return!1}},qc=async()=>{if(ue){let p={Version:"2012-10-17",Statement:[{Effect:"Allow",Principal:"*",Action:["s3:GetObject"],Resource:[`arn:aws:s3:::${Oe}/*`]}]};await ue.setBucketPolicy(Oe,JSON.stringify(p))}},$c=async()=>{if(ue)try{return await Wc()||await ue.makeBucket(Oe),await qc(),Ai.info(`S3 Bucket ${Oe} - ON`),!0}catch(p){return Ai.error("S3 ERROR:"),Ai.error(p),!1}};$c();var At=async(p,i,e,t)=>{if(ue){let s=(0,qn.join)("evolution-api",p);try{return t["custom-header-application"]="evolution-api",await ue.putObject(Oe,s,i,e,t)}catch(o){return Ai.error(o),o}}},Ue=async(p,i)=>{if(ue)try{let e=(0,qn.join)("evolution-api",p);return i?await ue.presignedGetObject(Oe,e,i):await ue.presignedGetObject(Oe,e)}catch(e){throw new m(e?.message)}};var xe=v(require("axios")),Je=require("class-validator"),Na=v(require("form-data")),ka=require("fs"),Rt=v(require("mime")),Pa=require("path"),Ri=class extends Re{constructor(e,t,s,o,n,r,a){super(e,t,s,n);this.configService=e;this.eventEmitter=t;this.prismaRepository=s;this.cache=o;this.chatwootCache=n;this.baileysCache=r;this.providerFiles=a;this.stateConnection={state:"open"}}get connectionStatus(){return this.stateConnection}async closeClient(){this.stateConnection={state:"close"}}get qrCode(){return{pairingCode:this.instance.qrcode?.pairingCode,code:this.instance.qrcode?.code,base64:this.instance.qrcode?.base64,count:this.instance.qrcode?.count}}async logoutInstance(){await this.closeClient()}async post(e,t){try{let s=this.configService.get("WA_BUSINESS").URL,o=this.configService.get("WA_BUSINESS").VERSION;s=`${s}/${o}/${this.number}/${t}`;let n={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`};return(await xe.default.post(s,e,{headers:n})).data}catch(s){return s.response?.data?.error}}async profilePicture(e){return{wuid:this.createJid(e),profilePictureUrl:null}}async getProfileName(){return null}async profilePictureUrl(){return null}async getProfileStatus(){return null}async setWhatsappBusinessProfile(e){let t={messaging_product:"whatsapp",about:e.about,address:e.address,description:e.description,vertical:e.vertical,email:e.email,websites:e.websites,profile_picture_handle:e.profilehandle};return await this.post(t,"whatsapp_business_profile")}async connectToWhatsapp(e){if(!e)return;let t=e.entry[0].changes[0].value;try{this.loadChatwoot(),this.eventHandler(t),this.phoneNumber=this.createJid(t.messages?t.messages[0].from:t.statuses[0]?.recipient_id)}catch(s){throw this.logger.error(s),new N(s?.toString())}}async downloadMediaMessage(e){try{let t=e[e.type].id,s=this.configService.get("WA_BUSINESS").URL,o=this.configService.get("WA_BUSINESS").VERSION;s=`${s}/${o}/${t}`;let n={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},r=await xe.default.get(s,{headers:n});return r=await xe.default.get(r.data.url,{headers:n,responseType:"arraybuffer"}),r.data}catch(t){this.logger.error(t)}}messageMediaJson(e){let t=e.messages[0],s=t.type+"Message";return s={[s]:t[t.type]},t.context&&(s={...s,contextInfo:{stanzaId:t.context.id}}),s}messageInteractiveJson(e){let t=e.messages[0],s={conversation:t.interactive[t.interactive.type].title};return t.context&&(s={...s,contextInfo:{stanzaId:t.context.id}}),s}messageButtonJson(e){let t=e.messages[0],s={conversation:e.messages[0].button?.text};return t.context&&(s={...s,contextInfo:{stanzaId:t.context.id}}),s}messageReactionJson(e){let t=e.messages[0],s={reactionMessage:{key:{id:t.reaction.message_id},text:t.reaction.emoji}};return t.context&&(s={...s,contextInfo:{stanzaId:t.context.id}}),s}messageTextJson(e){let t,s=e.messages[0];return s.from===e.metadata.phone_number_id?(t={extendedTextMessage:{text:s.text.body}},s.context&&(t={...t,contextInfo:{stanzaId:s.context.id}})):(t={conversation:s.text.body},s.context&&(t={...t,contextInfo:{stanzaId:s.context.id}})),t}messageContactsJson(e){let t=e.messages[0],s={},o=n=>{let r=`BEGIN:VCARD
VERSION:3.0
N:${n.name.formatted_name}
FN:${n.name.formatted_name}
`;return n.org&&(r+=`ORG:${n.org.company};
`),n.emails&&(r+=`EMAIL:${n.emails[0].email}
`),n.urls&&(r+=`URL:${n.urls[0].url}
`),n.phones[0]?.wa_id||(n.phones[0].wa_id=this.createJid(n.phones[0].phone)),r+=`item1.TEL;waid=${n.phones[0]?.wa_id}:${n.phones[0].phone}
item1.X-ABLabel:Celular
END:VCARD`,r};return t.contacts.length===1?s.contactMessage={displayName:t.contacts[0].name.formatted_name,vcard:o(t.contacts[0])}:s.contactsArrayMessage={displayName:`${t.length} contacts`,contacts:t.map(n=>({displayName:n.name.formatted_name,vcard:o(n)}))},t.context&&(s={...s,contextInfo:{stanzaId:t.context.id}}),s}renderMessageType(e){let t;switch(e){case"text":t="conversation";break;case"image":t="imageMessage";break;case"video":t="videoMessage";break;case"audio":t="audioMessage";break;case"document":t="documentMessage";break;case"template":t="conversation";break;default:t="conversation";break}return t}async messageHandle(e,t,s){try{let o,n;if(e.contacts&&(n=e.contacts[0].profile.name),e.messages){let r={id:e.messages[0].id,remoteJid:this.phoneNumber,fromMe:e.messages[0].from===e.metadata.phone_number_id};if(e?.messages[0].document||e?.messages[0].image||e?.messages[0].audio||e?.messages[0].video)if(o={key:r,pushName:n,message:this.messageMediaJson(e),contextInfo:this.messageMediaJson(e)?.contextInfo,messageType:this.renderMessageType(e.messages[0].type),messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId},this.configService.get("S3").ENABLE)try{let u=e,d=u.messages[0][u.messages[0].type].id,l=this.configService.get("WA_BUSINESS").URL,g=this.configService.get("WA_BUSINESS").VERSION;l=`${l}/${g}/${d}`;let h={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},y=await xe.default.get(l,{headers:h}),f=await xe.default.get(y.data.url,{headers:h,responseType:"arraybuffer"}),w=u.messages[0].document?"document":u.messages[0].image?"image":u.messages[0].audio?"audio":"video",I=y.headers["content-type"],b=y.headers["content-disposition"],S=`${u.messages[0].id}.${I.split("/")[1]}`;if(b){let W=b.match(/filename="(.+?)"/);W&&(S=W[1])}let C=y.headers["content-length"]||f.data.byteLength,P=(0,Pa.join)(`${this.instance.id}`,e.key.remoteJid,w,S);await At(P,f.data,C,{"Content-Type":I}),await this.prismaRepository.media.create({data:{messageId:e.messages[0].id,instanceId:this.instanceId,type:w,fileName:P,mimetype:I}});let L=await Ue(P);o.message.mediaUrl=L}catch(u){this.logger.error(["Error on upload file to minio",u?.message,u?.stack])}else{let u=await this.downloadMediaMessage(e?.messages[0]);o.message.base64=u.toString("base64")}else e?.messages[0].interactive?o={key:r,pushName:n,message:{...this.messageInteractiveJson(e)},contextInfo:this.messageInteractiveJson(e)?.contextInfo,messageType:"interactiveMessage",messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId}:e?.messages[0].button?o={key:r,pushName:n,message:{...this.messageButtonJson(e)},contextInfo:this.messageButtonJson(e)?.contextInfo,messageType:"buttonMessage",messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId}:e?.messages[0].reaction?o={key:r,pushName:n,message:{...this.messageReactionJson(e)},contextInfo:this.messageReactionJson(e)?.contextInfo,messageType:"reactionMessage",messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId}:e?.messages[0].contacts?o={key:r,pushName:n,message:{...this.messageContactsJson(e)},contextInfo:this.messageContactsJson(e)?.contextInfo,messageType:"contactMessage",messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId}:o={key:r,pushName:n,message:this.messageTextJson(e),contextInfo:this.messageTextJson(e)?.contextInfo,messageType:this.renderMessageType(e.messages[0].type),messageTimestamp:parseInt(e.messages[0].timestamp),source:"unknown",instanceId:this.instanceId};if(this.localSettings.readMessages,this.configService.get("OPENAI").ENABLED){let u=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});u&&u.openaiCredsId&&u.speechToText&&e?.message?.audioMessage&&(o.message.speechToText=await this.openaiService.speechToText(u.OpenaiCreds,e,this.client.updateMediaMessage))}if(this.logger.log(o),this.sendDataWebhook("messages.upsert",o),await Ee.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:o.key.remoteJid,msg:o,pushName:o.pushName}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled){let u=await this.chatwootService.eventWhatsapp("messages.upsert",{instanceName:this.instance.name,instanceId:this.instanceId},o);u?.id&&(o.chatwootMessageId=u.id,o.chatwootInboxId=u.id,o.chatwootConversationId=u.id)}await this.prismaRepository.message.create({data:o});let a=await this.prismaRepository.contact.findFirst({where:{instanceId:this.instanceId,remoteJid:r.remoteJid}}),c={remoteJid:e.contacts[0].profile.phone,pushName:n,instanceId:this.instanceId};if(c.remoteJid==="status@broadcast")return;if(a){let u={remoteJid:e.contacts[0].profile.phone,pushName:n,instanceId:this.instanceId};this.sendDataWebhook("contacts.update",u),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&await this.chatwootService.eventWhatsapp("contacts.update",{instanceName:this.instance.name,instanceId:this.instanceId},u),await this.prismaRepository.contact.updateMany({where:{remoteJid:a.remoteJid},data:u});return}this.sendDataWebhook("contacts.upsert",c),this.prismaRepository.contact.create({data:c})}if(e.statuses)for await(let r of e.statuses){let a={id:r.id,remoteJid:this.phoneNumber,fromMe:this.phoneNumber===e.metadata.phone_number_id};if(s?.groups_ignore&&a.remoteJid.includes("@g.us"))return;if(a.remoteJid!=="status@broadcast"&&!a?.remoteJid?.match(/(:\d+)/)){let c=await this.prismaRepository.message.findFirst({where:{instanceId:this.instanceId,key:{path:["id"],equals:a.id}}});if(!c)return;if(r.message===null&&r.status===void 0){this.sendDataWebhook("messages.delete",a);let d={messageId:c.id,keyId:a.id,remoteJid:a.remoteJid,fromMe:a.fromMe,participant:a?.remoteJid,status:"DELETED",instanceId:this.instanceId};await this.prismaRepository.messageUpdate.create({data:d}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("messages.delete",{instanceName:this.instance.name,instanceId:this.instanceId},{key:a});return}let u={messageId:c.id,keyId:a.id,remoteJid:a.remoteJid,fromMe:a.fromMe,participant:a?.remoteJid,status:r.status.toUpperCase(),instanceId:this.instanceId};this.sendDataWebhook("messages.update",u),await this.prismaRepository.messageUpdate.create({data:u}),c.webhookUrl&&await xe.default.post(c.webhookUrl,u)}}}catch(o){this.logger.error(o)}}convertMessageToRaw(e,t){let s;return e?.conversation?t?.context?.message_id?(s={...e,contextInfo:{stanzaId:t.context.message_id}},s):(s=e,s):e?.mediaType==="image"?t?.context?.message_id?(s={imageMessage:e,contextInfo:{stanzaId:t.context.message_id}},s):{imageMessage:e}:e?.mediaType==="video"?t?.context?.message_id?(s={videoMessage:e,contextInfo:{stanzaId:t.context.message_id}},s):{videoMessage:e}:e?.mediaType==="audio"?t?.context?.message_id?(s={audioMessage:e,contextInfo:{stanzaId:t.context.message_id}},s):{audioMessage:e}:e?.mediaType==="document"?t?.context?.message_id?(s={documentMessage:e,contextInfo:{stanzaId:t.context.message_id}},s):{documentMessage:e}:e}async eventHandler(e){let t=this.configService.get("DATABASE"),s=await this.findSettings();this.messageHandle(e,t,s)}async sendMessageWithTyping(e,t,s,o=!1){try{let n,r,a=s?.linkPreview!=!1?void 0:!1;if(s?.quoted){let g=s?.quoted?.key;if(!g)throw"Message not found";n=g}s?.webhookUrl&&(r=s.webhookUrl);let c,u=await(async()=>{if(t.reactionMessage)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"reaction",to:e.replace(/\D/g,""),reaction:{message_id:t.reactionMessage.key.id,emoji:t.reactionMessage.text}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.locationMessage)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"location",to:e.replace(/\D/g,""),location:{longitude:t.locationMessage.degreesLongitude,latitude:t.locationMessage.degreesLatitude,name:t.locationMessage.name,address:t.locationMessage.address}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.contacts)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"contacts",to:e.replace(/\D/g,""),contacts:t.contacts},n&&(c.context={message_id:n.id}),t=t.message,await this.post(c,"messages");if(t.conversation)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"text",to:e.replace(/\D/g,""),text:{body:t.conversation,preview_url:a}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.media)return c={messaging_product:"whatsapp",recipient_type:"individual",type:t.mediaType,to:e.replace(/\D/g,""),[t.mediaType]:{[t.type]:t.id,preview_url:a,caption:t.caption}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.audio)return c={messaging_product:"whatsapp",recipient_type:"individual",type:"audio",to:e.replace(/\D/g,""),audio:{[t.type]:t.id}},n&&(c.context={message_id:n.id}),await this.post(c,"messages");if(t.buttons){c={messaging_product:"whatsapp",recipient_type:"individual",to:e.replace(/\D/g,""),type:"interactive",interactive:{type:"button",body:{text:t.text||"Select"},action:{buttons:t.buttons}}},n&&(c.context={message_id:n.id});let l="";for(let g of t.buttons)l+=`\u25B6\uFE0F ${g.reply?.title}
`;return t={conversation:`${t.text||"Select"}
`+l},await this.post(c,"messages")}if(t.listMessage){c={messaging_product:"whatsapp",recipient_type:"individual",to:e.replace(/\D/g,""),type:"interactive",interactive:{type:"list",header:{type:"text",text:t.listMessage.title},body:{text:t.listMessage.description},footer:{text:t.listMessage.footerText},action:{button:t.listMessage.buttonText,sections:t.listMessage.sections}}},n&&(c.context={message_id:n.id});let l="";for(let g of t.listMessage.sections){l+=`${g?.title}
`;for(let h of g.rows)l+=`${h?.title}
`}return t={conversation:`${t.listMessage.title}
`+l},await this.post(c,"messages")}if(t.template)return c={messaging_product:"whatsapp",recipient_type:"individual",to:e.replace(/\D/g,""),type:"template",template:{name:t.template.name,language:{code:t.template.language||"en_US"},components:t.template.components}},n&&(c.context={message_id:n.id}),t={conversation:`\u25B6\uFE0F${t.template.name}\u25C0\uFE0F`},await this.post(c,"messages")})();if(u?.error_data)return this.logger.error(u),u;let d={key:{fromMe:!0,id:u?.messages[0]?.id,remoteJid:this.createJid(e)},message:this.convertMessageToRaw(t,c),messageType:this.renderMessageType(c.type),messageTimestamp:u?.messages[0]?.timestamp||Math.round(new Date().getTime()/1e3),instanceId:this.instanceId,webhookUrl:r,source:"unknown"};return this.logger.log(d),this.sendDataWebhook("send.message",d),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&!o&&this.chatwootService.eventWhatsapp("send.message",{instanceName:this.instance.name,instanceId:this.instanceId},d),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&o&&await Ee.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:d.key.remoteJid,msg:d,pushName:d.pushName}),await this.prismaRepository.message.create({data:d}),d}catch(n){throw this.logger.error(n),new m(n.toString())}}async textMessage(e,t=!1){return await this.sendMessageWithTyping(e.number,{conversation:e.text},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async getIdMedia(e){let t=new Na.default,s=(0,ka.createReadStream)(e.media);t.append("file",s,{filename:"media",contentType:e.mimetype}),t.append("typeFile",e.mimetype),t.append("messaging_product","whatsapp");let o={Authorization:`Bearer ${this.token}`};return(await xe.default.post(process.env.API_URL+"/"+process.env.VERSION+"/"+this.number+"/media",t,{headers:o})).data.id}async prepareMediaMessage(e){try{if(e.mediatype==="document"&&!e.fileName){let n=new RegExp(/.*\/(.+?)\./).exec(e.media);e.fileName=n[1]}e.mediatype==="image"&&!e.fileName&&(e.fileName="image.png"),e.mediatype==="video"&&!e.fileName&&(e.fileName="video.mp4");let t,s={caption:e?.caption,fileName:e.fileName,mediaType:e.mediatype,media:e.media,gifPlayback:!1};if((0,Je.isURL)(e.media))t=Rt.default.getType(e.media),s.id=e.media,s.type="link";else{t=Rt.default.getType(e.fileName);let o=await this.getIdMedia(s);s.id=o,s.type="id"}return s.mimetype=t,s}catch(t){throw this.logger.error(t),new N(t?.toString()||t)}}async mediaMessage(e,t=!1){let s=await this.prepareMediaMessage(e);return await this.sendMessageWithTyping(e.number,{...s},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async processAudio(e,t){t=t.replace(/\D/g,"");let s=`${t}-${new Date().getTime()}`,o,n={fileName:`${s}.mp3`,mediaType:"audio",media:e};if((0,Je.isURL)(e))o=Rt.default.getType(e),n.id=e,n.type="link";else{o=Rt.default.getType(n.fileName);let r=await this.getIdMedia(n);n.id=r,n.type="id"}return n.mimetype=o,n}async audioWhatsapp(e,t=!1){let s=await this.processAudio(e.audio,e.number);return await this.sendMessageWithTyping(e.number,{...s},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async buttonMessage(e){let t={},s={text:e.buttons.map(o=>o.text),ids:e.buttons.map(o=>o.id)};if(!(0,Je.arrayUnique)(s.text)||!(0,Je.arrayUnique)(s.ids))throw new m("Button texts cannot be repeated","Button IDs cannot be repeated.");return await this.sendMessageWithTyping(e.number,{text:t?.mediaKey?void 0:e.title,buttons:e.buttons.map(o=>({type:"reply",reply:{title:o.text,id:o.id}})),[t?.mediaKey]:t?.message},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async locationMessage(e){return await this.sendMessageWithTyping(e.number,{locationMessage:{degreesLatitude:e.latitude,degreesLongitude:e.longitude,name:e?.name,address:e?.address}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async listMessage(e){let t={title:e.sections.map(o=>o.title)};if(!(0,Je.arrayUnique)(t.title))throw new m("Section tiles cannot be repeated");let s={listMessage:{title:e.title,description:e.description,footerText:e?.footerText,buttonText:e?.buttonText,sections:e.sections.map(o=>({title:o.title,rows:o.rows.map(n=>({title:n.title,description:n.description.substring(0,72),id:n.rowId}))}))}};return await this.sendMessageWithTyping(e.number,s,{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async templateMessage(e,t=!1){return await this.sendMessageWithTyping(e.number,{template:{name:e.name,language:e.language,components:e.components}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned,webhookUrl:e?.webhookUrl},t)}async contactMessage(e){let t={},s=o=>{let n=`BEGIN:VCARD
VERSION:3.0
N:${o.fullName}
FN:${o.fullName}
`;return o.organization&&(n+=`ORG:${o.organization};
`),o.email&&(n+=`EMAIL:${o.email}
`),o.url&&(n+=`URL:${o.url}
`),o.wuid||(o.wuid=this.createJid(o.phoneNumber)),n+=`item1.TEL;waid=${o.wuid}:${o.phoneNumber}
item1.X-ABLabel:Celular
END:VCARD`,n};return e.contact.length===1?t.contact={displayName:e.contact[0].fullName,vcard:s(e.contact[0])}:t.contactsArrayMessage={displayName:`${e.contact.length} contacts`,contacts:e.contact.map(o=>({displayName:o.fullName,vcard:s(o)}))},await this.sendMessageWithTyping(e.number,{contacts:e.contact.map(o=>({name:{formatted_name:o.fullName,first_name:o.fullName},phones:[{phone:o.phoneNumber}],urls:[{url:o.url}],emails:[{email:o.email}],org:{company:o.organization}})),message:t},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async reactionMessage(e){return await this.sendMessageWithTyping(e.key.remoteJid,{reactionMessage:{key:e.key,text:e.reaction}})}async getBase64FromMediaMessage(e){try{let t=e.message,s=t.messageType.includes("Message")?t.messageType:t.messageType+"Message",o=t.message[s];return{mediaType:t.messageType,fileName:o?.fileName,caption:o?.caption,size:{fileLength:o?.fileLength,height:o?.fileLength,width:o?.width},mimetype:o?.mime_type,base64:t.message.base64}}catch(t){throw this.logger.error(t),new m(t.toString())}}async deleteMessage(){throw new m("Method not available on WhatsApp Business API")}async mediaSticker(){throw new m("Method not available on WhatsApp Business API")}async pollMessage(){throw new m("Method not available on WhatsApp Business API")}async statusMessage(){throw new m("Method not available on WhatsApp Business API")}async reloadConnection(){throw new m("Method not available on WhatsApp Business API")}async whatsappNumber(){throw new m("Method not available on WhatsApp Business API")}async markMessageAsRead(){throw new m("Method not available on WhatsApp Business API")}async archiveChat(){throw new m("Method not available on WhatsApp Business API")}async markChatUnread(){throw new m("Method not available on WhatsApp Business API")}async fetchProfile(){throw new m("Method not available on WhatsApp Business API")}async sendPresence(){throw new m("Method not available on WhatsApp Business API")}async setPresence(){throw new m("Method not available on WhatsApp Business API")}async fetchPrivacySettings(){throw new m("Method not available on WhatsApp Business API")}async updatePrivacySettings(){throw new m("Method not available on WhatsApp Business API")}async fetchBusinessProfile(){throw new m("Method not available on WhatsApp Business API")}async updateProfileName(){throw new m("Method not available on WhatsApp Business API")}async updateProfileStatus(){throw new m("Method not available on WhatsApp Business API")}async updateProfilePicture(){throw new m("Method not available on WhatsApp Business API")}async removeProfilePicture(){throw new m("Method not available on WhatsApp Business API")}async blockUser(){throw new m("Method not available on WhatsApp Business API")}async updateMessage(){throw new m("Method not available on WhatsApp Business API")}async createGroup(){throw new m("Method not available on WhatsApp Business API")}async updateGroupPicture(){throw new m("Method not available on WhatsApp Business API")}async updateGroupSubject(){throw new m("Method not available on WhatsApp Business API")}async updateGroupDescription(){throw new m("Method not available on WhatsApp Business API")}async findGroup(){throw new m("Method not available on WhatsApp Business API")}async fetchAllGroups(){throw new m("Method not available on WhatsApp Business API")}async inviteCode(){throw new m("Method not available on WhatsApp Business API")}async inviteInfo(){throw new m("Method not available on WhatsApp Business API")}async sendInvite(){throw new m("Method not available on WhatsApp Business API")}async acceptInviteCode(){throw new m("Method not available on WhatsApp Business API")}async revokeInviteCode(){throw new m("Method not available on WhatsApp Business API")}async findParticipants(){throw new m("Method not available on WhatsApp Business API")}async updateGParticipant(){throw new m("Method not available on WhatsApp Business API")}async updateGSetting(){throw new m("Method not available on WhatsApp Business API")}async toggleEphemeral(){throw new m("Method not available on WhatsApp Business API")}async leaveGroup(){throw new m("Method not available on WhatsApp Business API")}async fetchLabels(){throw new m("Method not available on WhatsApp Business API")}async handleLabel(){throw new m("Method not available on WhatsApp Business API")}async receiveMobileCode(){throw new m("Method not available on WhatsApp Business API")}async fakeCall(){throw new m("Method not available on WhatsApp Business API")}};var $n=require("baileys"),fe=class{constructor(i){this.cache=i;this.logger=new E("CacheService");i?this.logger.verbose(`cacheservice created using cache engine: ${i.constructor?.name}`):this.logger.verbose("cacheservice disabled")}async get(i){if(this.cache)return this.cache.get(i)}async hGet(i,e){if(!this.cache)return null;try{let t=await this.cache.hGet(i,e);return t?JSON.parse(t,$n.BufferJSON.reviver):null}catch(t){return this.logger.error(t),null}}async set(i,e,t){this.cache&&this.cache.set(i,e,t)}async hSet(i,e,t){if(this.cache)try{let s=JSON.stringify(t,$n.BufferJSON.replacer);await this.cache.hSet(i,e,s)}catch(s){this.logger.error(s)}}async has(i){if(this.cache)return this.cache.has(i)}async delete(i){if(this.cache)return this.cache.delete(i)}async hDelete(i,e){if(!this.cache)return!1;try{return await this.cache.hDelete(i,e),!0}catch(t){return this.logger.error(t),!1}}async deleteAll(i){if(this.cache)return this.cache.deleteAll(i)}async keys(i){if(this.cache)return this.cache.keys(i)}};var jn=v(require("@ffmpeg-installer/ffmpeg"));var _a=v(require("dayjs"));function Ba(p){let i=[];p.startsWith("+")&&(p=p.slice(1));let[e,t]=p.split("@");if(p.startsWith("55")){let s=e.slice(4,5)==="9"&&e.length===13?e:`${e.slice(0,4)}9${e.slice(4)}`,o=e.length===12?e:e.slice(0,4)+e.slice(5);i.push(s),i.push(o)}else if(e.startsWith("52")||e.startsWith("54")){let s="";e.startsWith("52")&&(s="1"),e.startsWith("54")&&(s="9");let o=e.slice(2,3)===s&&e.length===13?e:`${e.slice(0,2)}${s}${e.slice(2)}`,n=e.length===12?e:e.slice(0,2)+e.slice(3);i.push(o),i.push(n)}else i.push(p);return i.map(s=>`${s}@${t}`)}async function We(p){if(M.get("DATABASE").SAVE_DATA.IS_ON_WHATSAPP){let i=p.map(e=>{let t=e.remoteJid.startsWith("+")?e.remoteJid.slice(1):e.remoteJid,s=Ba(t);return F.isOnWhatsapp.upsert({create:{remoteJid:t,jidOptions:s.join(",")},update:{jidOptions:s.join(",")},where:{remoteJid:t}})});await F.$transaction(i)}}async function Fa(p){let i=[];if(M.get("DATABASE").SAVE_DATA.IS_ON_WHATSAPP){let e=p.map(s=>Ba(s)).flat();i=(await F.isOnWhatsapp.findMany({where:{OR:e.map(s=>({jidOptions:{contains:s}})),updatedAt:{gte:(0,_a.default)().subtract(M.get("DATABASE").SAVE_DATA.IS_ON_WHATSAPP_DAYS,"days").toDate()}}})).map(s=>({remoteJid:s.remoteJid,number:s.remoteJid.split("@")[0],jidOptions:s.jidOptions.split(",")}))}return i}var Ot=require("path"),Oi=process.cwd(),xt=(0,Ot.join)(Oi,"instances"),Py=(0,Ot.join)(Oi,"src"),_y=(0,Ot.join)(Oi,"store","auth"),La=(0,Ot.join)(Oi,"store");var qe=require("baileys"),Ua=v(require("fs/promises")),Ja=v(require("path")),Dt=qt;async function Vn(p){try{return!!await Dt.session.findUnique({where:{sessionId:p}})}catch{return!1}}async function Vc(p,i){let e=await Vn(p);try{if(!e)return await Dt.session.create({data:{sessionId:p,creds:JSON.stringify(i)}});await Dt.session.update({where:{sessionId:p},data:{creds:JSON.stringify(i)}})}catch{return null}}async function Gc(p){try{if(!await Vn(p))return null;let e=await Dt.session.findUnique({where:{sessionId:p}});return JSON.parse(e?.creds)}catch{return null}}async function Hc(p){try{if(!await Vn(p))return;await Dt.session.delete({where:{sessionId:p}})}catch{return}}async function Gn(p,i){let e=Ja.default.join(xt,p);await Ua.default.mkdir(e,{recursive:!0});async function t(r,a){let c=JSON.stringify(r,qe.BufferJSON.replacer);if(a!="creds")return await i.hSet(p,a,r);await Vc(p,c)}async function s(r){try{let a;return r!="creds"?await i.hGet(p,r):(a=await Gc(p),JSON.parse(a,qe.BufferJSON.reviver))}catch{return null}}async function o(r){try{if(r!="creds")return await i.hDelete(p,r);await Hc(p)}catch{return}}let n=await s("creds");return n||(n=(0,qe.initAuthCreds)(),await t(n,"creds")),{state:{creds:n,keys:{get:async(r,a)=>{let c={};return await Promise.all(a.map(async u=>{let d=await s(`${r}-${u}`);r==="app-state-sync-key"&&d&&(d=qe.WAProto.Message.AppStateSyncKeyData.fromObject(d)),c[u]=d})),c},set:async r=>{let a=[];for(let c in r)for(let u in r[c]){let d=r[c][u],l=`${c}-${u}`;a.push(d?t(d,l):o(l))}await Promise.all(a)}}},saveCreds:()=>t(n,"creds")}}var $e=require("baileys"),Wa=require("class-validator");var xi=class{constructor(i){this.providerFiles=i;this.logger=new E("AuthStateProvider")}async authStateProvider(i){let[,e]=await this.providerFiles.create(i);if(e){this.logger.error(["Failed to create folder on file server",e?.message,e?.stack]);return}let t=async(r,a)=>{let c=JSON.stringify(r,$e.BufferJSON.replacer),[u,d]=await this.providerFiles.write(i,a,{data:c});if(!d)return u},s=async r=>{let[a,c]=await this.providerFiles.read(i,r);if(!c&&(0,Wa.isNotEmpty)(a?.data))return JSON.parse(JSON.stringify(a.data),$e.BufferJSON.reviver)},o=async r=>{let[a,c]=await this.providerFiles.delete(i,r);if(!c)return a},n=await s("creds")||(0,$e.initAuthCreds)();return{state:{creds:n,keys:{get:async(r,a)=>{let c={};return await Promise.all(a.map(async u=>{let d=await s(`${r}-${u}`);r==="app-state-sync-key"&&d&&(d=$e.proto.Message.AppStateSyncKeyData.fromObject(d)),c[u]=d})),c},set:async r=>{let a=[];for(let c in r)for(let u in r[c]){let d=r[c][u],l=`${c}-${u}`;a.push(d?await t(d,l):await o(l))}await Promise.all(a)}}},saveCreds:async()=>await t(n,"creds")}}};var Di=require("baileys");async function qa(p,i){let e=new E("useMultiFileAuthStateRedisDb"),t=async(r,a)=>{try{return await i.hSet(p,a,r)}catch(c){return e.error({localError:"writeData",error:c})}},s=async r=>{try{return await i.hGet(p,r)}catch(a){e.error({localError:"readData",error:a});return}},o=async r=>{try{return await i.hDelete(p,r)}catch(a){e.error({readData:"removeData",error:a})}},n=await s("creds")||(0,Di.initAuthCreds)();return{state:{creds:n,keys:{get:async(r,a)=>{let c={};return await Promise.all(a.map(async u=>{let d=await s(`${r}-${u}`);r==="app-state-sync-key"&&d&&(d=Di.proto.Message.AppStateSyncKeyData.fromObject(d)),c[u]=d})),c},set:async r=>{let a=[];for(let c in r)for(let u in r[c]){let d=r[c][u],l=`${c}-${u}`;a.push(d?await t(d,l):await o(l))}await Promise.all(a)}}},saveCreds:async()=>await t(n,"creds")}}var De=v(require("axios")),A=v(require("baileys")),ae=require("class-validator"),$a=require("crypto"),Nt=v(require("fluent-ffmpeg")),Va=require("fs"),Ni=v(require("long")),kt=v(require("mime")),Kn=v(require("node-cache")),Ga=require("os"),ki=require("path"),nt=v(require("pino")),Ha=v(require("qrcode")),ja=v(require("qrcode-terminal")),Ka=v(require("sharp")),Ve=require("stream"),Ya=require("uuid"),Hn=new fe(new ge(M,"groups").getEngine()),Pi=class extends Re{constructor(e,t,s,o,n,r,a){super(e,t,s,n);this.configService=e;this.eventEmitter=t;this.prismaRepository=s;this.cache=o;this.chatwootCache=n;this.baileysCache=r;this.providerFiles=a;this.msgRetryCounterCache=new Kn.default;this.userDevicesCache=new Kn.default;this.endSession=!1;this.logBaileys=this.configService.get("LOG").BAILEYS;this.stateConnection={state:"close"};this.chatHandle={"chats.upsert":async e=>{let t=await this.prismaRepository.chat.findMany({where:{instanceId:this.instanceId},select:{remoteJid:!0}}),s=new Set(t.map(n=>n.remoteJid)),o=e.filter(n=>!s?.has(n.id)).map(n=>({remoteJid:n.id,instanceId:this.instanceId,name:n.name}));this.sendDataWebhook("chats.upsert",o),o.length>0&&this.configService.get("DATABASE").SAVE_DATA.CHATS&&await this.prismaRepository.chat.createMany({data:o,skipDuplicates:!0})},"chats.update":async e=>{let t=e.map(s=>({remoteJid:s.id,instanceId:this.instanceId}));this.sendDataWebhook("chats.update",t);for(let s of e)await this.prismaRepository.chat.updateMany({where:{instanceId:this.instanceId,remoteJid:s.id,name:s.name},data:{remoteJid:s.id}})},"chats.delete":async e=>{e.forEach(async t=>await this.prismaRepository.chat.deleteMany({where:{instanceId:this.instanceId,remoteJid:t}})),this.sendDataWebhook("chats.delete",[...e])}};this.contactHandle={"contacts.upsert":async e=>{try{let t=e.map(o=>({remoteJid:o.id,pushName:o?.name||o?.verifiedName||o.id.split("@")[0],profilePicUrl:null,instanceId:this.instanceId}));if(t.length>0){this.sendDataWebhook("contacts.upsert",t),this.configService.get("DATABASE").SAVE_DATA.CONTACTS&&await this.prismaRepository.contact.createMany({data:t,skipDuplicates:!0});let o=t.filter(n=>n.remoteJid.includes("@s.whatsapp"));o&&await We(o.map(n=>({remoteJid:n.remoteJid})))}this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.localChatwoot.importContacts&&t.length&&(this.chatwootService.addHistoryContacts({instanceName:this.instance.name,instanceId:this.instance.id},t),oe.importHistoryContacts({instanceName:this.instance.name,instanceId:this.instance.id},this.localChatwoot));let s=await Promise.all(e.map(async o=>({remoteJid:o.id,pushName:o?.name||o?.verifiedName||o.id.split("@")[0],profilePicUrl:(await this.profilePicture(o.id)).profilePictureUrl,instanceId:this.instanceId})));if(s.length>0){let o=s.filter(n=>n.remoteJid.includes("@s.whatsapp"));o&&await We(o.map(n=>({remoteJid:n.remoteJid}))),this.sendDataWebhook("contacts.update",s),await Promise.all(s.map(async n=>{let r=this.prismaRepository.contact.updateMany({where:{remoteJid:n.remoteJid,instanceId:this.instanceId},data:{profilePicUrl:n.profilePicUrl}});if(this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled){let a={instanceName:this.instance.name,instanceId:this.instance.id},c=await this.chatwootService.findContact(a,n.remoteJid.split("@")[0]);if(!c)return;this.chatwootService.updateContact(a,c.id,{name:n.pushName,avatar_url:n.profilePicUrl})}return r}))}}catch(t){console.error(t),this.logger.error("line 817"),this.logger.error(`Error: ${t.message}`)}},"contacts.update":async e=>{let t=[];for await(let n of e)t.push({remoteJid:n.id,pushName:n?.name??n?.verifiedName,profilePicUrl:(await this.profilePicture(n.id)).profilePictureUrl,instanceId:this.instanceId});this.sendDataWebhook("contacts.update",t);let s=t.map(n=>this.prismaRepository.contact.upsert({where:{remoteJid_instanceId:{remoteJid:n.remoteJid,instanceId:n.instanceId}},create:n,update:n}));await this.prismaRepository.$transaction(s);let o=t.filter(n=>n.remoteJid.includes("@s.whatsapp"));o&&await We(o.map(n=>({remoteJid:n.remoteJid})))}};this.messageHandle={"messaging-history.set":async({messages:e,chats:t,contacts:s,isLatest:o,progress:n,syncType:r})=>{try{r===A.proto.HistorySync.HistorySyncType.ON_DEMAND&&console.log("received on-demand history sync, messages=",e),console.log(`recv ${t.length} chats, ${s.length} contacts, ${e.length} msgs (is latest: ${o}, progress: ${n}%), type: ${r}`);let a={instanceName:this.instance.name},c=null;if(this.configService.get("CHATWOOT").ENABLED){let h=this.localChatwoot?.enabled?this.localChatwoot.daysLimitImportMessages:1e3,y=new Date;if(c=new Date(y.setDate(y.getDate()-h)).getTime()/1e3,!(Math.max(...e.map(I=>I.messageTimestamp))>=c))return}let u=[],d=new Set((await this.prismaRepository.chat.findMany({where:{instanceId:this.instanceId}})).map(h=>h.remoteJid));for(let h of t)d?.has(h.id)||u.push({remoteJid:h.id,instanceId:this.instanceId,name:h.name});this.sendDataWebhook("chats.set",u),this.configService.get("DATABASE").SAVE_DATA.HISTORIC&&await this.prismaRepository.chat.createMany({data:u,skipDuplicates:!0});let l=[],g=new Set(oe.getRepositoryMessagesCache(a)??(await this.prismaRepository.message.findMany({select:{key:!0},where:{instanceId:this.instanceId}})).map(h=>h.key.id));oe.getRepositoryMessagesCache(a)===null&&oe.setRepositoryMessagesCache(a,g);for(let h of e)!h.message||!h.key||!h.messageTimestamp||(Ni.default.isLong(h?.messageTimestamp)&&(h.messageTimestamp=h.messageTimestamp?.toNumber()),!(this.configService.get("CHATWOOT").ENABLED&&h.messageTimestamp<=c)&&(g?.has(h.key.id)||l.push(this.prepareMessage(h))));this.sendDataWebhook("messages.set",[...l]),this.configService.get("DATABASE").SAVE_DATA.HISTORIC&&await this.prismaRepository.message.createMany({data:l,skipDuplicates:!0}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.localChatwoot.importMessages&&l.length>0&&this.chatwootService.addHistoryMessages(a,l.filter(h=>!oe.isIgnorePhoneNumber(h.key?.remoteJid))),await this.contactHandle["contacts.upsert"](s.filter(h=>!!h.notify||!!h.name).map(h=>({id:h.id,name:h.name??h.notify}))),s=void 0,e=void 0,t=void 0}catch(a){this.logger.error("line 1011"),this.logger.error(a)}},"messages.upsert":async({messages:e,type:t,requestId:s},o)=>{try{for(let n of e){if(n.message?.conversation||n.message?.extendedTextMessage?.text){let l=n.message?.conversation||n.message?.extendedTextMessage?.text;if(l=="requestPlaceholder"&&!s){let g=await this.client.requestPlaceholderResend(n.key);console.log("requested placeholder resync, id=",g)}else s&&console.log("Message received from phone, id=",s,n);if(l=="onDemandHistSync"){let g=await this.client.fetchMessageHistory(50,n.key,n.messageTimestamp);console.log("requested on-demand sync, id=",g)}}if(n.message?.protocolMessage?.editedMessage||n.message?.editedMessage?.message){let l=n.message?.protocolMessage||n.message?.editedMessage?.message?.protocolMessage;l&&(this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("messages.edit",{instanceName:this.instance.name,instanceId:this.instance.id},l),await this.sendDataWebhook("messages.edited",l))}if(n.messageStubParameters&&n.messageStubParameters[0]==="Message absent from node"){this.logger.info(`Recovering message lost messageId: ${n.key.id}`),await this.baileysCache.set(n.key.id,{message:n,retry:0});continue}if((await this.baileysCache.get(n.key.id)||null)&&(this.logger.info("Recovered message lost"),await this.baileysCache.delete(n.key.id)),t!=="notify"&&t!=="append"||n.message?.protocolMessage||n.message?.pollUpdateMessage||!n?.message||(Ni.default.isLong(n.messageTimestamp)&&(n.messageTimestamp=n.messageTimestamp?.toNumber()),o?.groupsIgnore&&n.key.remoteJid.includes("@g.us")))return;let a=this.prepareMessage(n),c=n?.message?.imageMessage||n?.message?.videoMessage||n?.message?.stickerMessage||n?.message?.documentMessage||n?.message?.documentWithCaptionMessage||n?.message?.audioMessage;if(this.localSettings.readMessages&&n.key.id!=="status@broadcast"&&await this.client.readMessages([n.key]),this.localSettings.readStatus&&n.key.id==="status@broadcast"&&await this.client.readMessages([n.key]),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&!n.key.id.includes("@broadcast")){let l=await this.chatwootService.eventWhatsapp("messages.upsert",{instanceName:this.instance.name,instanceId:this.instance.id},a);l?.id&&(a.chatwootMessageId=l.id,a.chatwootInboxId=l.inbox_id,a.chatwootConversationId=l.conversation_id)}if(this.configService.get("OPENAI").ENABLED){let l=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});l&&l.openaiCredsId&&l.speechToText&&n?.message?.audioMessage&&(a.message.speechToText=await this.openaiService.speechToText(l.OpenaiCreds,n,this.client.updateMediaMessage))}if(this.configService.get("DATABASE").SAVE_DATA.NEW_MESSAGE){let l=await this.prismaRepository.message.create({data:a});if(c&&this.configService.get("S3").ENABLE)try{let g=n,h=await this.getBase64FromMediaMessage({message:g},!0),{buffer:y,mediaType:f,fileName:w,size:I}=h,b=kt.default.getType(w).toString(),S=(0,ki.join)(`${this.instance.id}`,n.key.remoteJid,f,w);await At(S,y,I.fileLength?.low,{"Content-Type":b}),await this.prismaRepository.media.create({data:{messageId:l.id,instanceId:this.instanceId,type:f,fileName:S,mimetype:b}});let C=await Ue(S);a.message.mediaUrl=C,await this.prismaRepository.message.update({where:{id:l.id},data:a})}catch(g){this.logger.error("line 1181"),this.logger.error(["Error on upload file to minio",g?.message,g?.stack])}}if(c&&!this.configService.get("S3").ENABLE){let l=await(0,A.downloadMediaMessage)({key:n.key,message:n?.message},"buffer",{},{logger:(0,nt.default)({level:"error"}),reuploadRequest:this.client.updateMediaMessage});a.message.base64=l?l.toString("base64"):void 0}this.logger.log(a),this.sendDataWebhook("messages.upsert",a),await Ee.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:a.key.remoteJid,msg:a,pushName:a.pushName});let u=await this.prismaRepository.contact.findFirst({where:{remoteJid:n.key.remoteJid,instanceId:this.instanceId}}),d={remoteJid:n.key.remoteJid,pushName:n.pushName,profilePicUrl:(await this.profilePicture(n.key.remoteJid)).profilePictureUrl,instanceId:this.instanceId};if(d.remoteJid==="status@broadcast")return;if(u){let l={remoteJid:n.key.remoteJid,pushName:u.pushName,profilePicUrl:(await this.profilePicture(n.key.remoteJid)).profilePictureUrl,instanceId:this.instanceId};this.sendDataWebhook("contacts.update",l),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&await this.chatwootService.eventWhatsapp("contacts.update",{instanceName:this.instance.name,instanceId:this.instanceId},l),this.prismaRepository.contact.updateMany({where:{remoteJid:n.key.remoteJid,instanceId:this.instanceId},data:l});return}this.sendDataWebhook("contacts.upsert",d),this.configService.get("DATABASE").SAVE_DATA.CONTACTS&&await this.prismaRepository.contact.upsert({where:{remoteJid_instanceId:{remoteJid:d.remoteJid,instanceId:d.instanceId}},update:d,create:d}),d.remoteJid.includes("@s.whatsapp")&&await We([{remoteJid:d.remoteJid}])}}catch(n){this.logger.error("line 1318"),this.logger.error(n)}},"messages.update":async(e,t)=>{let s={0:"ERROR",1:"PENDING",2:"SERVER_ACK",3:"DELIVERY_ACK",4:"READ",5:"PLAYED"};for await(let{key:o,update:n}of e){if(t?.groupsIgnore&&o.remoteJid?.includes("@g.us"))return;if(s[n.status]==="READ"&&o.fromMe&&this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("messages.read",{instanceName:this.instance.name,instanceId:this.instanceId},{key:o}),o.remoteJid!=="status@broadcast"){let r;if(n.pollUpdates){let u=await this.getMessage(o);u&&(r=(0,A.getAggregateVotesInPollMessage)({message:u,pollUpdates:n.pollUpdates}))}let a=await this.prismaRepository.message.findFirst({where:{instanceId:this.instanceId,key:{path:["id"],equals:o.id}}});if(!a||s[n.status]==="READ"&&!o.fromMe)return;if(n.message===null&&n.status===void 0){this.sendDataWebhook("messages.delete",o);let u={messageId:a.id,keyId:o.id,remoteJid:o.remoteJid,fromMe:o.fromMe,participant:o?.remoteJid,status:"DELETED",instanceId:this.instanceId};this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE&&await this.prismaRepository.messageUpdate.create({data:u}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("messages.delete",{instanceName:this.instance.name,instanceId:this.instanceId},{key:o});return}let c={messageId:a.id,keyId:o.id,remoteJid:o.remoteJid,fromMe:o.fromMe,participant:o?.remoteJid,status:s[n.status],pollUpdates:r,instanceId:this.instanceId};this.sendDataWebhook("messages.update",c),this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE&&await this.prismaRepository.messageUpdate.create({data:c})}}}};this.groupHandler={"groups.upsert":e=>{this.sendDataWebhook("groups.upsert",e)},"groups.update":e=>{this.sendDataWebhook("groups.update",e),e.forEach(t=>{(0,A.isJidGroup)(t.id)&&this.updateGroupMetadataCache(t.id)})},"group-participants.update":e=>{this.sendDataWebhook("group-participants.update",e),this.updateGroupMetadataCache(e.id)}};this.labelHandle={"labels.edit":async e=>{let s=(await this.prismaRepository.label.findMany({where:{instanceId:this.instanceId}})).find(n=>n.labelId===e.id);if(e.deleted&&s){await this.prismaRepository.label.delete({where:{labelId_instanceId:{instanceId:this.instanceId,labelId:e.id}}}),this.sendDataWebhook("labels.edit",{...e,instance:this.instance.name});return}let o=e.name.replace(/[^\x20-\x7E]/g,"");if(!s||s.color!==`${e.color}`||s.name!==o){if(this.configService.get("DATABASE").SAVE_DATA.LABELS){let n={color:`${e.color}`,name:o,labelId:e.id,predefinedId:e.predefinedId,instanceId:this.instanceId};await this.prismaRepository.label.upsert({where:{labelId_instanceId:{instanceId:n.instanceId,labelId:n.labelId}},update:n,create:n})}this.sendDataWebhook("labels.edit",{...e,instance:this.instance.name})}},"labels.association":async(e,t)=>{if(t.SAVE_DATA.CHATS){let o=(await this.prismaRepository.chat.findMany({where:{instanceId:this.instanceId}})).find(n=>n.remoteJid===e.association.chatId);if(o){let r=[...Array.isArray(o.labels)?o.labels.map(a=>String(a)):[]];e.type==="remove"?r=r.filter(a=>a!==e.association.labelId):e.type==="add"&&(r=[...r,e.association.labelId]),await this.prismaRepository.chat.update({where:{id:o.id},data:{labels:r}})}}this.sendDataWebhook("labels.association",{instance:this.instance.name,type:e.type,chatId:e.association.chatId,labelId:e.association.labelId})}};this.instance.qrcode={count:0},this.authStateProvider=new xi(this.providerFiles)}get connectionStatus(){return this.stateConnection}async logoutInstance(){await this.client?.logout("Log out instance: "+this.instanceName),this.client?.ws?.close(),await this.prismaRepository.session.findFirst({where:{sessionId:this.instanceId}})&&await this.prismaRepository.session.delete({where:{sessionId:this.instanceId}})}async getProfileName(){let e=this.client.user?.name??this.client.user?.verifiedName;if(!e){let t=await this.prismaRepository.session.findUnique({where:{sessionId:this.instanceId}});if(t){let s=JSON.parse(JSON.stringify(t.creds),A.BufferJSON.reviver);e=s.me?.name||s.me?.verifiedName}}return e}async getProfileStatus(){return(await this.client.fetchStatus(this.instance.wuid))?.status}get profilePictureUrl(){return this.instance.profilePictureUrl}get qrCode(){return{pairingCode:this.instance.qrcode?.pairingCode,code:this.instance.qrcode?.code,base64:this.instance.qrcode?.base64,count:this.instance.qrcode?.count}}async connectionUpdate({qr:e,connection:t,lastDisconnect:s}){if(e){if(this.instance.qrcode.count===this.configService.get("QRCODE").LIMIT)return this.sendDataWebhook("qrcode.updated",{message:"QR code limit reached, please login again",statusCode:A.DisconnectReason.badSession}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("qrcode.updated",{instanceName:this.instance.name,instanceId:this.instanceId},{message:"QR code limit reached, please login again",statusCode:A.DisconnectReason.badSession}),this.sendDataWebhook("connection.update",{instance:this.instance.name,state:"refused",statusReason:A.DisconnectReason.connectionClosed}),this.endSession=!0,this.eventEmitter.emit("no.connection",this.instance.name);this.instance.qrcode.count++;let n={margin:3,scale:4,errorCorrectionLevel:"H",color:{light:"#ffffff",dark:this.configService.get("QRCODE").COLOR}};this.phoneNumber?(await(0,A.delay)(1e3),this.instance.qrcode.pairingCode=await this.client.requestPairingCode(this.phoneNumber)):this.instance.qrcode.pairingCode=null,Ha.default.toDataURL(e,n,(r,a)=>{if(r){this.logger.error("Qrcode generate failed:"+r.toString());return}this.instance.qrcode.base64=a,this.instance.qrcode.code=e,this.sendDataWebhook("qrcode.updated",{qrcode:{instance:this.instance.name,pairingCode:this.instance.qrcode.pairingCode,code:e,base64:a}}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("qrcode.updated",{instanceName:this.instance.name,instanceId:this.instanceId},{qrcode:{instance:this.instance.name,pairingCode:this.instance.qrcode.pairingCode,code:e,base64:a}})}),ja.default.generate(e,{small:!0},r=>this.logger.log(`
{ instance: ${this.instance.name} pairingCode: ${this.instance.qrcode.pairingCode}, qrcodeCount: ${this.instance.qrcode.count} }
`+r)),await this.prismaRepository.instance.update({where:{id:this.instanceId},data:{connectionStatus:"connecting"}})}if(t&&(this.stateConnection={state:t,statusReason:s?.error?.output?.statusCode??200},this.sendDataWebhook("connection.update",{instance:this.instance.name,...this.stateConnection})),t==="close"){let o=s?.error?.output?.statusCode;![A.DisconnectReason.loggedOut,A.DisconnectReason.forbidden,402,406].includes(o)?await this.connectToWhatsapp(this.phoneNumber):(this.sendDataWebhook("status.instance",{instance:this.instance.name,status:"closed",disconnectionAt:new Date,disconnectionReasonCode:o,disconnectionObject:JSON.stringify(s)}),await this.prismaRepository.instance.update({where:{id:this.instanceId},data:{connectionStatus:"close",disconnectionAt:new Date,disconnectionReasonCode:o,disconnectionObject:JSON.stringify(s)}}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("status.instance",{instanceName:this.instance.name,instanceId:this.instanceId},{instance:this.instance.name,status:"closed"}),this.eventEmitter.emit("logout.instance",this.instance.name,"inner"),this.client?.ws?.close(),this.client.end(new Error("Close connection")))}if(t==="open"){this.instance.wuid=this.client.user.id.replace(/:\d+/,""),this.instance.profilePictureUrl=(await this.profilePicture(this.instance.wuid)).profilePictureUrl;let o=this.instance.wuid.split("@")[0].padEnd(30," "),n=this.instance.name;this.logger.info(`
        \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510
        \u2502    CONNECTED TO WHATSAPP     \u2502
        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518`.replace(/^ +/gm,"  ")),this.logger.info(`
        wuid: ${o}
        name: ${n}
      `),await this.prismaRepository.instance.update({where:{id:this.instanceId},data:{ownerJid:this.instance.wuid,profileName:await this.getProfileName(),profilePicUrl:this.instance.profilePictureUrl,connectionStatus:"open"}}),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.chatwootService.eventWhatsapp("connection.update",{instanceName:this.instance.name,instanceId:this.instanceId},{instance:this.instance.name,status:"open"})}}async getMessage(e,t=!1){try{let s=await this.prismaRepository.message.findMany({where:{instanceId:this.instanceId,key:{path:["id"],equals:e.id}}});if(t)return s[0];if(s[0].message?.pollCreationMessage){let o=s[0].message?.messageContextInfo?.messageSecret;if(typeof o=="string")return{messageContextInfo:{messageSecret:Buffer.from(o,"base64")},pollCreationMessage:s[0].message?.pollCreationMessage}}return s[0].message}catch{return this.logger.error("line 508"),{conversation:""}}}async defineAuthState(){let e=this.configService.get("DATABASE"),t=this.configService.get("CACHE");if(this.configService.get("PROVIDER")?.ENABLED)return await this.authStateProvider.authStateProvider(this.instance.id);if(t?.REDIS.ENABLED&&t?.REDIS.SAVE_INSTANCES)return this.logger.info("Redis enabled"),await qa(this.instance.id,this.cache);if(e.SAVE_DATA.INSTANCE)return await Gn(this.instance.id,this.cache)}async createClient(e){this.instance.authState=await this.defineAuthState();let t=this.configService.get("CONFIG_SESSION_PHONE"),s={};if(e||this.phoneNumber)this.phoneNumber=e,this.logger.info(`Phone number: ${e}`);else{let c=[t.CLIENT,t.NAME,(0,Ga.release)()];s={browser:c},this.logger.info(`Browser: ${c}`)}let o,n;t.VERSION?(o=t.VERSION.split("."),n=`Baileys version env: ${o}`):(o=(await(0,A.fetchLatestBaileysVersion)()).version,n=`Baileys version: ${o}`),this.logger.info(n),this.logger.info(`Group Ignore: ${this.localSettings.groupsIgnore}`);let r;if(this.localProxy?.enabled)if(this.logger.info("Proxy enabled: "+this.localProxy?.host),this.localProxy?.host?.includes("proxyscrape"))try{let d=(await De.default.get(this.localProxy?.host)).data.split(`\r
`),l=Math.floor(Math.random()*Math.floor(d.length)),g="http://"+d[l];r={agent:le(g),fetchAgent:le(g)}}catch{this.localProxy.enabled=!1}else r={agent:le({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password}),fetchAgent:le({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})};let a={...r,version:o,logger:(0,nt.default)({level:this.logBaileys}),printQRInTerminal:!1,auth:{creds:this.instance.authState.state.creds,keys:(0,A.makeCacheableSignalKeyStore)(this.instance.authState.state.keys,(0,nt.default)({level:"error"}))},msgRetryCounterCache:this.msgRetryCounterCache,generateHighQualityLinkPreview:!0,getMessage:async c=>await this.getMessage(c),...s,markOnlineOnConnect:this.localSettings.alwaysOnline,retryRequestDelayMs:350,maxMsgRetryCount:4,fireInitQueries:!0,connectTimeoutMs:3e4,keepAliveIntervalMs:3e4,qrTimeout:45e3,emitOwnEvents:!1,shouldIgnoreJid:c=>{let u=this.localSettings.groupsIgnore&&(0,A.isJidGroup)(c),d=!this.localSettings.readStatus&&(0,A.isJidBroadcast)(c),l=(0,A.isJidNewsletter)(c);return u||d||l},syncFullHistory:this.localSettings.syncFullHistory,shouldSyncHistoryMessage:c=>this.historySyncNotification(c),cachedGroupMetadata:this.getGroupMetadataCache,userDevicesCache:this.userDevicesCache,transactionOpts:{maxCommitRetries:10,delayBetweenTriesMs:3e3}};return this.endSession=!1,this.client=(0,A.default)(a),this.eventHandler(),this.phoneNumber=e,this.client}async connectToWhatsapp(e){try{return this.loadChatwoot(),this.loadSettings(),this.loadProxy(),await this.createClient(e)}catch(t){throw this.logger.error("line 667"),this.logger.error(t),new N(t?.toString())}}async reloadConnection(){try{return await this.createClient(this.phoneNumber)}catch(e){throw this.logger.error("line 677"),this.logger.error(e),new N(e?.toString())}}eventHandler(){this.client.ev.process(async e=>{if(!this.endSession){let t=this.configService.get("DATABASE"),s=await this.findSettings();if(e.call){let o=e.call[0];if(s?.rejectCall&&o.status=="offer"&&this.client.rejectCall(o.id,o.from),s?.msgCall?.trim().length>0&&o.status=="offer"){let n=await this.client.sendMessage(o.from,{text:s.msgCall});this.client.ev.emit("messages.upsert",{messages:[n],type:"notify"})}this.sendDataWebhook("call",o)}if(e["connection.update"]&&this.connectionUpdate(e["connection.update"]),e["creds.update"]&&this.instance.authState.saveCreds(),e["messaging-history.set"]){let o=e["messaging-history.set"];this.messageHandle["messaging-history.set"](o)}if(e["messages.upsert"]){let o=e["messages.upsert"];this.messageHandle["messages.upsert"](o,s)}if(e["messages.update"]){let o=e["messages.update"];this.messageHandle["messages.update"](o,s)}if(e["presence.update"]){let o=e["presence.update"];if(s?.groupsIgnore&&o.id.includes("@g.us"))return;this.sendDataWebhook("presence.update",o)}if(!s?.groupsIgnore){if(e["groups.upsert"]){let o=e["groups.upsert"];this.groupHandler["groups.upsert"](o)}if(e["groups.update"]){let o=e["groups.update"];this.groupHandler["groups.update"](o)}if(e["group-participants.update"]){let o=e["group-participants.update"];this.groupHandler["group-participants.update"](o)}}if(e["chats.upsert"]){let o=e["chats.upsert"];this.chatHandle["chats.upsert"](o)}if(e["chats.update"]){let o=e["chats.update"];this.chatHandle["chats.update"](o)}if(e["chats.delete"]){let o=e["chats.delete"];this.chatHandle["chats.delete"](o)}if(e["contacts.upsert"]){let o=e["contacts.upsert"];this.contactHandle["contacts.upsert"](o)}if(e["contacts.update"]){let o=e["contacts.update"];this.contactHandle["contacts.update"](o)}if(e["labels.association"]){let o=e["labels.association"];this.labelHandle["labels.association"](o,t);return}if(e["labels.edit"]){let o=e["labels.edit"];this.labelHandle["labels.edit"](o);return}}})}historySyncNotification(e){let t={instanceName:this.instance.name};return this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&this.localChatwoot.importMessages&&this.isSyncNotificationFromUsedSyncType(e)&&(e.chunkOrder===1&&this.chatwootService.startImportHistoryMessages(t),e.progress===100&&setTimeout(()=>{this.chatwootService.importHistoryMessages(t)},1e4)),!0}isSyncNotificationFromUsedSyncType(e){return this.localSettings.syncFullHistory&&e?.syncType===2||!this.localSettings.syncFullHistory&&e?.syncType===3}async profilePicture(e){let t=this.createJid(e);try{let s=await this.client.profilePictureUrl(t,"image");return{wuid:t,profilePictureUrl:s}}catch{return{wuid:t,profilePictureUrl:null}}}async getStatus(e){let t=this.createJid(e);try{return{wuid:t,status:(await this.client.fetchStatus(t))?.status}}catch{return{wuid:t,status:null}}}async fetchProfile(e,t){let s=t?this.createJid(t):this.client?.user?.id,o=(await this.whatsappNumber({numbers:[s]}))?.shift();if(!o.exists)throw new m(o);try{if(t){let n=(await this.whatsappNumber({numbers:[s]}))?.shift(),r=await this.profilePicture(n?.jid),a=await this.getStatus(n?.jid),c=await this.fetchBusinessProfile(n?.jid);return{wuid:n?.jid||s,name:n?.name,numberExists:n?.exists,picture:r?.profilePictureUrl,status:a?.status,isBusiness:c.isBusiness,email:c?.email,description:c?.description,website:c?.website?.shift()}}else{let n=await x.instanceInfo(e),r=await this.fetchBusinessProfile(s);return{wuid:s,name:n?.profileName,numberExists:!0,picture:n?.profilePicUrl,status:n?.connectionStatus,isBusiness:r.isBusiness,email:r?.email,description:r?.description,website:r?.website?.shift()}}}catch{return{wuid:s,name:null,picture:null,status:null,os:null,isBusiness:!1}}}async sendMessage(e,t,s,o,n,r,a){let c={quoted:n};if((0,A.isJidGroup)(e)&&(c.useCachedGroupMetadata=!0),a&&(c.ephemeralExpiration=a),r?c.messageId=r:c.messageId="3EB0"+(0,$a.randomBytes)(18).toString("hex").toUpperCase(),!t.audio&&!t.poll&&!t.sticker&&!t.conversation&&e!=="status@broadcast"&&t.reactionMessage)return await this.client.sendMessage(e,{react:{text:t.reactionMessage.text,key:t.reactionMessage.key}},c);if(t.conversation)return await this.client.sendMessage(e,{text:t.conversation,mentions:s,linkPreview:o},c);if(!t.audio&&!t.poll&&!t.sticker&&e!="status@broadcast")return await this.client.sendMessage(e,{forward:{key:{remoteJid:this.instance.wuid,fromMe:!0},message:t},mentions:s},c);if(e==="status@broadcast"){let u=t.status.option.statusJidList,d=500,l=Array.from({length:Math.ceil(u.length/d)},(f,w)=>u.slice(w*d,w*d+d)),g=null,h,y=l.shift();return y&&(h=await this.client.sendMessage(e,t.status.content,{backgroundColor:t.status.option.backgroundColor,font:t.status.option.font,statusJidList:y}),g=h.key.id),l.length===0||await Promise.allSettled(l.map(async f=>await this.client.sendMessage(e,t.status.content,{backgroundColor:t.status.option.backgroundColor,font:t.status.option.font,statusJidList:f,messageId:g}))),h}return await this.client.sendMessage(e,t,c)}async sendMessageWithTyping(e,t,s,o=!1){let n=(await this.whatsappNumber({numbers:[e]}))?.shift();if(!n.exists&&!(0,A.isJidGroup)(n.jid)&&!n.jid.includes("@broadcast")){if(this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled){let a={key:{remoteJid:n.jid}};this.chatwootService.eventWhatsapp("contact.is_not_in_wpp",{instanceName:this.instance.name,instanceId:this.instance.id},a)}throw new m(n)}let r=n.jid;this.logger.verbose(`Sending message to ${r}`);try{if(s?.delay)if(this.logger.verbose(`Typing for ${s.delay}ms to ${r}`),s.delay>2e4){let h=s.delay;for(;h>2e4;)await this.client.presenceSubscribe(r),await this.client.sendPresenceUpdate(s.presence??"composing",r),await(0,A.delay)(2e4),await this.client.sendPresenceUpdate("paused",r),h-=2e4;h>0&&(await this.client.presenceSubscribe(r),await this.client.sendPresenceUpdate(s.presence??"composing",r),await(0,A.delay)(h),await this.client.sendPresenceUpdate("paused",r))}else await this.client.presenceSubscribe(r),await this.client.sendPresenceUpdate(s.presence??"composing",r),await(0,A.delay)(s.delay),await this.client.sendPresenceUpdate("paused",r);let a=s?.linkPreview!=!1?void 0:!1,c;if(s?.quoted){let h=s?.quoted,y=h?.message?h:await this.getMessage(h.key,!0);y&&(c=y)}let u,d;if((0,A.isJidGroup)(r)){let h;try{let y=this.configService.get("CACHE");!y.REDIS.ENABLED&&!y.LOCAL.ENABLED?h=await this.findGroup({groupJid:r},"inner"):h=await this.getGroupMetadataCache(r)}catch{throw new _("Group not found")}if(!h)throw new _("Group not found");s.mentionsEveryOne?d=h.participants.map(y=>y.id):s.mentioned?.length&&(d=s.mentioned.map(y=>{let f=this.createJid(y);return(0,A.isJidGroup)(f)?null:f})),u=await this.sendMessage(r,t,d,a,c,null,h?.ephemeralDuration)}else u=await this.sendMessage(r,t,d,a,c);Ni.default.isLong(u?.messageTimestamp)&&(u.messageTimestamp=u.messageTimestamp?.toNumber());let l=this.prepareMessage(u),g=u?.message?.imageMessage||u?.message?.videoMessage||u?.message?.stickerMessage||u?.message?.documentMessage||u?.message?.documentWithCaptionMessage||u?.message?.audioMessage;if(this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&!o&&this.chatwootService.eventWhatsapp("send.message",{instanceName:this.instance.name,instanceId:this.instanceId},l),this.configService.get("OPENAI").ENABLED){let h=await this.prismaRepository.openaiSetting.findFirst({where:{instanceId:this.instanceId},include:{OpenaiCreds:!0}});h&&h.openaiCredsId&&h.speechToText&&l?.message?.audioMessage&&(l.message.speechToText=await this.openaiService.speechToText(h.OpenaiCreds,l,this.client.updateMediaMessage))}if(this.configService.get("DATABASE").SAVE_DATA.NEW_MESSAGE){let h=await this.prismaRepository.message.create({data:l});if(g&&this.configService.get("S3").ENABLE)try{let y=l,f=await this.getBase64FromMediaMessage({message:y},!0),{buffer:w,mediaType:I,fileName:b,size:S}=f,C=kt.default.getType(b).toString(),P=(0,ki.join)(`${this.instance.id}`,l.key.remoteJid,I,b);await At(P,w,S.fileLength?.low,{"Content-Type":C}),await this.prismaRepository.media.create({data:{messageId:h.id,instanceId:this.instanceId,type:I,fileName:P,mimetype:C}});let L=await Ue(P);l.message.mediaUrl=L,await this.prismaRepository.message.update({where:{id:h.id},data:l})}catch(y){this.logger.error("line 1181"),this.logger.error(["Error on upload file to minio",y?.message,y?.stack])}}if(g&&!this.configService.get("S3").ENABLE){let h=await(0,A.downloadMediaMessage)({key:l.key,message:l?.message},"buffer",{},{logger:(0,nt.default)({level:"error"}),reuploadRequest:this.client.updateMediaMessage});l.message.base64=h?h.toString("base64"):void 0}return this.logger.log(l),this.sendDataWebhook("send.message",l),this.configService.get("CHATWOOT").ENABLED&&this.localChatwoot?.enabled&&o&&await Ee.emit({instance:{instanceName:this.instance.name,instanceId:this.instanceId},remoteJid:l.key.remoteJid,msg:l,pushName:l.pushName,isIntegration:o}),l}catch(a){throw this.logger.error("line 2097"),this.logger.error(a),new m(a.toString())}}async sendPresence(e){try{let{number:t}=e,s=(await this.whatsappNumber({numbers:[t]}))?.shift();if(!s.exists&&!(0,A.isJidGroup)(s.jid)&&!s.jid.includes("@broadcast"))throw new m(s);let o=s.jid;if(e?.delay&&e?.delay>2e4){let n=e?.delay;for(;n>2e4;)await this.client.presenceSubscribe(o),await this.client.sendPresenceUpdate(e?.presence??"composing",o),await(0,A.delay)(2e4),await this.client.sendPresenceUpdate("paused",o),n-=2e4;n>0&&(await this.client.presenceSubscribe(o),await this.client.sendPresenceUpdate(e?.presence??"composing",o),await(0,A.delay)(n),await this.client.sendPresenceUpdate("paused",o))}else await this.client.presenceSubscribe(o),await this.client.sendPresenceUpdate(e?.presence??"composing",o),await(0,A.delay)(e?.delay),await this.client.sendPresenceUpdate("paused",o);return{presence:e.presence}}catch(t){throw this.logger.error("line 2134"),this.logger.error(t),new m(t.toString())}}async setPresence(e){try{return await this.client.sendPresenceUpdate(e.presence),{presence:e.presence}}catch(t){throw this.logger.error("line 2147"),this.logger.error(t),new m(t.toString())}}async textMessage(e,t=!1){let s=e.text;if(!s||s.trim().length===0)throw new m("Text is required");return await this.sendMessageWithTyping(e.number,{conversation:e.text},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async pollMessage(e){return await this.sendMessageWithTyping(e.number,{poll:{name:e.name,selectableCount:e.selectableCount,values:e.values}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,linkPreview:e?.linkPreview,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async formatStatusMessage(e){if(!e.type)throw new m("Type is required");if(!e.content)throw new m("Content is required");if(e.allContacts){let t=await this.prismaRepository.contact.findMany({where:{instanceId:this.instanceId}});if(!t.length)throw new m("Contacts not found");e.statusJidList=t.filter(s=>s.pushName).map(s=>s.remoteJid)}if(!e.statusJidList?.length&&!e.allContacts)throw new m("StatusJidList is required");if(e.type==="text"){if(!e.backgroundColor)throw new m("Background color is required");if(!e.font)throw new m("Font is required");return{content:{text:e.content},option:{backgroundColor:e.backgroundColor,font:e.font,statusJidList:e.statusJidList}}}if(e.type==="image")return{content:{image:{url:e.content},caption:e.caption},option:{statusJidList:e.statusJidList}};if(e.type==="video")return{content:{video:{url:e.content},caption:e.caption},option:{statusJidList:e.statusJidList}};if(e.type==="audio"){let t=await this.processAudioMp4(e.content);if(Buffer.isBuffer(t))return{content:{audio:t,ptt:!0,mimetype:"audio/ogg; codecs=opus"},option:{statusJidList:e.statusJidList}};throw new N(t)}throw new m("Type not found")}async statusMessage(e){let t=await this.formatStatusMessage(e);return await this.sendMessageWithTyping("status@broadcast",{status:t})}async prepareMediaMessage(e){try{let t=await(0,A.prepareWAMessageMedia)({[e.mediatype]:(0,ae.isURL)(e.media)?{url:e.media}:Buffer.from(e.media,"base64")},{upload:this.client.waUploadToServer}),s=e.mediatype+"Message";if(e.mediatype==="document"&&!e.fileName){let r=new RegExp(/.*\/(.+?)\./).exec(e.media);e.fileName=r[1]}e.mediatype==="image"&&!e.fileName&&(e.fileName="image.png"),e.mediatype==="video"&&!e.fileName&&(e.fileName="video.mp4");let o;if(e.mimetype)o=e.mimetype;else if(o=kt.default.getType(e.fileName),!o&&(0,ae.isURL)(e.media)){let n={responseType:"arraybuffer"};this.localProxy?.enabled&&(n={...n,httpsAgent:le({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})}),o=(await De.default.get(e.media,n)).headers["content-type"]}return t[s].caption=e?.caption,t[s].mimetype=o,t[s].fileName=e.fileName,e.mediatype==="video"&&(t[s].jpegThumbnail=Uint8Array.from((0,Va.readFileSync)((0,ki.join)(process.cwd(),"public","images","video-cover.png"))),t[s].gifPlayback=!1),(0,A.generateWAMessageFromContent)("",{[s]:{...t[s]}},{userJid:this.instance.wuid})}catch(t){throw this.logger.error("line 2378"),this.logger.error(t),new N(t?.toString()||t)}}async convertToWebP(e){try{let t;if((0,ae.isBase64)(e)){let o=e.replace(/^data:image\/(jpeg|png|gif);base64,/,"");t=Buffer.from(o,"base64")}else{let o=new Date().getTime(),n=`${e}?timestamp=${o}`,r={responseType:"arraybuffer"};this.localProxy?.enabled&&(r={...r,httpsAgent:le({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})});let a=await De.default.get(n,r);t=Buffer.from(a.data,"binary")}return await(0,Ka.default)(t).webp().toBuffer()}catch(t){throw this.logger.error("line 2420"),console.error("Erro ao converter a imagem para WebP:",t),t}}async mediaSticker(e){let t=await this.convertToWebP(e.sticker),s=e.sticker.includes(".gif");return await this.sendMessageWithTyping(e.number,{sticker:t,gifPlayback:s},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async mediaMessage(e,t=!1){let s=await this.prepareMediaMessage(e);return await this.sendMessageWithTyping(e.number,{...s.message},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned},t)}async processAudioMp4(e){let t;if((0,ae.isURL)(e)){let s=new Date().getTime(),o=`${e}?timestamp=${s}`,n={responseType:"stream"};t=(await De.default.get(o,n)).data.pipe(new Ve.PassThrough)}else{let s=Buffer.from(e,"base64");t=new Ve.PassThrough,t.end(s)}return new Promise((s,o)=>{let n=new Ve.PassThrough,r=[];n.on("data",a=>r.push(a)),n.on("end",()=>{let a=Buffer.concat(r);s(a)}),n.on("error",a=>{console.log("error",a),o(a)}),Nt.default.setFfmpegPath(jn.default.path),(0,Nt.default)(t).outputFormat("mp4").noVideo().audioCodec("aac").audioBitrate("128k").audioFrequency(44100).addOutputOptions("-f ipod").pipe(n,{end:!0}).on("error",function(a){console.log("error",a),o(a)})})}async processAudio(e){let t;if((0,ae.isURL)(e)){let s=new Date().getTime(),o=`${e}?timestamp=${s}`,n={responseType:"stream"};t=(await De.default.get(o,n)).data.pipe(new Ve.PassThrough)}else{let s=Buffer.from(e,"base64");t=new Ve.PassThrough,t.end(s)}return new Promise((s,o)=>{let n=new Ve.PassThrough,r=[];n.on("data",a=>r.push(a)),n.on("end",()=>{let a=Buffer.concat(r);s(a)}),n.on("error",a=>{console.log("error",a),o(a)}),Nt.default.setFfmpegPath(jn.default.path),(0,Nt.default)(t).outputFormat("ogg").noVideo().audioCodec("libopus").addOutputOptions("-avoid_negative_ts make_zero").audioChannels(1).pipe(n,{end:!0}).on("error",function(a){console.log("error",a),o(a)})})}async audioWhatsapp(e,t=!1){if(!e?.encoding&&e?.encoding!==!1&&(e.encoding=!0),e?.encoding){let s=await this.processAudio(e.audio);if(Buffer.isBuffer(s))return this.sendMessageWithTyping(e.number,{audio:s,ptt:!0,mimetype:"audio/ogg; codecs=opus"},{presence:"recording",delay:e?.delay},t);throw new N("Failed to convert audio")}return await this.sendMessageWithTyping(e.number,{audio:(0,ae.isURL)(e.audio)?{url:e.audio}:Buffer.from(e.audio,"base64"),ptt:!0,mimetype:"audio/ogg; codecs=opus"},{presence:"recording",delay:e?.delay},t)}async buttonMessage(){throw new m("Method not available on WhatsApp Baileys")}async locationMessage(e){return await this.sendMessageWithTyping(e.number,{locationMessage:{degreesLatitude:e.latitude,degreesLongitude:e.longitude,name:e?.name,address:e?.address}},{delay:e?.delay,presence:"composing",quoted:e?.quoted,mentionsEveryOne:e?.mentionsEveryOne,mentioned:e?.mentioned})}async listMessage(){throw new m("Method not available on WhatsApp Baileys")}async contactMessage(e){let t={},s=o=>{let n=`BEGIN:VCARD
VERSION:3.0
N:${o.fullName}
FN:${o.fullName}
`;return o.organization&&(n+=`ORG:${o.organization};
`),o.email&&(n+=`EMAIL:${o.email}
`),o.url&&(n+=`URL:${o.url}
`),o.wuid||(o.wuid=this.createJid(o.phoneNumber)),n+=`item1.TEL;waid=${o.wuid}:${o.phoneNumber}
item1.X-ABLabel:Celular
END:VCARD`,n};return e.contact.length===1?t.contactMessage={displayName:e.contact[0].fullName,vcard:s(e.contact[0])}:t.contactsArrayMessage={displayName:`${e.contact.length} contacts`,contacts:e.contact.map(o=>({displayName:o.fullName,vcard:s(o)}))},await this.sendMessageWithTyping(e.number,{...t},{})}async reactionMessage(e){return await this.sendMessageWithTyping(e.key.remoteJid,{reactionMessage:{key:e.key,text:e.reaction}})}async whatsappNumber(e){let t={groups:[],broadcast:[],users:[]};e.numbers.forEach(l=>{let g=this.createJid(l);(0,A.isJidGroup)(g)?t.groups.push({number:l,jid:g}):g==="status@broadcast"?t.broadcast.push({number:l,jid:g}):t.users.push({number:l,jid:g})});let s=[];s.push(...t.broadcast.map(({jid:l,number:g})=>new Xe(l,!1,g)));let o=await Promise.all(t.groups.map(async({jid:l,number:g})=>{let h=await this.findGroup({groupJid:l},"inner");return h||new Xe(l,!1,g),new Xe(h.id,!!h?.id,g,h?.subject)}));s.push(...o);let n=await this.prismaRepository.contact.findMany({where:{instanceId:this.instanceId,remoteJid:{in:t.users.map(({jid:l})=>l)}}}),r=t.users.map(({jid:l})=>l.replace("+","")),a=await Fa(r),c=r.filter(l=>!a.some(g=>g.jidOptions.includes(l))),u=await this.client.onWhatsApp(...c),d=await Promise.all(t.users.map(async l=>{let g=null,h=a.find(f=>f.jidOptions.includes(l.jid.replace("+","")));if(h)return{exists:!0,jid:h.remoteJid,name:n.find(f=>f.remoteJid===h.remoteJid)?.pushName,number:l.number};if(l.number.startsWith("55")){let f=l.number.slice(4,5)==="9"&&l.number.length===13?l.number:`${l.number.slice(0,4)}9${l.number.slice(4)}`,w=l.number.length===12?l.number:l.number.slice(0,4)+l.number.slice(5);g=u.find(I=>I.jid===`${f}@s.whatsapp.net`||I.jid===`${w}@s.whatsapp.net`)}if(!g&&(l.number.startsWith("52")||l.number.startsWith("54"))){let f="";l.number.startsWith("52")&&(f="1"),l.number.startsWith("54")&&(f="9");let w=l.number.slice(2,3)===f&&l.number.length===13?l.number:`${l.number.slice(0,2)}${f}${l.number.slice(2)}`,I=l.number.length===12?l.number:l.number.slice(0,2)+l.number.slice(3);g=u.find(b=>b.jid===`${w}@s.whatsapp.net`||b.jid===`${I}@s.whatsapp.net`)}g||(g=u.find(f=>f.jid===l.jid));let y=g?.jid||l.jid;return{exists:!!g?.exists,jid:y,name:n.find(f=>f.remoteJid===y)?.pushName,number:l.number}}));return await We(d.filter(l=>l.exists).map(l=>({remoteJid:l.jid}))),s.push(...d),s}async markMessageAsRead(e){try{let t=[];return e.readMessages.forEach(s=>{((0,A.isJidGroup)(s.remoteJid)||(0,A.isJidUser)(s.remoteJid))&&t.push({remoteJid:s.remoteJid,fromMe:s.fromMe,id:s.id})}),await this.client.readMessages(t),{message:"Read messages",read:"success"}}catch(t){throw this.logger.error("line 2818"),new N("Read messages fail",t.toString())}}async getLastMessage(e){let t={key:{remoteJid:e},instanceId:this.instance.id},s=await this.prismaRepository.message.findMany({where:t,orderBy:{messageTimestamp:"desc"},take:1});if(s.length===0)throw new _("Messages not found");let o=s.pop();for(let n of s)n.messageTimestamp>=o.messageTimestamp&&(o=n);return o}async archiveChat(e){try{let t=e.lastMessage,s=e.chat;if(!t&&s?t=await this.getLastMessage(s):(t=e.lastMessage,t.messageTimestamp=t?.messageTimestamp??Date.now(),s=t?.key?.remoteJid),!t||Object.keys(t).length===0)throw new _("Last message not found");return await this.client.chatModify({archive:e.archive,lastMessages:[t]},this.createJid(s)),{chatId:s,archived:!0}}catch(t){throw this.logger.error("line 2884"),new N({archived:!1,message:["An error occurred while archiving the chat. Open a calling.",t.toString()]})}}async markChatUnread(e){try{let t=e.lastMessage,s=e.chat;if(!t&&s?t=await this.getLastMessage(s):(t=e.lastMessage,t.messageTimestamp=t?.messageTimestamp??Date.now(),s=t?.key?.remoteJid),!t||Object.keys(t).length===0)throw new _("Last message not found");return await this.client.chatModify({markRead:!1,lastMessages:[t]},this.createJid(s)),{chatId:s,markedChatUnread:!0}}catch(t){throw this.logger.error("line 2922"),new N({markedChatUnread:!1,message:["An error occurred while marked unread the chat. Open a calling.",t.toString()]})}}async deleteMessage(e){try{return await this.client.sendMessage(e.remoteJid,{delete:e})}catch(t){throw this.logger.error("line 2934"),new N("Error while deleting message for everyone",t?.toString())}}async getBase64FromMediaMessage(e,t=!1){try{let s=e?.message,o=e?.convertToMp4??!1,n=s?.message?s:await this.getMessage(s.key,!0);if(!n)throw"Message not found";for(let g of sr)n.message[g]&&(n.message=n.message[g].message);let r,a;for(let g of tr)if(r=n.message[g],r){a=g;break}if(!r)throw"The message is not of the media type";typeof r.mediaKey=="object"&&(n.message=JSON.parse(JSON.stringify(n.message)));let c=await(0,A.downloadMediaMessage)({key:n?.key,message:n?.message},"buffer",{},{logger:(0,nt.default)({level:"error"}),reuploadRequest:this.client.updateMediaMessage}),u=(0,A.getContentType)(n.message),d=kt.default.getExtension(r?.mimetype),l=r?.fileName||`${n.key.id}.${d}`||`${(0,Ya.v4)()}.${d}`;if(o&&u==="audioMessage"){let g=await this.processAudioMp4(c.toString("base64"));if(Buffer.isBuffer(g))return{mediaType:a,fileName:l,caption:r.caption,size:{fileLength:r.fileLength,height:r.height,width:r.width},mimetype:"audio/mp4",base64:g,buffer:t?g:null}}return{mediaType:a,fileName:l,caption:r.caption,size:{fileLength:r.fileLength,height:r.height,width:r.width},mimetype:r.mimetype,base64:c.toString("base64"),buffer:t?c:null}}catch(s){throw this.logger.error("line 3026"),this.logger.error(s),new m(s.toString())}}async fetchPrivacySettings(){let e=await this.client.fetchPrivacySettings();return{readreceipts:e.readreceipts,profile:e.profile,status:e.status,online:e.online,last:e.last,groupadd:e.groupadd}}async updatePrivacySettings(e){try{return await this.client.updateReadReceiptsPrivacy(e.readreceipts),await this.client.updateProfilePicturePrivacy(e.profile),await this.client.updateStatusPrivacy(e.status),await this.client.updateOnlinePrivacy(e.online),await this.client.updateLastSeenPrivacy(e.last),await this.client.updateGroupsAddPrivacy(e.groupadd),this.reloadConnection(),{update:"success",data:{readreceipts:e.readreceipts,profile:e.profile,status:e.status,online:e.online,last:e.last,groupadd:e.groupadd}}}catch(t){throw this.logger.error("line 3068"),new N("Error updating privacy settings",t.toString())}}async fetchBusinessProfile(e){try{let t=e?this.createJid(e):this.instance.wuid,s=await this.client.getBusinessProfile(t);return s?{isBusiness:!0,...s}:{isBusiness:!1,message:"Not is business profile",...(await this.whatsappNumber({numbers:[t]}))?.shift()}}catch(t){throw this.logger.error("line 3094"),new N("Error updating profile name",t.toString())}}async updateProfileName(e){try{return await this.client.updateProfileName(e),{update:"success"}}catch(t){throw this.logger.error("line 3105"),new N("Error updating profile name",t.toString())}}async updateProfileStatus(e){try{return await this.client.updateProfileStatus(e),{update:"success"}}catch(t){throw this.logger.error("line 3116"),new N("Error updating profile status",t.toString())}}async updateProfilePicture(e){try{let t;if((0,ae.isURL)(e)){let s=new Date().getTime(),o=`${e}?timestamp=${s}`,n={responseType:"arraybuffer"};this.localProxy?.enabled&&(n={...n,httpsAgent:le({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})}),t=(await De.default.get(o,n)).data}else if((0,ae.isBase64)(e))t=Buffer.from(e,"base64");else throw new m('"profilePicture" must be a url or a base64');return await this.client.updateProfilePicture(this.instance.wuid,t),this.reloadConnection(),{update:"success"}}catch(t){throw this.logger.error("line 3158"),new N("Error updating profile picture",t.toString())}}async removeProfilePicture(){try{return await this.client.removeProfilePicture(this.instance.wuid),this.reloadConnection(),{update:"success"}}catch(e){throw this.logger.error("line 3171"),new N("Error removing profile picture",e.toString())}}async blockUser(e){try{let{number:t}=e,s=(await this.whatsappNumber({numbers:[t]}))?.shift();if(!s.exists&&!(0,A.isJidGroup)(s.jid)&&!s.jid.includes("@broadcast"))throw new m(s);let o=s.jid;return await this.client.updateBlockStatus(o,e.status),{block:"success"}}catch(t){throw this.logger.error("line 3192"),new N("Error blocking user",t.toString())}}async formatUpdateMessage(e){try{let t=await this.getMessage(e.key,!0);return t?.messageType==="conversation"||t?.messageType==="extendedTextMessage"?{text:e.text}:t?.messageType==="imageMessage"?{image:t?.message?.imageMessage,caption:e.text}:t?.messageType==="videoMessage"?{video:t?.message?.videoMessage,caption:e.text}:null}catch(t){throw this.logger.error("line 3223"),this.logger.error(t),new m(t.toString())}}async updateMessage(e){let t=this.createJid(e.number),s=await this.formatUpdateMessage(e);if(!s)throw this.logger.error("Message not compatible"),new m("Message not compatible");try{return await this.client.sendMessage(t,{...s,edit:e.key})}catch(o){throw this.logger.error("line 3245"),this.logger.error(o),new m(o.toString())}}async fetchLabels(){return(await this.prismaRepository.label.findMany({where:{instanceId:this.instanceId}})).map(t=>({color:t.color,name:t.name,id:t.labelId,predefinedId:t.predefinedId}))}async handleLabel(e){let t=await this.whatsappNumber({numbers:[e.number]});if(t.length===0)throw new _("Number not found");let s=t[0];if(!s.exists)throw new _("Number is not on WhatsApp");try{if(e.action==="add")return await this.client.addChatLabel(s.jid,e.labelId),{numberJid:s.jid,labelId:e.labelId,add:!0};if(e.action==="remove")return await this.client.removeChatLabel(s.jid,e.labelId),{numberJid:s.jid,labelId:e.labelId,remove:!0}}catch(o){throw this.logger.error("line 3288"),new m(`Unable to ${e.action} label to chat`,o.toString())}}async updateGroupMetadataCache(e){try{let t=await this.client.groupMetadata(e),s=this.configService.get("CACHE");return(s?.REDIS?.ENABLED&&s?.REDIS?.URI!==""||s?.LOCAL?.ENABLED)&&(this.logger.verbose(`Updating cache for group: ${e}`),await Hn.set(e,{timestamp:Date.now(),data:t})),t}catch(t){return this.logger.error("line 3310"),this.logger.error(t),null}}async getGroupMetadataCache(e){if(!(0,A.isJidGroup)(e))return null;let t=M.get("CACHE");if(t?.REDIS?.ENABLED&&t?.REDIS?.URI!==""||t?.LOCAL?.ENABLED){if(await Hn?.has(e)){console.log(`Cache request for group: ${e}`);let s=await Hn.get(e);return Date.now()-s.timestamp>36e5&&await this.updateGroupMetadataCache(e),s.data}return console.log(`Cache request for group: ${e} - not found`),await this.updateGroupMetadataCache(e)}return await this.findGroup({groupJid:e},"inner")}async createGroup(e){try{let t=(await this.whatsappNumber({numbers:e.participants})).filter(n=>n.exists).map(n=>n.jid),{id:s}=await this.client.groupCreate(e.subject,t);return e?.description&&await this.client.groupUpdateDescription(s,e.description),e?.promoteParticipants&&await this.updateGParticipant({groupJid:s,action:"promote",participants:t}),await this.client.groupMetadata(s)}catch(t){throw this.logger.error("line 3363"),this.logger.error(t),new N("Error creating group",t.toString())}}async updateGroupPicture(e){try{let t;if((0,ae.isURL)(e.image)){let s=new Date().getTime(),o=`${e.image}?timestamp=${s}`,n={responseType:"arraybuffer"};this.localProxy?.enabled&&(n={...n,httpsAgent:le({host:this.localProxy.host,port:this.localProxy.port,protocol:this.localProxy.protocol,username:this.localProxy.username,password:this.localProxy.password})}),t=(await De.default.get(o,n)).data}else if((0,ae.isBase64)(e.image))t=Buffer.from(e.image,"base64");else throw new m('"profilePicture" must be a url or a base64');return await this.client.updateProfilePicture(e.groupJid,t),{update:"success"}}catch(t){throw this.logger.error("line 3403"),new N("Error update group picture",t.toString())}}async updateGroupSubject(e){try{return await this.client.groupUpdateSubject(e.groupJid,e.subject),{update:"success"}}catch(t){throw this.logger.error("line 3414"),new N("Error updating group subject",t.toString())}}async updateGroupDescription(e){try{return await this.client.groupUpdateDescription(e.groupJid,e.description),{update:"success"}}catch(t){throw this.logger.error("line 3425"),new N("Error updating group description",t.toString())}}async findGroup(e,t="out"){try{let s=await this.client.groupMetadata(e.groupJid);if(!s)return this.logger.error("Group not found"),null;let o=await this.profilePicture(s.id);return{id:s.id,subject:s.subject,subjectOwner:s.subjectOwner,subjectTime:s.subjectTime,pictureUrl:o.profilePictureUrl,size:s.participants.length,creation:s.creation,owner:s.owner,desc:s.desc,descId:s.descId,restrict:s.restrict,announce:s.announce,participants:s.participants}}catch(s){if(t==="inner")return;throw this.logger.error("line 3460"),new _("Error fetching group",s.toString())}}async fetchAllGroups(e){let t=Object.values(await this?.client?.groupFetchAllParticipating()),s=[];for(let o of t){let n=await this.profilePicture(o.id),r={id:o.id,subject:o.subject,subjectOwner:o.subjectOwner,subjectTime:o.subjectTime,pictureUrl:n?.profilePictureUrl,size:o.participants.length,creation:o.creation,owner:o.owner,desc:o.desc,descId:o.descId,restrict:o.restrict,announce:o.announce};e.getParticipants=="true"&&(r.participants=o.participants),s=[...s,r]}return s}async inviteCode(e){try{let t=await this.client.groupInviteCode(e.groupJid);return{inviteUrl:`https://chat.whatsapp.com/${t}`,inviteCode:t}}catch(t){throw this.logger.error("line 3502"),new _("No invite code",t.toString())}}async inviteInfo(e){try{return await this.client.groupGetInviteInfo(e.inviteCode)}catch{throw this.logger.error("line 3511"),new _("No invite info",e.inviteCode)}}async sendInvite(e){try{let s=(await this.inviteCode({groupJid:e.groupJid})).inviteUrl,o=e.numbers.map(c=>this.createJid(c)),a={conversation:`${e.description??""}

${s}`};for await(let c of o)await this.sendMessageWithTyping(c,a);return{send:!0,inviteUrl:s}}catch{throw this.logger.error("line 3537"),new _("No send invite")}}async acceptInviteCode(e){try{return{accepted:!0,groupJid:await this.client.groupAcceptInvite(e.inviteCode)}}catch(t){throw this.logger.error("line 3547"),new _("Accept invite error",t.toString())}}async revokeInviteCode(e){try{return{revoked:!0,inviteCode:await this.client.groupRevokeInvite(e.groupJid)}}catch(t){throw this.logger.error("line 3557"),new _("Revoke error",t.toString())}}async findParticipants(e){try{let t=(await this.client.groupMetadata(e.groupJid)).participants,s=await this.prismaRepository.contact.findMany({where:{instanceId:this.instanceId,remoteJid:{in:t.map(r=>r.id)}}}),o=t.map(r=>{let a=s.find(c=>c.remoteJid===r.id);return{...r,name:r.name??a?.pushName,imgUrl:r.imgUrl??a?.profilePicUrl}}),n=o.filter(r=>r.id.includes("@s.whatsapp"));return n&&await We(n.map(r=>({remoteJid:r.id}))),{participants:o}}catch(t){throw console.error(t),this.logger.error("line 3583"),new _("No participants",t.toString())}}async updateGParticipant(e){try{let t=e.participants.map(o=>this.createJid(o));return{updateParticipants:await this.client.groupParticipantsUpdate(e.groupJid,t,e.action)}}catch(t){throw this.logger.error("line 3598"),new m("Error updating participants",t.toString())}}async updateGSetting(e){try{return{updateSetting:await this.client.groupSettingUpdate(e.groupJid,e.action)}}catch(t){throw this.logger.error("line 3608"),new m("Error updating setting",t.toString())}}async toggleEphemeral(e){try{return await this.client.groupToggleEphemeral(e.groupJid,e.expiration),{success:!0}}catch(t){throw this.logger.error("line 3618"),new m("Error updating setting",t.toString())}}async leaveGroup(e){try{return await this.client.groupLeave(e.groupJid),{groupJid:e.groupJid,leave:!0}}catch(t){throw this.logger.error("line 3628"),new m("Unable to leave the group",t.toString())}}async templateMessage(){throw new Error("Method not available in the Baileys service")}prepareMessage(e){let t=e?.message[(0,A.getContentType)(e.message)],s={key:e.key,pushName:e.pushName,message:{...e.message},contextInfo:t?.contextInfo,messageType:(0,A.getContentType)(e.message)||"unknown",messageTimestamp:e.messageTimestamp,instanceId:this.instanceId,source:(0,A.getDevice)(e.key.id)};return s.message.extendedTextMessage&&(s.messageType="conversation",s.message.conversation=s.message.extendedTextMessage.text,delete s.message.extendedTextMessage),s}};var Ne=class{constructor(i,e){this.prisma=i,this.monitor=e}set prisma(i){this.prismaRepository=i}get prisma(){return this.prismaRepository}set monitor(i){this.waMonitor=i}get monitor(){return this.waMonitor}init(i,e){if(!i.token&&i.integration===D.WHATSAPP_BUSINESS)throw new m("token is required");return i.integration===D.WHATSAPP_BUSINESS?new Ri(e.configService,e.eventEmitter,e.prismaRepository,e.cache,e.chatwootCache,e.baileysCache,e.providerFiles):i.integration===D.EVOLUTION?new vi(e.configService,e.eventEmitter,e.prismaRepository,e.cache,e.chatwootCache,e.baileysCache,e.providerFiles):i.integration===D.WHATSAPP_BAILEYS?new Pi(e.configService,e.eventEmitter,e.prismaRepository,e.cache,e.chatwootCache,e.baileysCache,e.providerFiles):null}};var _i=class extends Ne{constructor(e,t){super(e,t);this.logger=new E("EvolutionController")}async receiveWebhook(e){let t=e.numberId;if(!t){this.logger.error("WebhookService -> receiveWebhookEvolution -> numberId not found");return}let s=await this.prismaRepository.instance.findFirst({where:{number:t}});if(!s){this.logger.error("WebhookService -> receiveWebhook -> instance not found");return}return await this.waMonitor.waInstances[s.name].connectToWhatsapp(e),{status:"success"}}};var Qa=v(require("axios"));var Bi=class extends Ne{constructor(e,t){super(e,t);this.logger=new E("MetaController")}async receiveWebhook(e){if(e.object==="whatsapp_business_account"){if(e.entry[0]?.changes[0]?.field==="message_template_status_update"){let t=await this.prismaRepository.template.findFirst({where:{templateId:`${e.entry[0].changes[0].value.message_template_id}`}});if(!t){console.log("template not found");return}let{webhookUrl:s}=t;await Qa.default.post(s,e.entry[0].changes[0].value,{headers:{"Content-Type":"application/json"}});return}e.entry?.forEach(async t=>{let s=t.changes[0].value.metadata.phone_number_id;if(!s)return this.logger.error("WebhookService -> receiveWebhookMeta -> numberId not found"),{status:"success"};let o=await this.prismaRepository.instance.findFirst({where:{number:s}});return o?(await this.waMonitor.waInstances[o.name].connectToWhatsapp(e),{status:"success"}):(this.logger.error("WebhookService -> receiveWebhookMeta -> instance not found"),{status:"success"})})}return{status:"success"}}};function za(p){return p.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function Xa(p,i){let e=i.split(" ").reduce((s,o)=>{let[n,...r]=o.split(":"),a=r.join(":");return s[n]||(s[n]=[]),s[n].push(a),s},{}),t=za(p);return Object.entries(e).every(([s,o])=>o.some(n=>n.split(",").every(a=>{let c=za(a);switch(s.toLowerCase()){case"contains":return t.includes(c);case"notcontains":return!t.includes(c);case"startswith":return t.startsWith(c);case"endswith":return t.endsWith(c);case"exact":return t===c;default:return!1}})))}var Za=async(p,i,e,t)=>{let s=await p.findFirst({where:{enabled:!0,triggerType:"all",instanceId:t}});if(s)return s;let o=await p.findMany({where:{enabled:!0,triggerType:"advanced",instanceId:t}});for(let f of o)if(Xa(e,f.triggerValue))return f;let n=await p.findFirst({where:{enabled:!0,triggerType:"keyword",triggerOperator:"equals",triggerValue:e,instanceId:t}});if(n)return n;let r=await p.findMany({where:{enabled:!0,triggerType:"keyword",triggerOperator:"regex",instanceId:t}}),a=null;for(let f of r)if(new RegExp(f.triggerValue).test(e)){a=f;break}if(a)return a;let c=await p.findMany({where:{enabled:!0,triggerType:"keyword",triggerOperator:"startsWith",instanceId:t}}),u=null;for(let f of c)if(e.startsWith(f.triggerValue)){u=f;break}if(u)return u;let d=await p.findMany({where:{enabled:!0,triggerType:"keyword",triggerOperator:"endsWith",instanceId:t}}),l=null;for(let f of d)if(e.endsWith(f.triggerValue)){l=f;break}if(l)return l;let g=await p.findMany({where:{enabled:!0,triggerType:"keyword",triggerOperator:"contains",instanceId:t}}),h=null;for(let f of g)if(e.includes(f.triggerValue)){h=f;break}if(h)return h;let y=await i.findFirst({where:{instanceId:t}});if(y?.openaiIdFallback){let f=await p.findFirst({where:{id:y.openaiIdFallback}});if(f)return f}return null};var Y=class{constructor(i,e){this.logger=new E("ChatbotController");this.prisma=i,this.monitor=e}set prisma(i){this.prismaRepository=i}get prisma(){return this.prismaRepository}set monitor(i){this.waMonitor=i}get monitor(){return this.waMonitor}async emit({instance:i,remoteJid:e,msg:t,pushName:s,isIntegration:o=!1}){let n={instance:i,remoteJid:e,msg:t,pushName:s,isIntegration:o};await Z.emit(n),await K.emit(n),await q.emit(n),await X.emit(n),await ee.emit(n)}processDebounce(i,e,t,s,o){i[t]?(i[t].message+=`
${e}`,this.logger.log("message debounced: "+i[t].message),clearTimeout(i[t].timeoutId)):i[t]={message:e,timeoutId:null},i[t].timeoutId=setTimeout(()=>{let n=i[t].message;this.logger.log("Debounce complete. Processing message: "+n),delete i[t],o(n)},s*1e3)}checkIgnoreJids(i,e){if(i&&i.length>0){let t=!1,s=!1;return i.includes("@g.us")&&(t=!0),i.includes("@s.whatsapp.net")&&(s=!0),t&&e.endsWith("@g.us")?(this.logger.warn("Ignoring message from group: "+e),!0):s&&e.endsWith("@s.whatsapp.net")?(this.logger.warn("Ignoring message from contact: "+e),!0):i.includes(e)?(this.logger.warn("Ignoring message from jid: "+e),!0):!1}return!1}async getSession(i,e){let t=await this.prismaRepository.integrationSession.findFirst({where:{remoteJid:i,instanceId:e.instanceId},orderBy:{createdAt:"desc"}});if(t)if(t.status!=="closed"&&!t.botId){this.logger.warn("Session is already opened in another integration");return}else t.botId||(t=null);return t}async findBotTrigger(i,e,t,s,o){let n;if(o)n=await i.findFirst({where:{id:o.botId}});else if(n=await Za(i,e,t,s.instanceId),!n)return;return n}};var ec=require("class-validator"),Fi=class{constructor(i,e,t){this.chatwootService=i;this.configService=e;this.prismaRepository=t}async createChatwoot(i,e){if(!this.configService.get("CHATWOOT").ENABLED)throw new m("Chatwoot is disabled");if(e?.enabled){if(!(0,ec.isURL)(e.url,{require_tld:!1}))throw new m("url is not valid");if(!e.accountId)throw new m("accountId is required");if(!e.token)throw new m("token is required");if(e.signMsg!==!0&&e.signMsg!==!1)throw new m("signMsg is required");e.signMsg===!1&&(e.signDelimiter=null)}(!e.nameInbox||e.nameInbox==="")&&(e.nameInbox=i.instanceName);let t=await this.chatwootService.create(i,e),s=this.configService.get("SERVER").URL;return{...t,webhook_url:`${s}/chatwoot/webhook/${encodeURIComponent(i.instanceName)}`}}async findChatwoot(i){if(!this.configService.get("CHATWOOT").ENABLED)throw new m("Chatwoot is disabled");let e=await this.chatwootService.find(i),t=this.configService.get("SERVER").URL;return Object.keys(e||{}).length===0?{enabled:!1,url:"",accountId:"",token:"",signMsg:!1,nameInbox:"",webhook_url:""}:{...e,webhook_url:`${t}/chatwoot/webhook/${encodeURIComponent(i.instanceName)}`}}async receiveWebhook(i,e){if(!this.configService.get("CHATWOOT").ENABLED)throw new m("Chatwoot is disabled");let t=new fe(new ge(this.configService,ye.name).getEngine());return new ye(x,this.configService,this.prismaRepository,t).receiveWebhook(i,e)}};var Li=class extends Y{constructor(e,t,s){super(t,s);this.difyService=e;this.logger=new E("DifyController");this.integrationEnabled=M.get("DIFY").ENABLED;this.userMessageDebounce={};this.botRepository=this.prismaRepository.dify,this.settingsRepository=this.prismaRepository.difySetting,this.sessionRepository=this.prismaRepository.integrationSession}async createBot(e,t){if(!this.integrationEnabled)throw new m("Dify is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id);if(!t.expire||!t.keywordFinish||!t.delayMessage||!t.unknownMessage||!t.listeningFromMe||!t.stopBotFromMe||!t.keepOpen||!t.debounceTime||!t.ignoreJids){let r=await this.settingsRepository.findFirst({where:{instanceId:s}});t.expire||(t.expire=r?.expire||0),t.keywordFinish||(t.keywordFinish=r?.keywordFinish||""),t.delayMessage||(t.delayMessage=r?.delayMessage||1e3),t.unknownMessage||(t.unknownMessage=r?.unknownMessage||""),t.listeningFromMe||(t.listeningFromMe=r?.listeningFromMe||!1),t.stopBotFromMe||(t.stopBotFromMe=r?.stopBotFromMe||!1),t.keepOpen||(t.keepOpen=r?.keepOpen||!1),t.debounceTime||(t.debounceTime=r?.debounceTime||0),t.ignoreJids||(t.ignoreJids=r?.ignoreJids||[]),r||await this.settings(e,{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,ignoreJids:t.ignoreJids})}if(await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",instanceId:s}})&&t.triggerType==="all")throw new Error('You already have a dify with an "All" trigger, you cannot have more bots while it is active');if(await this.botRepository.findFirst({where:{instanceId:s,botType:t.botType,apiUrl:t.apiUrl,apiKey:t.apiKey}}))throw new Error("Dify already exists");if(t.triggerType==="keyword"){if(!t.triggerOperator||!t.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}if(t.triggerType==="advanced"){if(!t.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}try{return await this.botRepository.create({data:{enabled:t?.enabled,description:t.description,botType:t.botType,apiUrl:t.apiUrl,apiKey:t.apiKey,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,instanceId:s,triggerType:t.triggerType,triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,ignoreJids:t.ignoreJids}})}catch(r){throw this.logger.error(r),new Error("Error creating dify")}}async findBot(e){if(!this.integrationEnabled)throw new m("Dify is disabled");let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.botRepository.findMany({where:{instanceId:t}});return s.length?s:null}async fetchBot(e,t){if(!this.integrationEnabled)throw new m("Dify is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Dify not found");if(o.instanceId!==s)throw new Error("Dify not found");return o}async updateBot(e,t,s){if(!this.integrationEnabled)throw new m("Dify is disabled");let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),n=await this.botRepository.findFirst({where:{id:t}});if(!n)throw new Error("Dify not found");if(n.instanceId!==o)throw new Error("Dify not found");if(s.triggerType==="all"&&await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",id:{not:t},instanceId:o}}))throw new Error('You already have a dify with an "All" trigger, you cannot have more bots while it is active');if(await this.botRepository.findFirst({where:{id:{not:t},instanceId:o,botType:s.botType,apiUrl:s.apiUrl,apiKey:s.apiKey}}))throw new Error("Dify already exists");if(s.triggerType==="keyword"){if(!s.triggerOperator||!s.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}if(s.triggerType==="advanced"){if(!s.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}try{return await this.botRepository.update({where:{id:t},data:{enabled:s?.enabled,description:s.description,botType:s.botType,apiUrl:s.apiUrl,apiKey:s.apiKey,expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,debounceTime:s.debounceTime,instanceId:o,triggerType:s.triggerType,triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,ignoreJids:s.ignoreJids}})}catch(a){throw this.logger.error(a),new Error("Error updating dify")}}async deleteBot(e,t){if(!this.integrationEnabled)throw new m("Dify is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Dify not found");if(o.instanceId!==s)throw new Error("Dify not found");try{return await this.prismaRepository.integrationSession.deleteMany({where:{botId:t}}),await this.botRepository.delete({where:{id:t}}),{bot:{id:t}}}catch(n){throw this.logger.error(n),new Error("Error deleting dify bot")}}async settings(e,t){if(!this.integrationEnabled)throw new m("Dify is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(o){let r=await this.settingsRepository.update({where:{id:o.id},data:{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,difyIdFallback:t.difyIdFallback,ignoreJids:t.ignoreJids}});return{expire:r.expire,keywordFinish:r.keywordFinish,delayMessage:r.delayMessage,unknownMessage:r.unknownMessage,listeningFromMe:r.listeningFromMe,stopBotFromMe:r.stopBotFromMe,keepOpen:r.keepOpen,debounceTime:r.debounceTime,difyIdFallback:r.difyIdFallback,ignoreJids:r.ignoreJids}}let n=await this.settingsRepository.create({data:{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,difyIdFallback:t.difyIdFallback,ignoreJids:t.ignoreJids,instanceId:s}});return{expire:n.expire,keywordFinish:n.keywordFinish,delayMessage:n.delayMessage,unknownMessage:n.unknownMessage,listeningFromMe:n.listeningFromMe,stopBotFromMe:n.stopBotFromMe,keepOpen:n.keepOpen,debounceTime:n.debounceTime,difyIdFallback:n.difyIdFallback,ignoreJids:n.ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async fetchSettings(e){if(!this.integrationEnabled)throw new m("Dify is disabled");try{let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.settingsRepository.findFirst({where:{instanceId:t},include:{Fallback:!0}});return s?{expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,ignoreJids:s.ignoreJids,difyIdFallback:s.difyIdFallback,fallback:s.Fallback}:{expire:0,keywordFinish:"",delayMessage:0,unknownMessage:"",listeningFromMe:!1,stopBotFromMe:!1,keepOpen:!1,ignoreJids:[],difyIdFallback:"",fallback:null}}catch(t){throw this.logger.error(t),new Error("Error fetching default settings")}}async changeStatus(e,t){if(!this.integrationEnabled)throw new m("Dify is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}}),n=t.remoteJid,r=t.status;if(r==="delete")return await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{bot:{remoteJid:n,status:r}};if(r==="closed")return o?.keepOpen?await this.sessionRepository.updateMany({where:{remoteJid:n,botId:{not:null}},data:{status:"closed"}}):await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{bot:{...e,bot:{remoteJid:n,status:r}}};{let a=await this.sessionRepository.updateMany({where:{instanceId:s,remoteJid:n,botId:{not:null}},data:{status:r}});return{bot:{...e,bot:{remoteJid:n,status:r,session:a}}}}}catch(s){throw this.logger.error(s),new Error("Error changing status")}}async fetchSessions(e,t,s){if(!this.integrationEnabled)throw new m("Dify is disabled");try{let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),n=await this.botRepository.findFirst({where:{id:t}});if(n&&n.instanceId!==o)throw new Error("Dify not found");return await this.sessionRepository.findMany({where:{instanceId:o,remoteJid:s,botId:n?t:{not:null},type:"dify"}})}catch(o){throw this.logger.error(o),new Error("Error fetching sessions")}}async ignoreJid(e,t){if(!this.integrationEnabled)throw new m("Dify is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(!o)throw new Error("Settings not found");let n=o?.ignoreJids||[];if(t.action==="add"){if(n.includes(t.remoteJid))return{ignoreJids:n};n.push(t.remoteJid)}else n=n.filter(a=>a!==t.remoteJid);return{ignoreJids:(await this.settingsRepository.update({where:{id:o.id},data:{ignoreJids:n}})).ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async emit({instance:e,remoteJid:t,msg:s}){if(this.integrationEnabled)try{let o=await this.settingsRepository.findFirst({where:{instanceId:e.instanceId}});if(this.checkIgnoreJids(o?.ignoreJids,t))return;let n=await this.getSession(t,e),r=re(s),a=await this.findBotTrigger(this.botRepository,this.settingsRepository,r,e,n);if(!a)return;let c=a?.expire,u=a?.keywordFinish,d=a?.delayMessage,l=a?.unknownMessage,g=a?.listeningFromMe,h=a?.stopBotFromMe,y=a?.keepOpen,f=a?.debounceTime,w=a?.ignoreJids;c||(c=o.expire),u||(u=o.keywordFinish),d||(d=o.delayMessage),l||(l=o.unknownMessage),g||(g=o.listeningFromMe),h||(h=o.stopBotFromMe),y||(y=o.keepOpen),f||(f=o.debounceTime),w||(w=o.ignoreJids);let I=s.key;if(h&&I.fromMe&&n){await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"paused"}});return}if(!g&&I.fromMe||n&&!n.awaitUser)return;f&&f>0?this.processDebounce(this.userMessageDebounce,r,t,f,async b=>{await this.difyService.processDify(this.waMonitor.waInstances[e.instanceName],t,a,n,{...o,expire:c,keywordFinish:u,delayMessage:d,unknownMessage:l,listeningFromMe:g,stopBotFromMe:h,keepOpen:y,debounceTime:f,ignoreJids:w},b,s?.pushName)}):await this.difyService.processDify(this.waMonitor.waInstances[e.instanceName],t,a,n,{...o,expire:c,keywordFinish:u,delayMessage:d,unknownMessage:l,listeningFromMe:g,stopBotFromMe:h,keepOpen:y,debounceTime:f,ignoreJids:w},r,s?.pushName);return}catch(o){this.logger.error(o);return}}};var Ui=class extends Y{constructor(e,t,s){super(t,s);this.evolutionBotService=e;this.logger=new E("EvolutionBotController");this.userMessageDebounce={};this.botRepository=this.prismaRepository.evolutionBot,this.settingsRepository=this.prismaRepository.evolutionBotSetting,this.sessionRepository=this.prismaRepository.integrationSession}async createBot(e,t){let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id);if(!t.expire||!t.keywordFinish||!t.delayMessage||!t.unknownMessage||!t.listeningFromMe||!t.stopBotFromMe||!t.keepOpen||!t.debounceTime||!t.ignoreJids){let r=await this.settingsRepository.findFirst({where:{instanceId:s}});t.expire||(t.expire=r?.expire||0),t.keywordFinish||(t.keywordFinish=r?.keywordFinish||""),t.delayMessage||(t.delayMessage=r?.delayMessage||1e3),t.unknownMessage||(t.unknownMessage=r?.unknownMessage||""),t.listeningFromMe||(t.listeningFromMe=r?.listeningFromMe||!1),t.stopBotFromMe||(t.stopBotFromMe=r?.stopBotFromMe||!1),t.keepOpen||(t.keepOpen=r?.keepOpen||!1),t.debounceTime||(t.debounceTime=r?.debounceTime||0),t.ignoreJids||(t.ignoreJids=r?.ignoreJids||[]),r||await this.settings(e,{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,ignoreJids:t.ignoreJids})}if(await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",instanceId:s}})&&t.triggerType==="all")throw new Error('You already have a dify with an "All" trigger, you cannot have more bots while it is active');if(await this.botRepository.findFirst({where:{instanceId:s,apiUrl:t.apiUrl,apiKey:t.apiKey}}))throw new Error("Dify already exists");if(t.triggerType==="keyword"){if(!t.triggerOperator||!t.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}if(t.triggerType==="advanced"){if(!t.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}try{return await this.botRepository.create({data:{enabled:t?.enabled,description:t.description,apiUrl:t.apiUrl,apiKey:t.apiKey,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,instanceId:s,triggerType:t.triggerType,triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,ignoreJids:t.ignoreJids}})}catch(r){throw this.logger.error(r),new Error("Error creating bot")}}async findBot(e){let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.botRepository.findMany({where:{instanceId:t}});return s.length?s:null}async fetchBot(e,t){let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Bot not found");if(o.instanceId!==s)throw new Error("Bot not found");return o}async updateBot(e,t,s){let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),n=await this.botRepository.findFirst({where:{id:t}});if(!n)throw new Error("Bot not found");if(n.instanceId!==o)throw new Error("Bot not found");if(s.triggerType==="all"&&await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",id:{not:t},instanceId:o}}))throw new Error('You already have a bot with an "All" trigger, you cannot have more bots while it is active');if(await this.botRepository.findFirst({where:{id:{not:t},instanceId:o,apiUrl:s.apiUrl,apiKey:s.apiKey}}))throw new Error("Bot already exists");if(s.triggerType==="keyword"){if(!s.triggerOperator||!s.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}if(s.triggerType==="advanced"){if(!s.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}try{return await this.botRepository.update({where:{id:t},data:{enabled:s?.enabled,description:s.description,apiUrl:s.apiUrl,apiKey:s.apiKey,expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,debounceTime:s.debounceTime,instanceId:o,triggerType:s.triggerType,triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,ignoreJids:s.ignoreJids}})}catch(a){throw this.logger.error(a),new Error("Error updating bot")}}async deleteBot(e,t){let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Bot not found");if(o.instanceId!==s)throw new Error("Bot not found");try{return await this.prismaRepository.integrationSession.deleteMany({where:{botId:t}}),await this.botRepository.delete({where:{id:t}}),{bot:{id:t}}}catch(n){throw this.logger.error(n),new Error("Error deleting bot")}}async settings(e,t){try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(o){let r=await this.settingsRepository.update({where:{id:o.id},data:{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,botIdFallback:t.botIdFallback,ignoreJids:t.ignoreJids}});return{expire:r.expire,keywordFinish:r.keywordFinish,delayMessage:r.delayMessage,unknownMessage:r.unknownMessage,listeningFromMe:r.listeningFromMe,stopBotFromMe:r.stopBotFromMe,keepOpen:r.keepOpen,debounceTime:r.debounceTime,botIdFallback:r.botIdFallback,ignoreJids:r.ignoreJids}}let n=await this.settingsRepository.create({data:{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,botIdFallback:t.botIdFallback,ignoreJids:t.ignoreJids,instanceId:s}});return{expire:n.expire,keywordFinish:n.keywordFinish,delayMessage:n.delayMessage,unknownMessage:n.unknownMessage,listeningFromMe:n.listeningFromMe,stopBotFromMe:n.stopBotFromMe,keepOpen:n.keepOpen,debounceTime:n.debounceTime,botIdFallback:n.botIdFallback,ignoreJids:n.ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async fetchSettings(e){try{let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.settingsRepository.findFirst({where:{instanceId:t},include:{Fallback:!0}});return s?{expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,ignoreJids:s.ignoreJids,botIdFallback:s.botIdFallback,fallback:s.Fallback}:{expire:0,keywordFinish:"",delayMessage:0,unknownMessage:"",listeningFromMe:!1,stopBotFromMe:!1,keepOpen:!1,ignoreJids:[],botIdFallback:"",fallback:null}}catch(t){throw this.logger.error(t),new Error("Error fetching default settings")}}async changeStatus(e,t){try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}}),n=t.remoteJid,r=t.status;if(r==="delete")return await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{bot:{remoteJid:n,status:r}};if(r==="closed")return o?.keepOpen?await this.sessionRepository.updateMany({where:{remoteJid:n,botId:{not:null}},data:{status:"closed"}}):await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{bot:{...e,bot:{remoteJid:n,status:r}}};{let a=await this.sessionRepository.updateMany({where:{instanceId:s,remoteJid:n,botId:{not:null}},data:{status:r}});return{bot:{...e,bot:{remoteJid:n,status:r,session:a}}}}}catch(s){throw this.logger.error(s),new Error("Error changing status")}}async fetchSessions(e,t,s){try{let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),n=await this.botRepository.findFirst({where:{id:t}});if(n&&n.instanceId!==o)throw new Error("Dify not found");return await this.sessionRepository.findMany({where:{instanceId:o,remoteJid:s,botId:n?t:{not:null},type:"evolution"}})}catch(o){throw this.logger.error(o),new Error("Error fetching sessions")}}async ignoreJid(e,t){try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(!o)throw new Error("Settings not found");let n=o?.ignoreJids||[];if(t.action==="add"){if(n.includes(t.remoteJid))return{ignoreJids:n};n.push(t.remoteJid)}else n=n.filter(a=>a!==t.remoteJid);return{ignoreJids:(await this.settingsRepository.update({where:{id:o.id},data:{ignoreJids:n}})).ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async emit({instance:e,remoteJid:t,msg:s}){try{let o=await this.settingsRepository.findFirst({where:{instanceId:e.instanceId}});if(this.checkIgnoreJids(o?.ignoreJids,t))return;let n=await this.getSession(t,e),r=re(s),a=await this.findBotTrigger(this.botRepository,this.settingsRepository,r,e,n);if(!a)return;let c=a?.expire,u=a?.keywordFinish,d=a?.delayMessage,l=a?.unknownMessage,g=a?.listeningFromMe,h=a?.stopBotFromMe,y=a?.keepOpen,f=a?.debounceTime,w=a?.ignoreJids;c||(c=o.expire),u||(u=o.keywordFinish),d||(d=o.delayMessage),l||(l=o.unknownMessage),g||(g=o.listeningFromMe),h||(h=o.stopBotFromMe),y||(y=o.keepOpen),f||(f=o.debounceTime),w||(w=o.ignoreJids);let I=s.key;if(h&&I.fromMe&&n){await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"paused"}});return}if(!g&&I.fromMe||n&&!n.awaitUser)return;f&&f>0?this.processDebounce(this.userMessageDebounce,r,t,f,async b=>{await this.evolutionBotService.processBot(this.waMonitor.waInstances[e.instanceName],t,a,n,{...o,expire:c,keywordFinish:u,delayMessage:d,unknownMessage:l,listeningFromMe:g,stopBotFromMe:h,keepOpen:y,debounceTime:f,ignoreJids:w},b,s?.pushName)}):await this.evolutionBotService.processBot(this.waMonitor.waInstances[e.instanceName],t,a,n,{...o,expire:c,keywordFinish:u,delayMessage:d,unknownMessage:l,listeningFromMe:g,stopBotFromMe:h,keepOpen:y,debounceTime:f,ignoreJids:w},r,s?.pushName);return}catch(o){this.logger.error(o);return}}};var tc=v(require("axios")),Ji=class{constructor(i,e,t){this.waMonitor=i;this.configService=e;this.prismaRepository=t;this.logger=new E("EvolutionBotService")}async createNewSession(i,e){try{return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:e.remoteJid,pushName:e.pushName,sessionId:e.remoteJid,status:"opened",awaitUser:!1,botId:e.botId,instanceId:i.instanceId,type:"evolution"}})}}catch(t){this.logger.error(t);return}}isImageMessage(i){return i.includes("imageMessage")}async sendMessageToBot(i,e,t,s,o,n){let r={inputs:{sessionId:e.id,remoteJid:s,pushName:o,instanceName:i.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY},query:n,conversation_id:e.sessionId===s?void 0:e.sessionId,user:s};if(this.isImageMessage(n)){let d=n.split("|");r.files=[{type:"image",url:d[1].split("?")[0]}],r.query=d[2]||n}i.integration===D.WHATSAPP_BAILEYS&&(await i.client.presenceSubscribe(s),await i.client.sendPresenceUpdate("composing",s));let a={"Content-Type":"application/json"};t.apiKey&&(a={...a,Authorization:`Bearer ${t.apiKey}`});let c=await tc.default.post(t.apiUrl,r,{headers:a});return i.integration===D.WHATSAPP_BAILEYS&&await i.client.sendPresenceUpdate("paused",s),c?.data?.message}async sendMessageWhatsApp(i,e,t,s,o){let n=/(!?)\[(.*?)\]\((.*?)\)/g,r="",a=0,c,u=d=>{let l=d.split(".").pop()?.toLowerCase(),g=["jpg","jpeg","png","gif","bmp","webp"],h=["mp3","wav","aac","ogg"],y=["mp4","avi","mkv","mov"],f=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return g.includes(l||"")?"image":h.includes(l||"")?"audio":y.includes(l||"")?"video":f.includes(l||"")?"document":null};for(;(c=n.exec(o))!==null;){let[d,l,g,h]=c,y=u(h),f=o.slice(a,c.index);f&&(r+=f),y?(r.trim()&&(await i.textMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,text:r.trim()},!1),r=""),y==="audio"?await i.audioWhatsapp({number:e.split("@")[0],delay:s?.delayMessage||1e3,audio:h,caption:g}):await i.mediaMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,mediatype:y,media:h,caption:g},!1)):r+=`[${g}](${h})`,a=n.lastIndex}if(a<o.length){let d=o.slice(a);d.trim()&&(r+=d)}r.trim()&&await i.textMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,text:r.trim()},!1),B("/message/sendText"),await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{status:"opened",awaitUser:!0}})}async initNewSession(i,e,t,s,o,n,r){let a=await this.createNewSession(i,{remoteJid:e,pushName:r,botId:t.id});a.session&&(o=a.session);let c=await this.sendMessageToBot(i,o,t,e,r,n);c&&await this.sendMessageWhatsApp(i,e,o,s,c)}async processBot(i,e,t,s,o,n,r){if(s&&s.status!=="opened")return;if(s&&o.expire&&o.expire>0){let c=Date.now(),u=new Date(s.updatedAt).getTime(),d=c-u;if(Math.floor(d/1e3/60)>o.expire){o.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:t.id,remoteJid:e}}),await this.initNewSession(i,e,t,o,s,n,r);return}}if(!s){await this.initNewSession(i,e,t,o,s,n,r);return}if(await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"opened",awaitUser:!1}}),!n){o.unknownMessage&&(this.waMonitor.waInstances[i.instanceName].textMessage({number:e.split("@")[0],delay:o.delayMessage||1e3,text:o.unknownMessage},!1),B("/message/sendText"));return}if(o.keywordFinish&&n.toLowerCase()===o.keywordFinish.toLowerCase()){o.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:t.id,remoteJid:e}});return}let a=await this.sendMessageToBot(i,s,t,e,r,n);a&&await this.sendMessageWhatsApp(i,e,s,o,a)}};var Wi=class extends Y{constructor(e,t,s){super(t,s);this.flowiseService=e;this.logger=new E("FlowiseController");this.userMessageDebounce={};this.botRepository=this.prismaRepository.flowise,this.settingsRepository=this.prismaRepository.flowiseSetting,this.sessionRepository=this.prismaRepository.integrationSession}async createBot(e,t){let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id);if(!t.expire||!t.keywordFinish||!t.delayMessage||!t.unknownMessage||!t.listeningFromMe||!t.stopBotFromMe||!t.keepOpen||!t.debounceTime||!t.ignoreJids){let r=await this.settingsRepository.findFirst({where:{instanceId:s}});t.expire||(t.expire=r?.expire||0),t.keywordFinish||(t.keywordFinish=r?.keywordFinish||""),t.delayMessage||(t.delayMessage=r?.delayMessage||1e3),t.unknownMessage||(t.unknownMessage=r?.unknownMessage||""),t.listeningFromMe||(t.listeningFromMe=r?.listeningFromMe||!1),t.stopBotFromMe||(t.stopBotFromMe=r?.stopBotFromMe||!1),t.keepOpen||(t.keepOpen=r?.keepOpen||!1),t.debounceTime||(t.debounceTime=r?.debounceTime||0),t.ignoreJids||(t.ignoreJids=r?.ignoreJids||[]),r||await this.settings(e,{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,ignoreJids:t.ignoreJids})}if(await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",instanceId:s}})&&t.triggerType==="all")throw new Error('You already have a Flowise with an "All" trigger, you cannot have more bots while it is active');if(await this.botRepository.findFirst({where:{instanceId:s,apiUrl:t.apiUrl,apiKey:t.apiKey}}))throw new Error("Flowise already exists");if(t.triggerType==="keyword"){if(!t.triggerOperator||!t.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}if(t.triggerType==="advanced"){if(!t.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}try{return await this.botRepository.create({data:{enabled:t?.enabled,description:t.description,apiUrl:t.apiUrl,apiKey:t.apiKey,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,instanceId:s,triggerType:t.triggerType,triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,ignoreJids:t.ignoreJids}})}catch(r){throw this.logger.error(r),new Error("Error creating bot")}}async findBot(e){let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.botRepository.findMany({where:{instanceId:t}});return s.length?s:null}async fetchBot(e,t){let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Bot not found");if(o.instanceId!==s)throw new Error("Bot not found");return o}async updateBot(e,t,s){let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),n=await this.botRepository.findFirst({where:{id:t}});if(!n)throw new Error("Bot not found");if(n.instanceId!==o)throw new Error("Bot not found");if(s.triggerType==="all"&&await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",id:{not:t},instanceId:o}}))throw new Error('You already have a bot with an "All" trigger, you cannot have more bots while it is active');if(await this.botRepository.findFirst({where:{id:{not:t},instanceId:o,apiUrl:s.apiUrl,apiKey:s.apiKey}}))throw new Error("Bot already exists");if(s.triggerType==="keyword"){if(!s.triggerOperator||!s.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}if(s.triggerType==="advanced"){if(!s.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}try{return await this.botRepository.update({where:{id:t},data:{enabled:s?.enabled,description:s.description,apiUrl:s.apiUrl,apiKey:s.apiKey,expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,debounceTime:s.debounceTime,instanceId:o,triggerType:s.triggerType,triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,ignoreJids:s.ignoreJids}})}catch(a){throw this.logger.error(a),new Error("Error updating bot")}}async deleteBot(e,t){let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Bot not found");if(o.instanceId!==s)throw new Error("Bot not found");try{return await this.prismaRepository.integrationSession.deleteMany({where:{botId:t}}),await this.botRepository.delete({where:{id:t}}),{bot:{id:t}}}catch(n){throw this.logger.error(n),new Error("Error deleting bot")}}async settings(e,t){try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(o){let r=await this.settingsRepository.update({where:{id:o.id},data:{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,flowiseIdFallback:t.flowiseIdFallback,ignoreJids:t.ignoreJids}});return{expire:r.expire,keywordFinish:r.keywordFinish,delayMessage:r.delayMessage,unknownMessage:r.unknownMessage,listeningFromMe:r.listeningFromMe,stopBotFromMe:r.stopBotFromMe,keepOpen:r.keepOpen,debounceTime:r.debounceTime,flowiseIdFallback:r.flowiseIdFallback,ignoreJids:r.ignoreJids}}let n=await this.settingsRepository.create({data:{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,flowiseIdFallback:t.flowiseIdFallback,ignoreJids:t.ignoreJids,instanceId:s}});return{expire:n.expire,keywordFinish:n.keywordFinish,delayMessage:n.delayMessage,unknownMessage:n.unknownMessage,listeningFromMe:n.listeningFromMe,stopBotFromMe:n.stopBotFromMe,keepOpen:n.keepOpen,debounceTime:n.debounceTime,flowiseIdFallback:n.flowiseIdFallback,ignoreJids:n.ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async fetchSettings(e){try{let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.settingsRepository.findFirst({where:{instanceId:t},include:{Fallback:!0}});return s?{expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,ignoreJids:s.ignoreJids,flowiseIdFallback:s.flowiseIdFallback,fallback:s.Fallback}:{expire:0,keywordFinish:"",delayMessage:0,unknownMessage:"",listeningFromMe:!1,stopBotFromMe:!1,keepOpen:!1,ignoreJids:[],flowiseIdFallback:"",fallback:null}}catch(t){throw this.logger.error(t),new Error("Error fetching default settings")}}async changeStatus(e,t){try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}}),n=t.remoteJid,r=t.status;if(r==="delete")return await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{bot:{remoteJid:n,status:r}};if(r==="closed")return o?.keepOpen?await this.sessionRepository.updateMany({where:{remoteJid:n,botId:{not:null}},data:{status:"closed"}}):await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{bot:{...e,bot:{remoteJid:n,status:r}}};{let a=await this.sessionRepository.updateMany({where:{instanceId:s,remoteJid:n,botId:{not:null}},data:{status:r}});return{bot:{...e,bot:{remoteJid:n,status:r,session:a}}}}}catch(s){throw this.logger.error(s),new Error("Error changing status")}}async fetchSessions(e,t,s){try{let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),n=await this.botRepository.findFirst({where:{id:t}});if(n&&n.instanceId!==o)throw new Error("Dify not found");return await this.sessionRepository.findMany({where:{instanceId:o,remoteJid:s,botId:n?t:{not:null},type:"flowise"}})}catch(o){throw this.logger.error(o),new Error("Error fetching sessions")}}async ignoreJid(e,t){try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(!o)throw new Error("Settings not found");let n=o?.ignoreJids||[];if(t.action==="add"){if(n.includes(t.remoteJid))return{ignoreJids:n};n.push(t.remoteJid)}else n=n.filter(a=>a!==t.remoteJid);return{ignoreJids:(await this.settingsRepository.update({where:{id:o.id},data:{ignoreJids:n}})).ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async emit({instance:e,remoteJid:t,msg:s}){try{let o=await this.settingsRepository.findFirst({where:{instanceId:e.instanceId}});if(this.checkIgnoreJids(o?.ignoreJids,t))return;let n=await this.getSession(t,e),r=re(s),a=await this.findBotTrigger(this.botRepository,this.settingsRepository,r,e,n);if(!a)return;let c=a?.expire,u=a?.keywordFinish,d=a?.delayMessage,l=a?.unknownMessage,g=a?.listeningFromMe,h=a?.stopBotFromMe,y=a?.keepOpen,f=a?.debounceTime,w=a?.ignoreJids;c||(c=o.expire),u||(u=o.keywordFinish),d||(d=o.delayMessage),l||(l=o.unknownMessage),g||(g=o.listeningFromMe),h||(h=o.stopBotFromMe),y||(y=o.keepOpen),f||(f=o.debounceTime),w||(w=o.ignoreJids);let I=s.key;if(h&&I.fromMe&&n){await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"paused"}});return}if(!g&&I.fromMe||n&&!n.awaitUser)return;f&&f>0?this.processDebounce(this.userMessageDebounce,r,t,f,async b=>{await this.flowiseService.processBot(this.waMonitor.waInstances[e.instanceName],t,a,n,{...o,expire:c,keywordFinish:u,delayMessage:d,unknownMessage:l,listeningFromMe:g,stopBotFromMe:h,keepOpen:y,debounceTime:f,ignoreJids:w},b,s?.pushName)}):await this.flowiseService.processBot(this.waMonitor.waInstances[e.instanceName],t,a,n,{...o,expire:c,keywordFinish:u,delayMessage:d,unknownMessage:l,listeningFromMe:g,stopBotFromMe:h,keepOpen:y,debounceTime:f,ignoreJids:w},r,s?.pushName);return}catch(o){this.logger.error(o);return}}};var sc=v(require("axios")),qi=class{constructor(i,e,t){this.waMonitor=i;this.configService=e;this.prismaRepository=t;this.logger=new E("FlowiseService")}async createNewSession(i,e){try{return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:e.remoteJid,pushName:e.pushName,sessionId:e.remoteJid,status:"opened",awaitUser:!1,botId:e.botId,instanceId:i.instanceId,type:"flowise"}})}}catch(t){this.logger.error(t);return}}isImageMessage(i){return i.includes("imageMessage")}async sendMessageToBot(i,e,t,s,o){let n={question:o,overrideConfig:{sessionId:t,vars:{remoteJid:t,pushName:s,instanceName:i.instanceName,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY}}};if(this.isImageMessage(o)){let d=o.split("|");n.uploads=[{data:d[1].split("?")[0],type:"url",name:"Flowise.png",mime:"image/png"}],n.question=d[2]||o}i.integration===D.WHATSAPP_BAILEYS&&(await i.client.presenceSubscribe(t),await i.client.sendPresenceUpdate("composing",t));let r={"Content-Type":"application/json"};e.apiKey&&(r={...r,Authorization:`Bearer ${e.apiKey}`});let a=e.apiUrl;if(!a)return null;let c=await sc.default.post(a,n,{headers:r});return i.integration===D.WHATSAPP_BAILEYS&&await i.client.sendPresenceUpdate("paused",t),c?.data?.text}async sendMessageWhatsApp(i,e,t,s,o){let n=/(!?)\[(.*?)\]\((.*?)\)/g,r="",a=0,c,u=d=>{let l=d.split(".").pop()?.toLowerCase(),g=["jpg","jpeg","png","gif","bmp","webp"],h=["mp3","wav","aac","ogg"],y=["mp4","avi","mkv","mov"],f=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return g.includes(l||"")?"image":h.includes(l||"")?"audio":y.includes(l||"")?"video":f.includes(l||"")?"document":null};for(;(c=n.exec(o))!==null;){let[d,l,g,h]=c,y=u(h),f=o.slice(a,c.index);f&&(r+=f),y?(r.trim()&&(await i.textMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,text:r.trim()},!1),r=""),y==="audio"?await i.audioWhatsapp({number:e.split("@")[0],delay:s?.delayMessage||1e3,audio:h,caption:g}):await i.mediaMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,mediatype:y,media:h,caption:g},!1)):r+=`[${g}](${h})`,a=n.lastIndex}if(a<o.length){let d=o.slice(a);d.trim()&&(r+=d)}r.trim()&&await i.textMessage({number:e.split("@")[0],delay:s?.delayMessage||1e3,text:r.trim()},!1),B("/message/sendText"),await this.prismaRepository.integrationSession.update({where:{id:t.id},data:{status:"opened",awaitUser:!0}})}async initNewSession(i,e,t,s,o,n,r){let a=await this.createNewSession(i,{remoteJid:e,pushName:r,botId:t.id});a.session&&(o=a.session);let c=await this.sendMessageToBot(i,t,e,r,n);await this.sendMessageWhatsApp(i,e,o,s,c)}async processBot(i,e,t,s,o,n,r){if(s&&s.status!=="opened")return;if(s&&o.expire&&o.expire>0){let c=Date.now(),u=new Date(s.updatedAt).getTime(),d=c-u;if(Math.floor(d/1e3/60)>o.expire){o.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:t.id,remoteJid:e}}),await this.initNewSession(i,e,t,o,s,n,r);return}}if(!s){await this.initNewSession(i,e,t,o,s,n,r);return}if(await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"opened",awaitUser:!1}}),!n){o.unknownMessage&&(this.waMonitor.waInstances[i.instanceName].textMessage({number:e.split("@")[0],delay:o.delayMessage||1e3,text:o.unknownMessage},!1),B("/message/sendText"));return}if(o.keywordFinish&&n.toLowerCase()===o.keywordFinish.toLowerCase()){o.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:t.id,remoteJid:e}});return}let a=await this.sendMessageToBot(i,t,e,r,n);await this.sendMessageWhatsApp(i,e,s,o,a)}};var ic=v(require("openai"));var $i=class extends Y{constructor(e,t,s){super(t,s);this.openaiService=e;this.logger=new E("OpenaiController");this.integrationEnabled=M.get("OPENAI").ENABLED;this.userMessageDebounce={};this.botRepository=this.prismaRepository.openaiBot,this.settingsRepository=this.prismaRepository.openaiSetting,this.sessionRepository=this.prismaRepository.integrationSession,this.credsRepository=this.prismaRepository.openaiCreds}async createOpenaiCreds(e,t){if(!this.integrationEnabled)throw new m("Openai is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id);if(!t.apiKey)throw new Error("API Key is required");if(!t.name)throw new Error("Name is required");try{return await this.credsRepository.create({data:{name:t.name,apiKey:t.apiKey,instanceId:s}})}catch(o){throw this.logger.error(o),new Error("Error creating openai creds")}}async findOpenaiCreds(e){if(!this.integrationEnabled)throw new m("Openai is disabled");let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id);return await this.credsRepository.findMany({where:{instanceId:t},include:{OpenaiAssistant:!0}})}async deleteCreds(e,t){if(!this.integrationEnabled)throw new m("Openai is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.credsRepository.findFirst({where:{id:t}});if(!o)throw new Error("Openai Creds not found");if(o.instanceId!==s)throw new Error("Openai Creds not found");try{return await this.credsRepository.delete({where:{id:t}}),{openaiCreds:{id:t}}}catch(n){throw this.logger.error(n),new Error("Error deleting openai creds")}}async getModels(e){if(!this.integrationEnabled)throw new m("Openai is disabled");let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id);if(!t)throw new Error("Instance not found");let s=await this.settingsRepository.findFirst({where:{instanceId:t},include:{OpenaiCreds:!0}});if(!s)throw new Error("Settings not found");let{apiKey:o}=s.OpenaiCreds;try{return this.client=new ic.default({apiKey:o}),(await this.client.models.list())?.body?.data}catch(n){throw this.logger.error(n),new Error("Error fetching models")}}async createBot(e,t){if(!this.integrationEnabled)throw new m("Openai is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id);if(!t.openaiCredsId||!t.expire||!t.keywordFinish||!t.delayMessage||!t.unknownMessage||!t.listeningFromMe||!t.stopBotFromMe||!t.keepOpen||!t.debounceTime||!t.ignoreJids){let a=await this.settingsRepository.findFirst({where:{instanceId:s}});if(t.openaiCredsId||(t.openaiCredsId=a?.openaiCredsId||null),t.expire||(t.expire=a?.expire||0),t.keywordFinish||(t.keywordFinish=a?.keywordFinish||""),t.delayMessage||(t.delayMessage=a?.delayMessage||1e3),t.unknownMessage||(t.unknownMessage=a?.unknownMessage||""),t.listeningFromMe||(t.listeningFromMe=a?.listeningFromMe||!1),t.stopBotFromMe||(t.stopBotFromMe=a?.stopBotFromMe||!1),t.keepOpen||(t.keepOpen=a?.keepOpen||!1),t.debounceTime||(t.debounceTime=a?.debounceTime||0),t.ignoreJids||(t.ignoreJids=a?.ignoreJids||[]),!t.openaiCredsId)throw new Error("Openai Creds Id is required");a||await this.settings(e,{openaiCredsId:t.openaiCredsId,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,ignoreJids:t.ignoreJids})}if(await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",instanceId:s}})&&t.triggerType==="all")throw new Error('You already have a openai with an "All" trigger, you cannot have more bots while it is active');let n={instanceId:s};if(t.botType==="assistant"){if(!t.assistantId)throw new Error("Assistant ID is required");n={...n,assistantId:t.assistantId,botType:t.botType}}else if(t.botType==="chatCompletion"){if(!t.model)throw new Error("Model is required");if(!t.maxTokens)throw new Error("Max tokens is required");n={...n,model:t.model,maxTokens:t.maxTokens,botType:t.botType}}else throw new Error("Bot type is required");if(await this.botRepository.findFirst({where:n}))throw new Error("Openai Bot already exists");if(t.triggerType==="keyword"){if(!t.triggerOperator||!t.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}if(t.triggerType==="advanced"){if(!t.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}try{return await this.botRepository.create({data:{enabled:t?.enabled,description:t.description,openaiCredsId:t.openaiCredsId,botType:t.botType,assistantId:t.assistantId,functionUrl:t.functionUrl,model:t.model,systemMessages:t.systemMessages,assistantMessages:t.assistantMessages,userMessages:t.userMessages,maxTokens:t.maxTokens,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,instanceId:s,triggerType:t.triggerType,triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,ignoreJids:t.ignoreJids}})}catch(a){throw this.logger.error(a),new Error("Error creating openai bot")}}async findBot(e){if(!this.integrationEnabled)throw new m("Openai is disabled");let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.botRepository.findMany({where:{instanceId:t}});return s.length?s:null}async fetchBot(e,t){if(!this.integrationEnabled)throw new m("Openai is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Openai Bot not found");if(o.instanceId!==s)throw new Error("Openai Bot not found");return o}async updateBot(e,t,s){if(!this.integrationEnabled)throw new m("Openai is disabled");let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(c=>c.id),n=await this.botRepository.findFirst({where:{id:t}});if(!n)throw new Error("Openai Bot not found");if(n.instanceId!==o)throw new Error("Openai Bot not found");if(s.triggerType==="all"&&await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",id:{not:t},instanceId:o}}))throw new Error('You already have a openai bot with an "All" trigger, you cannot have more bots while it is active');let r={id:{not:t},instanceId:o};if(s.botType==="assistant"){if(!s.assistantId)throw new Error("Assistant ID is required");r={...r,assistantId:s.assistantId}}else if(s.botType==="chatCompletion"){if(!s.model)throw new Error("Model is required");if(!s.maxTokens)throw new Error("Max tokens is required");r={...r,model:s.model,maxTokens:s.maxTokens}}else throw new Error("Bot type is required");if(await this.botRepository.findFirst({where:r}))throw new Error("Openai Bot already exists");if(s.triggerType==="keyword"){if(!s.triggerOperator||!s.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}if(s.triggerType==="advanced"){if(!s.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}try{return await this.botRepository.update({where:{id:t},data:{enabled:s?.enabled,description:s.description,openaiCredsId:s.openaiCredsId,botType:s.botType,assistantId:s.assistantId,functionUrl:s.functionUrl,model:s.model,systemMessages:s.systemMessages,assistantMessages:s.assistantMessages,userMessages:s.userMessages,maxTokens:s.maxTokens,expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,debounceTime:s.debounceTime,instanceId:o,triggerType:s.triggerType,triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,ignoreJids:s.ignoreJids}})}catch(c){throw this.logger.error(c),new Error("Error updating openai bot")}}async deleteBot(e,t){if(!this.integrationEnabled)throw new m("Openai is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Openai bot not found");if(o.instanceId!==s)throw new Error("Openai bot not found");try{return await this.sessionRepository.deleteMany({where:{botId:t}}),await this.botRepository.delete({where:{id:t}}),{bot:{id:t}}}catch(n){throw this.logger.error(n),new Error("Error deleting openai bot")}}async settings(e,t){if(!this.integrationEnabled)throw new m("Openai is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(o){let r=await this.settingsRepository.update({where:{id:o.id},data:{openaiCredsId:t.openaiCredsId,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,speechToText:t.speechToText,openaiIdFallback:t.openaiIdFallback,ignoreJids:t.ignoreJids}});return{openaiCredsId:r.openaiCredsId,expire:r.expire,keywordFinish:r.keywordFinish,delayMessage:r.delayMessage,unknownMessage:r.unknownMessage,listeningFromMe:r.listeningFromMe,stopBotFromMe:r.stopBotFromMe,keepOpen:r.keepOpen,debounceTime:r.debounceTime,speechToText:r.speechToText,openaiIdFallback:r.openaiIdFallback,ignoreJids:r.ignoreJids}}let n=await this.settingsRepository.create({data:{openaiCredsId:t.openaiCredsId,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,openaiIdFallback:t.openaiIdFallback,ignoreJids:t.ignoreJids,speechToText:t.speechToText,instanceId:s}});return{openaiCredsId:n.openaiCredsId,expire:n.expire,keywordFinish:n.keywordFinish,delayMessage:n.delayMessage,unknownMessage:n.unknownMessage,listeningFromMe:n.listeningFromMe,stopBotFromMe:n.stopBotFromMe,keepOpen:n.keepOpen,debounceTime:n.debounceTime,openaiIdFallback:n.openaiIdFallback,ignoreJids:n.ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async fetchSettings(e){if(!this.integrationEnabled)throw new m("Openai is disabled");try{let t=(await this.prismaRepository.instance.findFirst({select:{id:!0},where:{name:e.instanceName}}))?.id,s=await this.settingsRepository.findFirst({where:{instanceId:t},include:{Fallback:!0}});return s?{openaiCredsId:s.openaiCredsId,expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,ignoreJids:s.ignoreJids,openaiIdFallback:s.openaiIdFallback,speechToText:s.speechToText,fallback:s.Fallback}:{openaiCredsId:null,expire:0,keywordFinish:"",delayMessage:0,unknownMessage:"",listeningFromMe:!1,stopBotFromMe:!1,keepOpen:!1,ignoreJids:[],openaiIdFallback:null,speechToText:!1,fallback:null}}catch(t){throw this.logger.error(t),new Error("Error fetching default settings")}}async changeStatus(e,t){if(!this.integrationEnabled)throw new m("Openai is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}}),n=t.remoteJid,r=t.status;if(r==="delete")return await this.sessionRepository.deleteMany({where:{remoteJid:n,botId:{not:null}}}),{openai:{remoteJid:n,status:r}};if(r==="closed")return o?.keepOpen?await this.sessionRepository.updateMany({where:{remoteJid:n,botId:{not:null},status:{not:"closed"}},data:{status:"closed"}}):await this.sessionRepository.deleteMany({where:{remoteJid:n}}),{openai:{...e,openai:{remoteJid:n,status:r}}};{let a=await this.sessionRepository.updateMany({where:{instanceId:s,remoteJid:n,botId:{not:null}},data:{status:r}});return{openai:{...e,openai:{remoteJid:n,status:r,session:a}}}}}catch(s){throw this.logger.error(s),new Error("Error changing status")}}async fetchSessions(e,t,s){if(!this.integrationEnabled)throw new m("Openai is disabled");try{let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),n=await this.botRepository.findFirst({where:{id:t}});if(n&&n.instanceId!==o)throw new Error("Openai Bot not found");return await this.sessionRepository.findMany({where:{instanceId:o,remoteJid:s,botId:n?t:{not:null},type:"openai"}})}catch(o){throw this.logger.error(o),new Error("Error fetching sessions")}}async ignoreJid(e,t){if(!this.integrationEnabled)throw new m("Openai is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(!o)throw new Error("Settings not found");let n=o?.ignoreJids||[];if(t.action==="add"){if(n.includes(t.remoteJid))return{ignoreJids:n};n.push(t.remoteJid)}else n=n.filter(a=>a!==t.remoteJid);return{ignoreJids:(await this.settingsRepository.update({where:{id:o.id},data:{ignoreJids:n}})).ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async emit({instance:e,remoteJid:t,msg:s,pushName:o}){if(this.integrationEnabled)try{let n=await this.settingsRepository.findFirst({where:{instanceId:e.instanceId}});if(this.checkIgnoreJids(n?.ignoreJids,t))return;let r=await this.getSession(t,e),a=re(s),c=await this.findBotTrigger(this.botRepository,this.settingsRepository,a,e,r);if(!c)return;let u=c?.expire,d=c?.keywordFinish,l=c?.delayMessage,g=c?.unknownMessage,h=c?.listeningFromMe,y=c?.stopBotFromMe,f=c?.keepOpen,w=c?.debounceTime,I=c?.ignoreJids;u||(u=n.expire),d||(d=n.keywordFinish),l||(l=n.delayMessage),g||(g=n.unknownMessage),h||(h=n.listeningFromMe),y||(y=n.stopBotFromMe),f||(f=n.keepOpen),w||(w=n.debounceTime),I||(I=n.ignoreJids);let b=s.key;if(y&&b.fromMe&&r&&(r=await this.sessionRepository.update({where:{id:r.id},data:{status:"paused"}})),!h&&b.fromMe||r&&!r.awaitUser)return;w&&w>0?this.processDebounce(this.userMessageDebounce,a,t,w,async S=>{c.botType==="assistant"&&await this.openaiService.processOpenaiAssistant(this.waMonitor.waInstances[e.instanceName],t,o,b.fromMe,c,r,{...n,expire:u,keywordFinish:d,delayMessage:l,unknownMessage:g,listeningFromMe:h,stopBotFromMe:y,keepOpen:f,debounceTime:w,ignoreJids:I},S),c.botType==="chatCompletion"&&await this.openaiService.processOpenaiChatCompletion(this.waMonitor.waInstances[e.instanceName],t,o,c,r,{...n,expire:u,keywordFinish:d,delayMessage:l,unknownMessage:g,listeningFromMe:h,stopBotFromMe:y,keepOpen:f,debounceTime:w,ignoreJids:I},S)}):(c.botType==="assistant"&&await this.openaiService.processOpenaiAssistant(this.waMonitor.waInstances[e.instanceName],t,o,b.fromMe,c,r,n,a),c.botType==="chatCompletion"&&await this.openaiService.processOpenaiChatCompletion(this.waMonitor.waInstances[e.instanceName],t,o,c,r,n,a));return}catch(n){this.logger.error(n);return}}};var nc=v(require("axios"));var Vi=class extends Y{constructor(e,t,s){super(t,s);this.typebotService=e;this.logger=new E("TypebotController");this.integrationEnabled=M.get("TYPEBOT").ENABLED;this.userMessageDebounce={};this.botRepository=this.prismaRepository.typebot,this.settingsRepository=this.prismaRepository.typebotSetting,this.sessionRepository=this.prismaRepository.integrationSession}async createBot(e,t){if(!this.integrationEnabled)throw new m("Typebot is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id);if(!t.expire||!t.keywordFinish||!t.delayMessage||!t.unknownMessage||!t.listeningFromMe||!t.stopBotFromMe||!t.keepOpen||!t.debounceTime||!t.ignoreJids){let r=await this.settingsRepository.findFirst({where:{instanceId:s}});t.expire||(t.expire=r?.expire||0),t.keywordFinish||(t.keywordFinish=r?.keywordFinish||"#SAIR"),t.delayMessage||(t.delayMessage=r?.delayMessage||1e3),t.unknownMessage||(t.unknownMessage=r?.unknownMessage||"Desculpe, n\xE3o entendi"),t.listeningFromMe||(t.listeningFromMe=r?.listeningFromMe||!1),t.stopBotFromMe||(t.stopBotFromMe=r?.stopBotFromMe||!1),t.keepOpen||(t.keepOpen=r?.keepOpen||!1),t.debounceTime||(t.debounceTime=r?.debounceTime||0),t.ignoreJids||(t.ignoreJids=r?.ignoreJids||[]),r||await this.settings(e,{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,ignoreJids:t.ignoreJids})}if(await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",instanceId:s}})&&t.triggerType==="all")throw new Error('You already have a typebot with an "All" trigger, you cannot have more bots while it is active');if(await this.botRepository.findFirst({where:{url:t.url,typebot:t.typebot,instanceId:s}}))throw new Error("Typebot already exists");if(t.triggerType==="keyword"){if(!t.triggerOperator||!t.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}if(t.triggerType==="advanced"){if(!t.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:t.triggerValue,instanceId:s}}))throw new Error("Trigger already exists")}try{return await this.botRepository.create({data:{enabled:t?.enabled,description:t.description,url:t.url,typebot:t.typebot,expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,instanceId:s,triggerType:t.triggerType,triggerOperator:t.triggerOperator,triggerValue:t.triggerValue,ignoreJids:t.ignoreJids}})}catch(r){throw this.logger.error(r),new Error("Error creating typebot")}}async findBot(e){if(!this.integrationEnabled)throw new m("Typebot is disabled");let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.botRepository.findMany({where:{instanceId:t}});return s.length?s:null}async fetchBot(e,t){if(!this.integrationEnabled)throw new m("Typebot is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Typebot not found");if(o.instanceId!==s)throw new Error("Typebot not found");return o}async updateBot(e,t,s){if(!this.integrationEnabled)throw new m("Typebot is disabled");let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),n=await this.botRepository.findFirst({where:{id:t}});if(!n)throw new Error("Typebot not found");if(n.instanceId!==o)throw new Error("Typebot not found");if(s.triggerType==="all"&&await this.botRepository.findFirst({where:{enabled:!0,triggerType:"all",id:{not:t},instanceId:o}}))throw new Error('You already have a typebot with an "All" trigger, you cannot have more bots while it is active');if(await this.botRepository.findFirst({where:{url:s.url,typebot:s.typebot,id:{not:t},instanceId:o}}))throw new Error("Typebot already exists");if(s.triggerType==="keyword"){if(!s.triggerOperator||!s.triggerValue)throw new Error("Trigger operator and value are required");if(await this.botRepository.findFirst({where:{triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}if(s.triggerType==="advanced"){if(!s.triggerValue)throw new Error("Trigger value is required");if(await this.botRepository.findFirst({where:{triggerValue:s.triggerValue,id:{not:t},instanceId:o}}))throw new Error("Trigger already exists")}try{return await this.botRepository.update({where:{id:t},data:{enabled:s?.enabled,description:s.description,url:s.url,typebot:s.typebot,expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,debounceTime:s.debounceTime,triggerType:s.triggerType,triggerOperator:s.triggerOperator,triggerValue:s.triggerValue,ignoreJids:s.ignoreJids}})}catch(a){throw this.logger.error(a),new Error("Error updating typebot")}}async deleteBot(e,t){if(!this.integrationEnabled)throw new m("Typebot is disabled");let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(n=>n.id),o=await this.botRepository.findFirst({where:{id:t}});if(!o)throw new Error("Typebot not found");if(o.instanceId!==s)throw new Error("Typebot not found");try{return await this.prismaRepository.integrationSession.deleteMany({where:{botId:t}}),await this.botRepository.delete({where:{id:t}}),{typebot:{id:t}}}catch(n){throw this.logger.error(n),new Error("Error deleting typebot")}}async settings(e,t){if(!this.integrationEnabled)throw new m("Typebot is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(o){let r=await this.settingsRepository.update({where:{id:o.id},data:{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,typebotIdFallback:t.typebotIdFallback,ignoreJids:t.ignoreJids}});return{expire:r.expire,keywordFinish:r.keywordFinish,delayMessage:r.delayMessage,unknownMessage:r.unknownMessage,listeningFromMe:r.listeningFromMe,stopBotFromMe:r.stopBotFromMe,keepOpen:r.keepOpen,debounceTime:r.debounceTime,typebotIdFallback:r.typebotIdFallback,ignoreJids:r.ignoreJids}}let n=await this.settingsRepository.create({data:{expire:t.expire,keywordFinish:t.keywordFinish,delayMessage:t.delayMessage,unknownMessage:t.unknownMessage,listeningFromMe:t.listeningFromMe,stopBotFromMe:t.stopBotFromMe,keepOpen:t.keepOpen,debounceTime:t.debounceTime,typebotIdFallback:t.typebotIdFallback,ignoreJids:t.ignoreJids,instanceId:s}});return{expire:n.expire,keywordFinish:n.keywordFinish,delayMessage:n.delayMessage,unknownMessage:n.unknownMessage,listeningFromMe:n.listeningFromMe,stopBotFromMe:n.stopBotFromMe,keepOpen:n.keepOpen,debounceTime:n.debounceTime,typebotIdFallback:n.typebotIdFallback,ignoreJids:n.ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async fetchSettings(e){if(!this.integrationEnabled)throw new m("Typebot is disabled");try{let t=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(o=>o.id),s=await this.settingsRepository.findFirst({where:{instanceId:t},include:{Fallback:!0}});return s?{expire:s.expire,keywordFinish:s.keywordFinish,delayMessage:s.delayMessage,unknownMessage:s.unknownMessage,listeningFromMe:s.listeningFromMe,stopBotFromMe:s.stopBotFromMe,keepOpen:s.keepOpen,ignoreJids:s.ignoreJids,typebotIdFallback:s.typebotIdFallback,fallback:s.Fallback}:{expire:0,keywordFinish:"",delayMessage:0,unknownMessage:"",listeningFromMe:!1,stopBotFromMe:!1,keepOpen:!1,ignoreJids:[],typebotIdFallback:null,fallback:null}}catch(t){throw this.logger.error(t),new Error("Error fetching default settings")}}async startBot(e,t){if(!this.integrationEnabled)throw new m("Typebot is disabled");if(t.remoteJid==="status@broadcast")return;let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}});if(!s)throw new Error("Instance not found");let o=t.remoteJid,n=t.url,r=t.typebot,a=t.startSession,c=t.variables,u=t?.typebot?.expire,d=t?.typebot?.keywordFinish,l=t?.typebot?.delayMessage,g=t?.typebot?.unknownMessage,h=t?.typebot?.listeningFromMe,y=t?.typebot?.stopBotFromMe,f=t?.typebot?.keepOpen,w=await this.settingsRepository.findFirst({where:{instanceId:s.id}});if(this.checkIgnoreJids(w?.ignoreJids,o))throw new Error("Jid not allowed");(!u||!d||!l||!g||!h||!y||!f)&&(u||(u=w?.expire||0),d||(d=w?.keywordFinish||"#SAIR"),l||(l=w?.delayMessage||1e3),g||(g=w?.unknownMessage||"Desculpe, n\xE3o entendi"),h||(h=w?.listeningFromMe||!1),y||(y=w?.stopBotFromMe||!1),f||(f=w?.keepOpen||!1),w||await this.settings(e,{expire:u,keywordFinish:d,delayMessage:l,unknownMessage:g,listeningFromMe:h,stopBotFromMe:y,keepOpen:f}));let I={remoteJid:o,instanceName:e.instanceName,serverUrl:M.get("SERVER").URL,apiKey:M.get("AUTHENTICATION").API_KEY.KEY,ownerJid:s.number};if(c?.length&&c.forEach(b=>{I[b.name]=b.value}),a){let b=await this.botRepository.findFirst({where:{url:n,typebot:r,instanceId:s.id}});b||(b=await this.botRepository.upsert({where:{url_typebot_instanceId:{url:n,typebot:r,instanceId:s.id}},update:{enabled:!0},create:{enabled:!0,url:n,typebot:r,expire:u,triggerType:"none",keywordFinish:d,delayMessage:l,unknownMessage:g,listeningFromMe:h,stopBotFromMe:y,keepOpen:f,instanceId:s.id}})),await this.prismaRepository.integrationSession.deleteMany({where:{remoteJid:o,instanceId:s.id,botId:{not:null}}});let S=await this.typebotService.createNewSession(s,{enabled:!0,url:n,typebot:r,remoteJid:o,expire:u,keywordFinish:d,delayMessage:l,unknownMessage:g,listeningFromMe:h,stopBotFromMe:y,keepOpen:f,prefilledVariables:I,typebotId:b.id});if(S.sessionId)await this.typebotService.sendWAMessage(s,S.session,{expire:u,keywordFinish:d,delayMessage:l,unknownMessage:g,listeningFromMe:h,stopBotFromMe:y,keepOpen:f},o,S.messages,S.input,S.clientSideActions),this.waMonitor.waInstances[e.instanceName].sendDataWebhook("typebot.start",{remoteJid:o,url:n,typebot:r,prefilledVariables:I,sessionId:`${S.sessionId}`});else throw new Error("Session ID not found in response")}else{let b=Math.floor(Math.random()*1e10).toString();try{let S=M.get("TYPEBOT").API_VERSION,C,P;S==="latest"?(C=`${t.url}/api/v1/typebots/${t.typebot}/startChat`,P={prefilledVariables:I}):(C=`${t.url}/api/v1/sendMessage`,P={startParams:{publicId:t.typebot,prefilledVariables:I}});let L=await nc.default.post(C,P);await this.typebotService.sendWAMessage(s,null,{expire:u,keywordFinish:d,delayMessage:l,unknownMessage:g,listeningFromMe:h,stopBotFromMe:y,keepOpen:f},o,L.data.messages,L.data.input,L.data.clientSideActions),this.waMonitor.waInstances[e.instanceName].sendDataWebhook("typebot.start",{remoteJid:o,url:C,typebot:r,variables:c,sessionId:b})}catch(S){this.logger.error(S);return}}return{typebot:{...e,typebot:{url:n,remoteJid:o,typebot:r,prefilledVariables:I}}}}async changeStatus(e,t){if(!this.integrationEnabled)throw new m("Typebot is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(u=>u.id),o=t.remoteJid,n=t.status,r=await this.settingsRepository.findFirst({where:{instanceId:s}});if(n==="delete")return await this.sessionRepository.deleteMany({where:{remoteJid:o,instanceId:s,botId:{not:null}}}),{typebot:{...e,typebot:{remoteJid:o,status:n}}};if(n==="closed")return r?.keepOpen?await this.sessionRepository.updateMany({where:{instanceId:s,remoteJid:o,botId:{not:null}},data:{status:n}}):await this.sessionRepository.deleteMany({where:{remoteJid:o,instanceId:s,botId:{not:null}}}),{typebot:{...e,typebot:{remoteJid:o,status:n}}};let a=await this.sessionRepository.updateMany({where:{instanceId:s,remoteJid:o,botId:{not:null}},data:{status:n}}),c={remoteJid:o,status:n,session:a};return this.waMonitor.waInstances[e.instanceName].sendDataWebhook("typebot.change-status",c),{typebot:{...e,typebot:c}}}catch(s){throw this.logger.error(s),new Error("Error changing status")}}async fetchSessions(e,t,s){if(!this.integrationEnabled)throw new m("Typebot is disabled");try{let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(r=>r.id),n=await this.botRepository.findFirst({where:{id:t}});if(n&&n.instanceId!==o)throw new Error("Typebot not found");return await this.sessionRepository.findMany({where:{instanceId:o,remoteJid:s,botId:t??{not:null},type:"typebot"}})}catch(o){throw this.logger.error(o),new Error("Error fetching sessions")}}async ignoreJid(e,t){if(!this.integrationEnabled)throw new m("Typebot is disabled");try{let s=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}}).then(a=>a.id),o=await this.settingsRepository.findFirst({where:{instanceId:s}});if(!o)throw new Error("Settings not found");let n=o?.ignoreJids||[];if(t.action==="add"){if(n.includes(t.remoteJid))return{ignoreJids:n};n.push(t.remoteJid)}else n=n.filter(a=>a!==t.remoteJid);return{ignoreJids:(await this.settingsRepository.update({where:{id:o.id},data:{ignoreJids:n}})).ignoreJids}}catch(s){throw this.logger.error(s),new Error("Error setting default settings")}}async emit({instance:e,remoteJid:t,msg:s}){if(this.integrationEnabled)try{let o=await this.prismaRepository.instance.findFirst({where:{name:e.instanceName}});if(!o)throw new Error("Instance not found");let n=await this.getSession(t,e),r=re(s),a=await this.findBotTrigger(this.botRepository,this.settingsRepository,r,e,n);if(!a)return;let c=await this.prismaRepository.typebotSetting.findFirst({where:{instanceId:e.instanceId}}),u=a?.url,d=a?.typebot,l=a?.expire,g=a?.keywordFinish,h=a?.delayMessage,y=a?.unknownMessage,f=a?.listeningFromMe,w=a?.stopBotFromMe,I=a?.keepOpen,b=a?.debounceTime,S=a?.ignoreJids;if(l||(l=c.expire),g||(g=c.keywordFinish),h||(h=c.delayMessage),y||(y=c.unknownMessage),f||(f=c.listeningFromMe),w||(w=c.stopBotFromMe),I||(I=c.keepOpen),b||(b=c.debounceTime),S||(S=c.ignoreJids),this.checkIgnoreJids(S,t))return;let C=s.key;if(w&&C.fromMe&&n){await this.sessionRepository.update({where:{id:n.id},data:{status:"paused"}});return}if(!f&&C.fromMe||n&&!n.awaitUser||(b&&b>0?this.processDebounce(this.userMessageDebounce,r,t,b,async P=>{await this.typebotService.processTypebot(o,t,s,n,a,u,l,d,g,h,y,f,w,I,P)}):await this.typebotService.processTypebot(o,t,s,n,a,u,l,d,g,h,y,f,w,I,r),n&&!n.awaitUser))return}catch(o){this.logger.error(o);return}}};var oc=v(require("amqplib/callback_api"));var Gi=class extends j{constructor(e,t){super(e,t,M.get("RABBITMQ")?.ENABLED,"rabbitmq");this.amqpChannel=null;this.logger=new E("RabbitmqController")}async init(){this.status&&await new Promise((e,t)=>{let s=M.get("RABBITMQ").URI,o=M.get("RABBITMQ").EXCHANGE_NAME;oc.connect(s,(n,r)=>{if(n){t(n);return}r.createChannel((a,c)=>{if(a){t(a);return}let u=o;c.assertExchange(u,"topic",{durable:!0,autoDelete:!1}),this.amqpChannel=c,this.logger.info("AMQP initialized"),e()})})}).then(()=>{M.get("RABBITMQ")?.GLOBAL_ENABLED&&this.initGlobalQueues()})}set channel(e){this.amqpChannel=e}get channel(){return this.amqpChannel}async emit({instanceName:e,origin:t,event:s,data:o,serverUrl:n,dateTime:r,sender:a,apiKey:c}){if(!this.status)return;let u=await this.get(e),d=u?.events,l=M.get("RABBITMQ").GLOBAL_ENABLED,g=M.get("RABBITMQ").EVENTS,h=M.get("RABBITMQ").EXCHANGE_NAME,y=s.replace(/[.-]/gm,"_").toUpperCase(),f=M.get("LOG").LEVEL.includes("WEBHOOKS"),w={event:s,instance:e,data:o,server_url:n,date_time:r,sender:a,apikey:c};if(u?.enabled&&this.amqpChannel&&Array.isArray(d)&&d.includes(y)){let I=e??h,b=0;for(;b<3;)try{await this.amqpChannel.assertExchange(I,"topic",{durable:!0,autoDelete:!1});let S=s.replace(/_/g,".").toLowerCase(),C=`${e}.${S}`;if(await this.amqpChannel.assertQueue(C,{durable:!0,autoDelete:!1,arguments:{"x-queue-type":"quorum"}}),await this.amqpChannel.bindQueue(C,I,S),await this.amqpChannel.publish(I,s,Buffer.from(JSON.stringify(w))),f){let P={local:`${t}.sendData-RabbitMQ`,...w};this.logger.log(P)}break}catch{b++}}if(l&&g[y]&&this.amqpChannel){let I=h,b=0;for(;b<3;)try{await this.amqpChannel.assertExchange(I,"topic",{durable:!0,autoDelete:!1});let S=s;if(await this.amqpChannel.assertQueue(S,{durable:!0,autoDelete:!1,arguments:{"x-queue-type":"quorum"}}),await this.amqpChannel.bindQueue(S,I,s),await this.amqpChannel.publish(I,s,Buffer.from(JSON.stringify(w))),f){let C={local:`${t}.sendData-RabbitMQ-Global`,...w};this.logger.log(C)}break}catch{b++}}}async initGlobalQueues(){this.logger.info("Initializing global queues");let e=M.get("RABBITMQ").EXCHANGE_NAME,t=M.get("RABBITMQ").EVENTS;if(!t){this.logger.warn("No events to initialize on AMQP");return}Object.keys(t).forEach(o=>{if(t[o]===!1)return;let n=`${o.replace(/_/g,".").toLowerCase()}`,r=e;this.amqpChannel.assertExchange(r,"topic",{durable:!0,autoDelete:!1}),this.amqpChannel.assertQueue(n,{durable:!0,autoDelete:!1,arguments:{"x-queue-type":"quorum"}}),this.amqpChannel.bindQueue(n,r,o)})}};var rc=require("@aws-sdk/client-sqs");var Hi=class extends j{constructor(e,t){super(e,t,M.get("SQS")?.ENABLED,"sqs");this.logger=new E("SqsController")}init(){this.status&&new Promise(e=>{let t=M.get("SQS");this.sqs=new rc.SQS({credentials:{accessKeyId:t.ACCESS_KEY_ID,secretAccessKey:t.SECRET_ACCESS_KEY},region:t.REGION}),this.logger.info("SQS initialized"),e()})}set channel(e){this.sqs=e}get channel(){return this.sqs}async emit({instanceName:e,origin:t,event:s,data:o,serverUrl:n,dateTime:r,sender:a,apiKey:c}){if(!this.status)return;let u=await this.get(e),d=u?.events,l=s.replace(/[.-]/gm,"_").toUpperCase();if(u?.enabled&&this.sqs&&Array.isArray(d)&&d.includes(l)){let g=`${s.replace(".","_").toLowerCase()}`,h=`${e}_${g}.fifo`,y=M.get("SQS"),f=`https://sqs.${y.REGION}.amazonaws.com/${y.ACCOUNT_ID}/${h}`,w={event:s,instance:e,data:o,server_url:n,date_time:r,sender:a,apikey:c},I={MessageBody:JSON.stringify(w),MessageGroupId:"evolution",MessageDeduplicationId:`${e}_${g}_${Date.now()}`,QueueUrl:f};this.sqs.sendMessage(I,b=>{if(b)this.logger.error({local:`${t}.sendData-SQS`,message:b?.message,hostName:b?.hostname,code:b?.code,stack:b?.stack,name:b?.name,url:h,server_url:n});else if(M.get("LOG").LEVEL.includes("WEBHOOKS")){let S={local:`${t}.sendData-SQS`,...w};this.logger.log(S)}})}}async initQueues(e,t){if(!t||!t.length)return;t.map(o=>`${o.replace(/_/g,"_").toLowerCase()}`).forEach(o=>{let n=`${e}_${o}.fifo`;this.sqs.createQueue({QueueName:n,Attributes:{FifoQueue:"true"}},(r,a)=>{r?this.logger.error(`Error creating queue ${n}: ${r.message}`):this.logger.info(`Queue ${n} created: ${a.QueueUrl}`)})})}async removeQueues(e,t){let s=Array.isArray(t)?t.map(n=>String(n)):[];if(!t||!s.length)return;s.map(n=>`${n.replace(/_/g,"_").toLowerCase()}`).forEach(n=>{let r=`${e}_${n}.fifo`;this.sqs.getQueueUrl({QueueName:r},(a,c)=>{if(a)this.logger.error(`Error getting queue URL for ${r}: ${a.message}`);else{let u=c.QueueUrl;this.sqs.deleteQueue({QueueUrl:u},d=>{d?this.logger.error(`Error deleting queue ${r}: ${d.message}`):this.logger.info(`Queue ${r} deleted`)})}})})}};var Yn=v(require("axios")),ji=require("class-validator");var Ki=class extends j{constructor(e,t){super(e,t,!0,"webhook");this.logger=new E("WebhookController")}async set(e,t){if(!(0,ji.isURL)(t.webhook.url,{require_tld:!1}))throw new m('Invalid "url" property');return t.webhook?.enabled?t.webhook.events.length===0&&(t.webhook.events=j.events):t.webhook.events=[],this.prisma.webhook.upsert({where:{instanceId:this.monitor.waInstances[e].instanceId},update:{enabled:t.webhook?.enabled,events:t.webhook?.events,url:t.webhook?.url,headers:t.webhook?.headers,webhookBase64:t.webhook.base64,webhookByEvents:t.webhook.byEvents},create:{enabled:t.webhook?.enabled,events:t.webhook?.events,instanceId:this.monitor.waInstances[e].instanceId,url:t.webhook?.url,headers:t.webhook?.headers,webhookBase64:t.webhook.base64,webhookByEvents:t.webhook.byEvents}})}async emit({instanceName:e,origin:t,event:s,data:o,serverUrl:n,dateTime:r,sender:a,apiKey:c,local:u}){let d=await this.get(e);if(!d||!d?.enabled)return;let l=M.get("WEBHOOK"),g=d?.events,h=d?.headers,y=s.replace(/[.-]/gm,"_").toUpperCase(),f=y.replace(/_/gm,"-").toLowerCase(),w=M.get("LOG").LEVEL.includes("WEBHOOKS"),I={event:s,instance:e,data:o,destination:d?.url,date_time:r,sender:a,server_url:n,apikey:c};if(u&&Array.isArray(g)&&g.includes(y)){let b;if(d?.webhookByEvents?b=`${d?.url}/${f}`:b=d?.url,w){let S={local:`${t}.sendData-Webhook`,url:b,...I};this.logger.log(S)}try{d?.enabled&&(0,ji.isURL)(d.url,{require_tld:!1})&&await Yn.default.create({baseURL:b,headers:h}).post("",I)}catch(S){this.logger.error({local:`${t}.sendData-Webhook`,message:S?.message,hostName:S?.hostname,syscall:S?.syscall,code:S?.code,error:S?.errno,stack:S?.stack,name:S?.name,url:b,server_url:n})}}if(l.GLOBAL?.ENABLED&&l.EVENTS[y]){let b=l.GLOBAL.URL;if(l.GLOBAL.WEBHOOK_BY_EVENTS&&(b=`${b}/${f}`),w){let S={local:`${t}.sendData-Webhook-Global`,url:b,...I};this.logger.log(S)}try{(0,ji.isURL)(b)&&await Yn.default.create({baseURL:b}).post("",I)}catch(S){this.logger.error({local:`${t}.sendData-Webhook-Global`,message:S?.message,hostName:S?.hostname,syscall:S?.syscall,code:S?.code,error:S?.errno,stack:S?.stack,name:S?.name,url:b,server_url:n})}}}};var ac=require("socket.io");var Yi=class extends j{constructor(e,t){super(e,t,M.get("WEBSOCKET")?.ENABLED,"websocket");this.logger=new E("WebsocketController");this.cors=M.get("CORS").ORIGIN}init(e){this.status&&(this.socket=new ac.Server(e,{cors:{origin:this.cors}}),this.socket.on("connection",t=>{this.logger.info("User connected"),t.on("disconnect",()=>{this.logger.info("User disconnected")})}),this.logger.info("Socket.io initialized"))}set cors(e){this.corsConfig=e}get cors(){return this.corsConfig?.includes("*")?"*":this.corsConfig}set socket(e){this.io=e}get socket(){return this.io}async emit({instanceName:e,origin:t,event:s,data:o,serverUrl:n,dateTime:r,sender:a,apiKey:c}){if(!this.status)return;let u=s.replace(/[.-]/gm,"_").toUpperCase(),d=M.get("LOG").LEVEL.includes("WEBSOCKET"),l={event:s,instance:e,data:o,server_url:n,date_time:r,sender:a,apikey:c};M.get("WEBSOCKET")?.GLOBAL_EVENTS&&(this.socket.emit(s,l),d&&this.logger.log({local:`${t}.sendData-WebsocketGlobal`,...l}));try{let g=await this.get(e);if(!g?.enabled)return;Array.isArray(g?.events)&&g?.events.includes(u)&&(this.socket.of(`/${e}`).emit(s,l),d&&this.logger.log({local:`${t}.sendData-Websocket`,...l}))}catch(g){d&&this.logger.log(g)}}};var Qi=class{constructor(i,e){this.prisma=i,this.monitor=e,this.websocket=new Yi(i,e),this.webhook=new Ki(i,e),this.rabbitmq=new Gi(i,e),this.sqs=new Hi(i,e)}set prisma(i){this.prismaRepository=i}get prisma(){return this.prismaRepository}set monitor(i){this.waMonitor=i}get monitor(){return this.waMonitor}set websocket(i){this.websocketController=i}get websocket(){return this.websocketController}set webhook(i){this.webhookController=i}get webhook(){return this.webhookController}set rabbitmq(i){this.rabbitmqController=i}get rabbitmq(){return this.rabbitmqController}set sqs(i){this.sqsController=i}get sqs(){return this.sqsController}init(i){this.websocket.init(i),this.rabbitmq.init(),this.sqs.init()}async emit(i){await this.websocket.emit(i),await this.rabbitmq.emit(i),await this.sqs.emit(i),await this.webhook.emit(i)}async setInstance(i,e){e.websocket&&await this.websocket.set(i,{websocket:{enabled:!0,events:e.websocket?.events}}),e.rabbitmq&&await this.rabbitmq.set(i,{rabbitmq:{enabled:!0,events:e.rabbitmq?.events}}),e.sqs&&await this.sqs.set(i,{sqs:{enabled:!0,events:e.sqs?.events}}),e.webhook&&await this.webhook.set(i,{webhook:{enabled:!0,events:e.webhook?.events,url:e.webhook?.url,headers:e.webhook?.headers,base64:e.webhook?.base64,byEvents:e.webhook?.byEvents}})}};var zi=class{constructor(i){this.s3Service=i}async getMedia(i,e){return this.s3Service.getMedia(i,e)}async getMediaUrl(i,e){return this.s3Service.getMediaUrl(i,e)}};var Xi=class{constructor(i){this.prismaRepository=i;this.logger=new E("S3Service")}async getMedia(i,e){try{let t={instanceId:i.instanceId,...e},s=await this.prismaRepository.media.findMany({where:t,select:{id:!0,fileName:!0,type:!0,mimetype:!0,createdAt:!0,Message:!0}});if(!s||s.length===0)throw"Media not found";return s}catch(t){throw new m(t)}}async getMediaUrl(i,e){let t=(await this.getMedia(i,{id:e.id}))[0];return{mediaUrl:await Ue(t.fileName,e.expiry),...t}}};var Ie=v(require("axios")),cc=require("child_process"),Zi=class{constructor(i){this.configService=i;this.logger=new E("ProviderFiles");this.config=Object.freeze(this.configService.get("PROVIDER"));this.baseUrl=`http://${this.config.HOST}:${this.config.PORT}/session/${this.config.PREFIX}`,this.globalApiToken=this.configService.get("AUTHENTICATION").API_KEY.KEY}get isEnabled(){return!!this.config?.ENABLED}async onModuleInit(){if(this.config.ENABLED){let i=`http://${this.config.HOST}:${this.config.PORT}`;try{if((await Ie.default.options(i+"/ping"))?.data!="pong")throw new Error("Offline file provider.");await Ie.default.post(`${i}/session`,{group:this.config.PREFIX},{headers:{apikey:this.globalApiToken}})}catch(e){this.logger.error(["Failed to connect to the file server",e?.message,e?.stack]);let t=process.pid;(0,cc.execSync)(`kill -9 ${t}`)}}}async onModuleDestroy(){}async create(i){try{let e=await Ie.default.post(`${this.baseUrl}`,{instance:i},{headers:{apikey:this.globalApiToken}});return[{status:e.status,data:e?.data}]}catch(e){return[{status:e?.response?.status,data:e?.response?.data},e]}}async write(i,e,t){try{let s=await Ie.default.post(`${this.baseUrl}/${i}/${e}`,t,{headers:{apikey:this.globalApiToken}});return[{status:s.status,data:s?.data}]}catch(s){return[{status:s?.response?.status,data:s?.response?.data},s]}}async read(i,e){try{let t=await Ie.default.get(`${this.baseUrl}/${i}/${e}`,{headers:{apikey:this.globalApiToken}});return[{status:t.status,data:t?.data}]}catch(t){return[{status:t?.response?.status,data:t?.response?.data},t]}}async delete(i,e){try{let t=await Ie.default.delete(`${this.baseUrl}/${i}/${e}`,{headers:{apikey:this.globalApiToken}});return[{status:t.status,data:t?.data}]}catch(t){return[{status:t?.response?.status,data:t?.response?.data},t]}}async allInstances(){try{let i=await Ie.default.get(`${this.baseUrl}/list-instances`,{headers:{apikey:this.globalApiToken}});return[{status:i.status,data:i?.data}]}catch(i){return[{status:i?.response?.status,data:i?.response?.data},i]}}async removeSession(i){try{let e=await Ie.default.delete(`${this.baseUrl}/${i}`,{headers:{apikey:this.globalApiToken}});return[{status:e.status,data:e?.data}]}catch(e){return[{status:e?.response?.status,data:e?.response?.data},e]}}};var pc=require("child_process"),Qn=require("fs"),en=require("path"),tn=class{constructor(i,e,t,s,o,n,r){this.eventEmitter=i;this.configService=e;this.prismaRepository=t;this.providerFiles=s;this.cache=o;this.chatwootCache=n;this.baileysCache=r;this.db={};this.redis={};this.logger=new E("WAMonitoringService");this.waInstances={};this.providerSession=Object.freeze(this.configService.get("PROVIDER"));this.removeInstance(),this.noConnection(),Object.assign(this.db,e.get("DATABASE")),Object.assign(this.redis,e.get("CACHE"))}delInstanceTime(i){let e=this.configService.get("DEL_INSTANCE");typeof e=="number"&&e>0&&setTimeout(async()=>{this.waInstances[i]?.connectionStatus?.state!=="open"&&(this.waInstances[i]?.connectionStatus?.state==="connecting"?(await this.waInstances[i].integration===D.WHATSAPP_BAILEYS&&(await this.waInstances[i]?.client?.logout("Log out instance: "+i),this.waInstances[i]?.client?.ws?.close(),this.waInstances[i]?.client?.end(void 0)),this.eventEmitter.emit("remove.instance",i,"inner")):this.eventEmitter.emit("remove.instance",i,"inner"))},1e3*60*e)}async instanceInfo(i){if(i&&!this.waInstances[i])throw new _(`Instance "${i}" not found`);let e=this.configService.get("DATABASE").CONNECTION.CLIENT_NAME,t=i?{name:i,clientName:e}:{clientName:e};return await this.prismaRepository.instance.findMany({where:t,include:{Chatwoot:!0,Proxy:!0,Rabbitmq:!0,Sqs:!0,Websocket:!0,Setting:!0,_count:{select:{Message:!0,Contact:!0,Chat:!0}}}})}async instanceInfoById(i,e){let t;if(i){if(t=await this.prismaRepository.instance.findFirst({where:{id:i}}).then(s=>s?.name),!t)throw new _(`Instance "${i}" not found`)}else if(e&&(t=await this.prismaRepository.instance.findFirst({where:{number:e}}).then(s=>s?.name),!t))throw new _(`Instance "${e}" not found`);if(!t)throw new _(`Instance "${i}" not found`);if(t&&!this.waInstances[t])throw new _(`Instance "${t}" not found`);return this.instanceInfo(t)}async cleaningUp(i){let e;if(this.db.SAVE_DATA.INSTANCE&&await this.prismaRepository.instance.findFirst({where:{name:i}})){let s=await this.prismaRepository.instance.update({where:{name:i},data:{connectionStatus:"close"}});(0,Qn.rmSync)((0,en.join)(xt,s.id),{recursive:!0,force:!0}),e=s.id,await this.prismaRepository.session.deleteMany({where:{sessionId:s.id}})}this.redis.REDIS.ENABLED&&this.redis.REDIS.SAVE_INSTANCES&&(await this.cache.delete(i),e&&await this.cache.delete(e)),this.providerSession?.ENABLED&&await this.providerFiles.removeSession(i)}async cleaningStoreData(i){this.configService.get("CHATWOOT").ENABLED&&(0,pc.execSync)(`rm -rf ${(0,en.join)(La,"chatwoot",i+"*")}`);let e=await this.prismaRepository.instance.findFirst({where:{name:i}});e&&((0,Qn.rmSync)((0,en.join)(xt,e.id),{recursive:!0,force:!0}),await this.prismaRepository.session.deleteMany({where:{sessionId:e.id}}),await this.prismaRepository.chat.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.contact.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.messageUpdate.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.message.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.webhook.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.chatwoot.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.proxy.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.rabbitmq.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.sqs.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.integrationSession.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.typebot.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.websocket.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.setting.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.label.deleteMany({where:{instanceId:e.id}}),await this.prismaRepository.instance.delete({where:{name:i}}))}async loadInstance(){try{this.providerSession?.ENABLED?await this.loadInstancesFromProvider():this.db.SAVE_DATA.INSTANCE?await this.loadInstancesFromDatabasePostgres():this.redis.REDIS.ENABLED&&this.redis.REDIS.SAVE_INSTANCES&&await this.loadInstancesFromRedis()}catch(i){this.logger.error(i)}}async saveInstance(i){try{let e=await this.configService.get("DATABASE").CONNECTION.CLIENT_NAME;await this.prismaRepository.instance.create({data:{id:i.instanceId,name:i.instanceName,connectionStatus:i.integration&&i.integration===D.WHATSAPP_BAILEYS?"close":i.status??"open",number:i.number,integration:i.integration||D.WHATSAPP_BAILEYS,token:i.hash,clientName:e,businessId:i.businessId}})}catch(e){this.logger.error(e)}}deleteInstance(i){try{this.eventEmitter.emit("remove.instance",i,"inner")}catch(e){this.logger.error(e)}}async setInstance(i){let e=sn.init(i,{configService:this.configService,eventEmitter:this.eventEmitter,prismaRepository:this.prismaRepository,cache:this.cache,chatwootCache:this.chatwootCache,baileysCache:this.baileysCache,providerFiles:this.providerFiles});e&&(e.setInstance({instanceId:i.instanceId,instanceName:i.instanceName,integration:i.integration,token:i.token,number:i.number,businessId:i.businessId}),await e.connectToWhatsapp(),this.waInstances[i.instanceName]=e)}async loadInstancesFromRedis(){let i=await this.cache.keys();i?.length>0&&await Promise.all(i.map(async e=>{let t=await this.prismaRepository.instance.findUnique({where:{id:e.split(":")[1]}});if(!t)return;let s={instanceId:e.split(":")[1],instanceName:e.split(":")[2],integration:t.integration,token:t.token,number:t.number,businessId:t.businessId};this.setInstance(s)}))}async loadInstancesFromDatabasePostgres(){let i=await this.configService.get("DATABASE").CONNECTION.CLIENT_NAME,e=await this.prismaRepository.instance.findMany({where:{clientName:i}});e.length!==0&&await Promise.all(e.map(async t=>{this.setInstance({instanceId:t.id,instanceName:t.name,integration:t.integration,token:t.token,number:t.number,businessId:t.businessId})}))}async loadInstancesFromProvider(){let[i]=await this.providerFiles.allInstances();i?.data&&await Promise.all(i?.data?.map(async e=>{let t=await this.prismaRepository.instance.findUnique({where:{id:e}});this.setInstance({instanceId:t.id,instanceName:t.name,integration:t.integration,token:t.token,businessId:t.businessId})}))}removeInstance(){this.eventEmitter.on("remove.instance",async i=>{try{await this.waInstances[i]?.sendDataWebhook("remove.instance",null),this.cleaningUp(i),this.cleaningStoreData(i)}finally{this.logger.warn(`Instance "${i}" - REMOVED`)}try{delete this.waInstances[i]}catch(e){this.logger.error(e)}}),this.eventEmitter.on("logout.instance",async i=>{try{await this.waInstances[i]?.sendDataWebhook("logout.instance",null),this.configService.get("CHATWOOT").ENABLED&&this.waInstances[i]?.clearCacheChatwoot(),this.cleaningUp(i)}finally{this.logger.warn(`Instance "${i}" - LOGOUT`)}})}noConnection(){this.eventEmitter.on("no.connection",async i=>{try{await this.waInstances[i]?.client?.logout("Log out instance: "+i),this.waInstances[i]?.client?.ws?.close(),this.waInstances[i].instance.qrcode={count:0},this.waInstances[i].stateConnection.state="close"}catch(e){this.logger.error({localError:"noConnection",warn:"Error deleting instance from memory.",error:e})}finally{this.logger.warn(`Instance "${i}" - NOT CONNECTION`)}})}};var nn=class{constructor(i){this.waMonitor=i;this.logger=new E("ProxyService")}create(i,e){return this.waMonitor.waInstances[i.instanceName].setProxy(e),{proxy:{...i,proxy:e}}}async find(i){try{let e=await this.waMonitor.waInstances[i.instanceName].findProxy();if(Object.keys(e).length===0)throw new Error("Proxy not found");return e}catch{return null}}};var on=class{constructor(i){this.waMonitor=i;this.logger=new E("SettingsService")}async create(i,e){return await this.waMonitor.waInstances[i.instanceName].setSettings(e),{settings:{...i,settings:e}}}async find(i){try{let e=await this.waMonitor.waInstances[i.instanceName].findSettings();if(Object.keys(e).length===0)throw new Error("Settings not found");return e}catch{return null}}};var zn=v(require("axios")),rn=class{constructor(i,e,t){this.waMonitor=i;this.prismaRepository=e;this.configService=t;this.logger=new E("TemplateService")}async find(i){let e=await this.waMonitor.waInstances[i.instanceName].instance;if(!e)throw new Error("Instance not found");this.businessId=e.businessId,this.token=e.token;let t=await this.requestTemplate({},"GET");if(!t)throw new Error("Error to create template");return t.data}async create(i,e){try{let t=await this.waMonitor.waInstances[i.instanceName].instance;if(!t)throw new Error("Instance not found");this.businessId=t.businessId,this.token=t.token;let s={name:e.name,category:e.category,allow_category_change:e.allowCategoryChange,language:e.language,components:e.components},o=await this.requestTemplate(s,"POST");if(!o||o.error)throw new Error("Error to create template");return await this.prismaRepository.template.create({data:{templateId:o.id,name:e.name,template:o,webhookUrl:e.webhookUrl,instanceId:t.id}})}catch(t){throw this.logger.error(t),new Error("Error to create template")}}async requestTemplate(i,e){try{let t=this.configService.get("WA_BUSINESS").URL,s=this.configService.get("WA_BUSINESS").VERSION;t=`${t}/${s}/${this.businessId}/message_templates`;let o={"Content-Type":"application/json",Authorization:`Bearer ${this.token}`};if(e==="GET")return(await zn.default.get(t,{headers:o})).data;if(e==="POST")return(await zn.default.post(t,i,{headers:o})).data}catch(t){return this.logger.error(t.response.data),t.response.data.error}}};var jc=new E("WA MODULE"),an=null;M.get("CHATWOOT").ENABLED&&(an=new fe(new ge(M,ye.name).getEngine()));var $t=new fe(new ge(M,"instance").getEngine()),lc=new fe(new ge(M,"baileys").getEngine()),Xn=null;M.get("PROVIDER").ENABLED&&(Xn=new Zi(M));var F=new Ps(M),x=new tn(un,M,F,Xn,$t,an,lc),Kc=new Xi(F),In=new zi(Kc),Yc=new rn(x,F,M),vn=new Ii(Yc),Qc=new nn(x),ei=new bi(Qc,x),uc=new ye(x,M,F,an),es=new Fi(uc,M,F),dc=new on(x),Cn=new Ei(dc),be=new Pt(x,M,F,un,uc,dc,ei,$t,an,lc,Xn),te=new Si(x),J=new Ut(x),$=new Jt(x),Tn=new Wt(x),G=new Qi(F,x),Ee=new Y(F,x),sn=new Ne(F,x),To=new _i(F,x),vo=new Bi(F,x),zc=new it(x,M,F),K=new Vi(zc,F,x),Xc=new st(x,M,F),q=new $i(Xc,F,x),Zc=new tt(x,M,F),X=new Li(Zc,F,x),ep=new Ji(x,M,F),Z=new Ui(ep,F,x),tp=new qi(x,M,F),ee=new Wi(tp,F,x);jc.info("Module - ON");var Zn=require("baileys"),_t=require("class-validator"),eo=require("uuid"),Pt=class{constructor(i,e,t,s,o,n,r,a,c,u,d){this.waMonitor=i;this.configService=e;this.prismaRepository=t;this.eventEmitter=s;this.chatwootService=o;this.settingsService=n;this.proxyService=r;this.cache=a;this.chatwootCache=c;this.baileysCache=u;this.providerFiles=d;this.logger=new E("InstanceController")}async createInstance(i){try{let e=sn.init(i,{configService:this.configService,eventEmitter:this.eventEmitter,prismaRepository:this.prismaRepository,cache:this.cache,chatwootCache:this.chatwootCache,baileysCache:this.baileysCache,providerFiles:this.providerFiles});if(!e)throw new m("Invalid integration");let t=(0,eo.v4)();i.instanceId=t;let s;if(i.token?s=i.token:s=(0,eo.v4)().toUpperCase(),await this.waMonitor.saveInstance({instanceId:t,integration:i.integration,instanceName:i.instanceName,hash:s,number:i.number,businessId:i.businessId,status:i.status}),e.setInstance({instanceName:i.instanceName,instanceId:t,integration:i.integration,token:s,number:i.number,businessId:i.businessId}),this.waMonitor.waInstances[e.instanceName]=e,this.waMonitor.delInstanceTime(e.instanceName),await G.setInstance(e.instanceName,i),e.sendDataWebhook("instance.create",{instanceName:i.instanceName,instanceId:t}),i.proxyHost&&i.proxyPort&&i.proxyProtocol){if(!await this.proxyService.testProxy({host:i.proxyHost,port:i.proxyPort,protocol:i.proxyProtocol,username:i.proxyUsername,password:i.proxyPassword}))throw new m("Invalid proxy");await this.proxyService.createProxy(e,{enabled:!0,host:i.proxyHost,port:i.proxyPort,protocol:i.proxyProtocol,username:i.proxyUsername,password:i.proxyPassword})}let o={rejectCall:i.rejectCall===!0,msgCall:i.msgCall||"",groupsIgnore:i.groupsIgnore===!0,alwaysOnline:i.alwaysOnline===!0,readMessages:i.readMessages===!0,readStatus:i.readStatus===!0,syncFullHistory:i.syncFullHistory===!0};await this.settingsService.create(e,o);let n=null,r="";if(i.integration===D.WHATSAPP_BUSINESS){if(!i.number)throw new m("number is required");n=`${this.configService.get("SERVER").URL}/webhook/meta`,r=this.configService.get("WA_BUSINESS").TOKEN_WEBHOOK}if(!i.chatwootAccountId||!i.chatwootToken||!i.chatwootUrl){let c;return i.qrcode&&i.integration===D.WHATSAPP_BAILEYS&&(await e.connectToWhatsapp(i.number),await(0,Zn.delay)(5e3),c=e.qrCode),{instance:{instanceName:e.instanceName,instanceId:t,integration:i.integration,webhookWaBusiness:n,accessTokenWaBusiness:r,status:e.connectionStatus.state},hash:s,webhook:{webhookUrl:i?.webhook?.url,webhookHeaders:i?.webhook?.headers,webhookByEvents:i?.webhook?.byEvents,webhookBase64:i?.webhook?.base64},websocket:{enabled:i?.websocket?.enabled},rabbitmq:{enabled:i?.rabbitmq?.enabled},sqs:{enabled:i?.sqs?.enabled},settings:o,qrcode:c}}if(!this.configService.get("CHATWOOT").ENABLED)throw new m("Chatwoot is not enabled");if(!i.chatwootAccountId)throw new m("accountId is required");if(!i.chatwootToken)throw new m("token is required");if(!i.chatwootUrl)throw new m("url is required");if(!(0,_t.isURL)(i.chatwootUrl,{require_tld:!1}))throw new m('Invalid "url" property in chatwoot');if(i.chatwootSignMsg!==!0&&i.chatwootSignMsg!==!1)throw new m("signMsg is required");if(i.chatwootReopenConversation!==!0&&i.chatwootReopenConversation!==!1)throw new m("reopenConversation is required");if(i.chatwootConversationPending!==!0&&i.chatwootConversationPending!==!1)throw new m("conversationPending is required");let a=this.configService.get("SERVER").URL;try{this.chatwootService.create(e,{enabled:!0,accountId:i.chatwootAccountId,token:i.chatwootToken,url:i.chatwootUrl,signMsg:i.chatwootSignMsg||!1,nameInbox:i.chatwootNameInbox??e.instanceName.split("-cwId-")[0],number:i.number,reopenConversation:i.chatwootReopenConversation||!1,conversationPending:i.chatwootConversationPending||!1,importContacts:i.chatwootImportContacts??!0,mergeBrazilContacts:i.chatwootMergeBrazilContacts??!1,importMessages:i.chatwootImportMessages??!0,daysLimitImportMessages:i.chatwootDaysLimitImportMessages??60,organization:i.chatwootOrganization,logo:i.chatwootLogo,autoCreate:i.chatwootAutoCreate!==!1})}catch(c){this.logger.log(c)}return{instance:{instanceName:e.instanceName,instanceId:t,integration:i.integration,webhookWaBusiness:n,accessTokenWaBusiness:r,status:e.connectionStatus.state},hash:s,webhook:{webhookUrl:i?.webhook?.url,webhookHeaders:i?.webhook?.headers,webhookByEvents:i?.webhook?.byEvents,webhookBase64:i?.webhook?.base64},websocket:{enabled:i?.websocket?.enabled},rabbitmq:{enabled:i?.rabbitmq?.enabled},sqs:{enabled:i?.sqs?.enabled},settings:o,chatwoot:{enabled:!0,accountId:i.chatwootAccountId,token:i.chatwootToken,url:i.chatwootUrl,signMsg:i.chatwootSignMsg||!1,reopenConversation:i.chatwootReopenConversation||!1,conversationPending:i.chatwootConversationPending||!1,mergeBrazilContacts:i.chatwootMergeBrazilContacts??!1,importContacts:i.chatwootImportContacts??!0,importMessages:i.chatwootImportMessages??!0,daysLimitImportMessages:i.chatwootDaysLimitImportMessages||60,number:i.number,nameInbox:i.chatwootNameInbox??e.instanceName,webhookUrl:`${a}/chatwoot/webhook/${encodeURIComponent(e.instanceName)}`}}}catch(e){throw this.waMonitor.deleteInstance(i.instanceName),this.logger.error((0,_t.isArray)(e.message)?e.message[0]:e.message),new m((0,_t.isArray)(e.message)?e.message[0]:e.message)}}async connectToWhatsapp({instanceName:i,number:e=null}){try{let t=this.waMonitor.waInstances[i],s=t?.connectionStatus?.state;if(!s)throw new m('The "'+i+'" instance does not exist');return s=="open"?await this.connectionState({instanceName:i}):s=="connecting"?t.qrCode:s=="close"?(await t.connectToWhatsapp(e),await(0,Zn.delay)(2e3),t.qrCode):{instance:{instanceName:i,status:s},qrcode:t?.qrCode}}catch(t){return this.logger.error(t),{error:!0,message:t.toString()}}}async restartInstance({instanceName:i}){try{let e=this.waMonitor.waInstances[i],t=e?.connectionStatus?.state;if(!t)throw new m('The "'+i+'" instance does not exist');if(t=="close")throw new m('The "'+i+'" instance is not connected');if(t=="open")return this.configService.get("CHATWOOT").ENABLED&&e.clearCacheChatwoot(),this.logger.info("restarting instance"+i),e.client?.ws?.close(),e.client?.end(new Error("restart")),await this.connectToWhatsapp({instanceName:i});if(t=="connecting")return e.client?.ws?.close(),e.client?.end(new Error("restart")),await this.connectToWhatsapp({instanceName:i})}catch(e){return this.logger.error(e),{error:!0,message:e.toString()}}}async connectionState({instanceName:i}){return{instance:{instanceName:i,state:this.waMonitor.waInstances[i]?.connectionStatus?.state}}}async fetchInstances({instanceName:i,instanceId:e,number:t},s){let o=this.configService.get("AUTHENTICATION").API_KEY,n=i;if(o.KEY!==s){let r=await this.prismaRepository.instance.findMany({where:{token:s}});if(r)n=r[0].name;else throw new _e}return n?this.waMonitor.instanceInfo(n):e||t?this.waMonitor.instanceInfoById(e,t):this.waMonitor.instanceInfo()}async setPresence({instanceName:i},e){return await this.waMonitor.waInstances[i].setPresence(e)}async logout({instanceName:i}){let{instance:e}=await this.connectionState({instanceName:i});if(e.state==="close")throw new m('The "'+i+'" instance is not connected');try{return this.waMonitor.waInstances[i]?.logoutInstance(),{status:"SUCCESS",error:!1,response:{message:"Instance logged out"}}}catch(t){throw new N(t.toString())}}async deleteInstance({instanceName:i}){let{instance:e}=await this.connectionState({instanceName:i});if(e.state==="open")throw new m('The "'+i+'" instance needs to be disconnected');try{let t=this.waMonitor.waInstances[i];this.configService.get("CHATWOOT").ENABLED&&t?.clearCacheChatwoot(),e.state==="connecting"&&await this.logout({instanceName:i});try{t?.sendDataWebhook("instance.delete",{instanceName:i,instanceId:t.instanceId})}catch(s){this.logger.error(s)}return this.eventEmitter.emit("remove.instance",i,"inner"),{status:"SUCCESS",error:!1,response:{message:"Instance deleted"}}}catch(t){throw new m(t.toString())}}};0&&(module.exports={InstanceController});
/**
 * 
 *  @author jrCleber                                                             
 *  @filename use-multi-file-auth-state-provider-files.ts                              
 *  Developed by: Cleber Wilson                                                  
 *  Creation date: May 31, 2024                                                 
 *  Contact: contato@codechat.dev                                                
 * 
 *  @copyright  Cleber Wilson 2023. All rights reserved.                        
 *  Licensed under the Apache License, Version 2.0                               
 *                                                                               
 *   @license "https://github.com/code-chat-br/whatsapp-api/blob/main/LICENSE"   
 *                                                                               
 *  You may not use this file except in compliance with the License.             
 *  You may obtain a copy of the License at                                      
 *                                                                               
 *     http://www.apache.org/licenses/LICENSE-2.0                                
 *                                                                               
 *  Unless required by applicable law or agreed to in writing, software          
 *  distributed under the License is distributed on an "AS IS" BASIS,            
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.     
 *                                                                               
 *  See the License for the specific language governing permissions and          
 *  limitations under the License.                                               
 *                                                                               
 *  @type {AuthState}                                                            
 *  @function useMultiFileAuthStateRedisDb                                       
 *  @returns {Promise<AuthState>}                                                
 * 
 *  @important                                                                   
 *  For any future changes to the code in this file, it is recommended to        
 *  contain, together with the modification, the information of the developer    
 *  who changed it and the date of modification.                                 
 * 
 */
//# sourceMappingURL=instance.controller.js.map